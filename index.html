<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Turbo Tribe Racing League - Elite F1 25 Sim Racing Competition">
    <title>TTRL | Racing League</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        :root {
            --bg-main: #050505;
            --accent-red: #ff1f4b;
            --accent-cyan: #00f0ff;
            --text-primary: #ffffff;
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(20, 20, 20, 0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; /* Hide default cursor */ }
        
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            background-color: var(--bg-main);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            overflow: hidden; /* Enforce no scrolling on the main page */
            overscroll-behavior: none;
        }

        /* --- CUSTOM CURSOR --- */
        #cursor, #cursor-follower {
            position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999;
            transform: translate(-50%, -50%); border-radius: 50%;
            will-change: transform, left, top;
        }
        #cursor {
            width: 8px; height: 8px; background: var(--accent-cyan);
            transition: width 0.2s, height 0.2s, background 0.2s;
        }
        #cursor-follower {
            width: 40px; height: 40px; border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.1s ease-out, width 0.3s, height 0.3s, border-color 0.3s;
        }
        /* Hover State for Cursor */
        body.hovering #cursor { width: 0px; height: 0px; opacity: 0; }
        body.hovering #cursor-follower {
            width: 60px; height: 60px; border-color: var(--accent-red);
            background: rgba(255, 31, 75, 0.1); mix-blend-mode: screen;
        }

        @media (max-width: 768px) {
            * { cursor: auto !important; }
            #cursor, #cursor-follower { display: none !important; }
        }

        /* --- LOADING SCREEN --- */
        #loader {
            position: fixed; inset: 0; z-index: 10000; background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .loader-bar { width: 200px; height: 2px; background: #333; margin-top: 20px; position: relative; overflow: hidden; }
        .loader-progress {
            position: absolute; top: 0; left: 0; height: 100%; width: 0%;
            background: var(--accent-cyan); box-shadow: 0 0 10px var(--accent-cyan);
        }

        /* --- CINEMATICS --- */
        .cinematic-grain {
            position: fixed; inset: 0; pointer-events: none; z-index: 998;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.04; /* Restored Visual Quality */
            mix-blend-mode: screen;
        }

        /* --- UI COMPONENTS --- */
        .fixed-ui {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 100;
            padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
        }
        .logo { height: 3rem; width: auto; pointer-events: auto; }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        /* NEW TOP NAVIGATION BAR */
        .top-nav {
            display: flex;
            gap: 1rem;
            pointer-events: auto;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .top-nav a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            position: relative;
            padding: 0.5rem 0.5rem;
            transition: color 0.3s ease;
            cursor: pointer;
        }
        .top-nav a:hover {
            color: var(--accent-cyan);
        }
        .top-nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: var(--accent-red);
            transition: width 0.3s ease;
        }
        .top-nav a.active {
            color: var(--text-primary);
        }
        .top-nav a.active::after {
            width: 100%;
            background: var(--accent-cyan);
        }
        
        /* --- SLIDES --- */
        .slides-wrapper { position: fixed; inset: 0; width: 100%; height: 100%; }
        .slide {
            position: absolute; inset: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            visibility: hidden; overflow: hidden; opacity: 0;
            will-change: opacity, transform;
        }
        .slide.active { visibility: visible; z-index: 10; opacity: 1; }

        .slide-bg {
            position: absolute; inset: 0; z-index: 1;
            background-size: cover; background-position: center;
            filter: brightness(0.3) grayscale(0.2);
            transform: scale(1.1); 
            will-change: transform;
        }
        #vanta-bg { filter: brightness(1) grayscale(0); }
        #vanta-bg canvas { width: 100% !important; height: 100% !important; }

        .slide-content {
            position: relative; z-index: 3; max-width: 1400px; width: 100%; padding: 0 4vw;
            display: flex; flex-direction: column; justify-content: center; height: 100%;
        }
        
        /* Layout Fix for Standings Slide */
        #slide-2 .slide-content {
            justify-content: flex-start;
            padding-top: 12vh;
        }
        #slide-2 .slide-title {
            font-size: clamp(3rem, 6vw, 6rem);
            margin-bottom: 0.5rem;
        }
        #slide-2 .slide-tag {
            margin-bottom: 1rem;
        }

        /* --- TYPOGRAPHY & GLITCH --- */
        .tech-font { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; line-height: 0.9; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }
        
        .slide-tag {
            display: inline-block; padding: 0.5rem 1rem; margin-bottom: 2rem;
            border-left: 2px solid var(--accent-cyan); color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.2em;
            background: linear-gradient(90deg, rgba(0, 240, 255, 0.1), transparent);
        }
        
        .slide-title {
            font-size: clamp(4rem, 12vw, 11rem); font-weight: 800; margin-bottom: 1rem;
            color: #fff; position: relative; z-index: 2; mix-blend-mode: hard-light;
        }
        .text-outline { -webkit-text-stroke: 1px rgba(255,255,255,0.3); color: transparent; }

        /* Glitch Effect Keyframes */
        .glitch-effect { position: relative; display: inline-block; }
        .glitch-effect::before, .glitch-effect::after {
            content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent; opacity: 0.8;
        }
        .glitch-effect::before {
            color: var(--accent-cyan); z-index: -1; clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
            transform: translate(-2px, -2px); opacity: 0;
        }
        .glitch-effect::after {
            color: var(--accent-red); z-index: -2; clip-path: polygon(0 60%, 100% 60%, 100% 100%, 0 100%);
            transform: translate(2px, 2px); opacity: 0;
        }
        .slide.active .glitch-effect::before { animation: glitch-anim-1 2.5s infinite linear alternate-reverse; opacity: 1; }
        .slide.active .glitch-effect::after { animation: glitch-anim-2 3s infinite linear alternate-reverse; opacity: 1; }

        @keyframes glitch-anim-1 {
            0% { clip-path: polygon(0 2%, 100% 2%, 100% 5%, 0 5%); transform: translate(-2px, 0); }
            20% { clip-path: polygon(0 15%, 100% 15%, 100% 15%, 0 15%); transform: translate(2px, 0); }
            40% { clip-path: polygon(0 10%, 100% 10%, 100% 20%, 0 20%); transform: translate(-2px, 0); }
            60% { clip-path: polygon(0 1%, 100% 1%, 100% 2%, 0 2%); transform: translate(2px, 0); }
            80% { clip-path: polygon(0 33%, 100% 33%, 100% 33%, 0 33%); transform: translate(-1px, 0); }
            100% { clip-path: polygon(0 44%, 100% 44%, 100% 44%, 0 44%); transform: translate(1px, 0); }
        }
        @keyframes glitch-anim-2 {
            0% { clip-path: polygon(0 25%, 100% 25%, 100% 30%, 0 30%); transform: translate(2px, 0); }
            20% { clip-path: polygon(0 3%, 100% 3%, 100% 3%, 0 3%); transform: translate(-2px, 0); }
            40% { clip-path: polygon(0 5%, 100% 5%, 100% 20%, 0 20%); transform: translate(2px, 0); }
            60% { clip-path: polygon(0 20%, 100% 20%, 100% 20%, 0 20%); transform: translate(-2px, 0); }
            80% { clip-path: polygon(0 40%, 100% 40%, 100% 40%, 0 40%); transform: translate(1px, 0); }
            100% { clip-path: polygon(0 50%, 100% 50%, 100% 50%, 0 50%); transform: translate(-1px, 0); }
        }

        .slide-desc {
            font-size: 1.25rem; max-width: 600px; color: #a1a1aa; margin-bottom: 3rem; position: relative; z-index: 2;
        }

        /* --- COUNTDOWN DASHBOARD --- */
        .countdown-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 3rem; }
        .countdown-item {
            background: rgba(20, 20, 20, 0.4);
            border: 1px solid var(--glass-border);
            border-top: 2px solid var(--accent-red);
            padding: 1rem 1.5rem; text-align: center; min-width: 100px;
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
            backdrop-filter: blur(10px); /* Restored High Quality Blur */
            transition: transform 0.3s ease;
        }
        .countdown-item:hover { transform: translateY(-5px); border-color: var(--accent-red); background: rgba(255, 31, 75, 0.1); }
        .countdown-val {
            display: block; font-family: 'Rajdhani', sans-serif; font-size: clamp(2.5rem, 4vw, 4rem);
            font-weight: 700; color: #fff; line-height: 1;
        }
        .countdown-label {
            display: block; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
            color: var(--accent-red); margin-top: 0.5rem; letter-spacing: 0.2em;
        }

        /* --- STANDINGS --- */
        .standings-wrapper { width: 100%; height: 65vh; margin-top: 1rem; position: relative; }
        .standings-view {
            position: absolute; inset: 0; width: 100%; height: 100%;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0; visibility: hidden; transform: translateY(20px); pointer-events: none;
            will-change: opacity, transform;
        }
        .standings-view.active-view { opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto; }

        .table-scroll { height: 100%; overflow-y: auto; padding-right: 1rem; scrollbar-width: none; }
        .table-scroll::-webkit-scrollbar { display: none; }
        
        .standings-table { width: 100%; border-collapse: separate; border-spacing: 0 0.5rem; font-family: 'JetBrains Mono', monospace; }
        .standings-table th {
            text-align: left; color: var(--accent-cyan); padding: 1rem;
            position: sticky; top: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 10;
            font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 0.1em;
        }
        .standings-table td { padding: 1rem; background: var(--glass-bg); border-top: 1px solid transparent; border-bottom: 1px solid transparent; transition: all 0.2s ease; }
        
        /* Dynamic Team Border on Left */
        .standings-table td:first-child { border-radius: 4px 0 0 4px; border-left: 3px solid var(--team-color, transparent); }
        .standings-table td:last-child { border-radius: 0 4px 4px 0; border-right: 1px solid transparent; }
        
        .standings-table tr:hover td { background: rgba(255, 255, 255, 0.1); transform: scale(1.01); }
        
        .team-cell { display: flex; align-items: center; gap: 0.8rem; }
        .team-logo-mini { height: 20px; width: auto; max-width: 30px; object-fit: contain; }

        /* --- 3D GARAGE CARDS --- */
        .garage-grid {
            display: grid; 
            /* FIXED: Use auto-fit to stretch cards equally, and reduced min-width to 300px for better fit */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem; height: 100%; overflow-y: auto; padding: 1rem;
            scrollbar-width: none; perspective: 1000px;
            /* REMOVED GLOBAL PERSPECTIVE TO FIX ALIGNMENT/PARALLAX ISSUE */
            perspective: none; 
        }
        .garage-grid::-webkit-scrollbar { display: none; }

        .constructor-card {
            background: linear-gradient(145deg, rgba(30,30,30,0.6) 0%, rgba(10,10,10,0.8) 100%);
            border: 1px solid var(--glass-border); border-radius: 12px;
            padding: 1.5rem; display: flex; flex-direction: column; position: relative;
            transform-style: preserve-3d; transition: transform 0.1s linear, box-shadow 0.3s ease;
            cursor: none; /* Uses custom cursor */
            will-change: transform;
        }
        /* Dynamic Team Glow */
        .constructor-card::after {
            content: ''; position: absolute; inset: 0; border-radius: 12px;
            box-shadow: 0 0 20px var(--team-color, var(--accent-cyan));
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .constructor-card:hover { border-color: var(--team-color, #fff); }
        .constructor-card:hover::after { opacity: 0.2; }

        .cc-bg-rank {
            position: absolute; top: -1rem; right: 1rem; font-size: 8rem;
            font-family: 'Rajdhani', sans-serif; font-weight: 800;
            color: rgba(255,255,255,0.02); z-index: 0; pointer-events: none;
            transform: translateZ(20px);
        }
        .cc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative; z-index: 2; transform: translateZ(30px); }
        .cc-name { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.5rem; }
        .cc-points {
            color: var(--team-color, var(--accent-cyan)); font-family: 'JetBrains Mono', monospace; font-weight: 700;
            background: rgba(0,0,0,0.5); padding: 0.2rem 0.5rem; border-radius: 4px;
        }
        /* FIXED: Added fixed height to image container for uniform card size */
        .cc-img-container {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            margin: 1rem 0; position: relative; z-index: 1; transform: translateZ(50px);
            height: 130px; /* Ensures consistent height */
        }
        /* FIXED: Updated image styling to align perfectly center */
        .cc-car-img { 
            width: auto; 
            max-width: 100%; 
            height: 100%; 
            object-fit: contain; 
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.6)); 
        }

        /* --- ACCORDION STYLE DOTD (HOVER BASED) --- */
        .dotd-accordion-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 0;
            overflow: hidden;
        }
        
        /* Responsive: switch to row on larger screens */
        @media (min-width: 768px) {
            .dotd-accordion-container {
                flex-direction: row;
            }
        }

        .dotd-panel {
            flex: 1;
            display: flex;
            position: relative;
            background-size: cover;
            background-position: center top;
            background-repeat: no-repeat;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            cursor: pointer;
            min-height: 60px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .dotd-panel::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.9) 100%);
            z-index: 1;
            transition: background 0.5s;
        }
        
        /* HOVER STATE REPLACES .active STATE */
        .dotd-panel:hover {
            flex: 4; 
            cursor: default;
            border-color: var(--team-color);
        }
        
        .dotd-panel:hover::before {
             background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%);
        }

        /* Vertical Text Label (Inactive State) */
        .dotd-label {
            position: absolute;
            z-index: 2;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            text-transform: uppercase;
            color: rgba(255,255,255,0.7);
            transition: all 0.3s;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
        }

        /* Desktop: Rotate text for vertical strips */
        @media (min-width: 768px) {
            .dotd-label {
                transform: translate(-50%, -50%) rotate(-90deg);
                font-size: 1.5rem;
            }
            /* Hide label on hover */
            .dotd-panel:hover .dotd-label {
                opacity: 0;
                transform: translate(-50%, -200%) rotate(-90deg);
            }
        }
        
        /* Mobile: Normal text */
        @media (max-width: 767px) {
            /* Hide label on hover */
            .dotd-panel:hover .dotd-label {
                opacity: 0;
                transform: translate(-200%, -50%);
            }
        }

        /* Content Area (Visible only when Hovered) */
        .dotd-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem;
            z-index: 3;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s 0.1s ease-out;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }

        .dotd-panel:hover .dotd-content {
            opacity: 1;
            transform: translateY(0);
        }

        .dotd-gp-name {
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }
        
        .dotd-driver-name {
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .dotd-team-name {
            color: var(--team-color);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .dotd-badge-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: #FFD700;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 4;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
        }
        
        .dotd-panel:hover .dotd-badge-icon {
            opacity: 1;
            transform: scale(1);
        }


        /* --- CONTROLS --- */
        .standings-tabs { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .tab-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.5);
            padding: 0.75rem 2rem; font-family: 'Rajdhani', sans-serif; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.1em; pointer-events: auto; transition: all 0.3s ease;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tab-btn.active { background: var(--accent-red); color: #fff; border-color: var(--accent-red); box-shadow: 0 0 20px rgba(255,31,75,0.3); }

        .btn-tech {
            pointer-events: auto; display: inline-block; padding: 1rem 3rem;
            background: var(--accent-red); color: #fff; font-family: 'Rajdhani', sans-serif; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.2em; text-decoration: none; border: none;
            clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%); transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .btn-tech::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }
        .btn-tech:hover { transform: translateY(-2px); box-shadow: 10px 10px 30px -10px var(--accent-red); }
        .btn-tech:hover::before { left: 100%; }

        /* --- CALENDAR --- */
        /* OPTIMIZATION: Replaced specific transitions instead of 'all' */
        .cal-grid { display: flex; flex-wrap: wrap; gap: 1rem; max-width: 1200px; margin-top: 2rem; }
        .cal-item {
            border: 1px solid var(--glass-border); padding: 1.5rem; text-align: center;
            transition: transform 0.2s ease, opacity 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            display: flex; flex-direction: column; justify-content: center;
            background: var(--glass-bg); opacity: 0.5; flex: 1 1 140px; min-width: 140px;
            position: relative; overflow: hidden;
            will-change: transform, opacity; /* Hint for browser */
        }
        .cal-item::before {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: var(--accent-cyan); transform: scaleX(0); transition: transform 0.3s ease;
        }
        .cal-item:hover { opacity: 1 !important; transform: translateY(-5px); border-color: rgba(255,255,255,0.3); }
        .cal-item:hover::before { transform: scaleX(1); }
        
        .cal-item.future-race { opacity: 0.8; }
        .cal-item.next-race {
            opacity: 1; border: 1px solid var(--accent-cyan); background: rgba(0, 240, 255, 0.05);
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.1);
        }
        .cal-item.next-race .gp { color: var(--accent-cyan); text-shadow: 0 0 10px var(--accent-cyan); }
        
        .btn-ai-intel {
            margin-top: 0.8rem; padding: 0.4rem; background: rgba(255,255,255,0.1); 
            border: 1px solid var(--accent-cyan); color: var(--accent-cyan); font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; cursor: pointer; pointer-events: auto; transition: all 0.2s;
            text-transform: uppercase; border-radius: 4px; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-ai-intel:hover { background: var(--accent-cyan); color: #000; }

        /* --- CONTACT --- */
        .contact-grid { display: flex; gap: 2rem; flex-wrap: wrap; margin-top: 2rem; }
        .contact-item {
            display: flex; align-items: center; gap: 1rem; padding: 1.5rem 2rem;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            color: #fff; text-decoration: none; transition: all 0.3s ease; pointer-events: auto;
        }
        .contact-item:hover { background: #fff; color: #000; transform: translateY(-5px); }

        /* --- AI FEATURES STYLES --- */
        .team-radio-btn {
            position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px;
            background: var(--accent-red); border-radius: 50%; display: flex; align-items: center; justify-content: center;
            z-index: 990; cursor: pointer; pointer-events: auto; box-shadow: 0 0 20px rgba(255, 31, 75, 0.4);
            transition: all 0.3s ease; border: 2px solid #fff;
        }
        .team-radio-btn:hover { transform: scale(1.1); box-shadow: 0 0 40px rgba(255, 31, 75, 0.8); }
        
        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(10px); /* Restored High Quality Blur */
            z-index: 9990; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; pointer-events: none; 
            transition: all 0.3s ease;
            will-change: opacity, visibility; /* Hint for browser optimization */
        }
        .modal-overlay.active { opacity: 1; visibility: visible; pointer-events: auto; }
        
        /* Chat Interface */
        .chat-interface {
            width: 90%; max-width: 500px; height: 70vh; background: #000;
            border: 1px solid var(--accent-red); display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(255, 31, 75, 0.2); position: relative;
        }
        .chat-header {
            padding: 1rem; background: var(--accent-red); color: #fff; display: flex; justify-content: space-between; align-items: center;
            font-family: 'Rajdhani', sans-serif; font-weight: 700; text-transform: uppercase;
        }
        .chat-messages {
            flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem;
            font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;
        }
        .chat-input-area {
            padding: 1rem; border-top: 1px solid #333; display: flex; gap: 0.5rem; background: #111;
        }
        .chat-input {
            flex-grow: 1; background: #000; border: 1px solid #333; color: #fff; padding: 0.8rem;
            font-family: 'Inter', sans-serif; outline: none; pointer-events: auto;
        }
        .chat-input:focus { border-color: var(--accent-red); }
        .chat-send-btn {
            background: var(--accent-red); color: #fff; border: none; padding: 0 1.5rem;
            font-family: 'Rajdhani', sans-serif; font-weight: 700; cursor: pointer; pointer-events: auto;
        }

        .message { padding: 0.8rem; max-width: 80%; border-radius: 4px; line-height: 1.4; }
        .message.user { align-self: flex-end; background: #333; color: #fff; border-right: 2px solid #fff; }
        .message.ai { align-self: flex-start; background: rgba(255, 31, 75, 0.1); color: var(--accent-cyan); border-left: 2px solid var(--accent-red); }
        
        /* Intel Modal */
        .intel-modal {
            width: 90%; max-width: 800px; 
            background: #000; border: 1px solid var(--accent-cyan);
            padding: 2rem; position: relative; clip-path: polygon(0 0, 100% 0, 100% 90%, 95% 100%, 0 100%);
            display: flex; flex-direction: column;
            will-change: transform, opacity; /* Hint for browser optimization */
        }
        .intel-title { color: var(--accent-cyan); font-family: 'Rajdhani', sans-serif; font-size: 2rem; margin-bottom: 1rem; text-transform: uppercase; }
        
        /* NEW GRID LAYOUT FOR INTEL CONTENT */
        .intel-content-layout {
            display: grid;
            grid-template-columns: 3fr 2fr; /* 60% Left, 40% Right */
            gap: 2rem;
            flex-grow: 1; 
            max-height: 55vh; /* Allow modal to take most of the height */
            overflow: hidden;
        }
        
        .intel-left-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto; /* Allows left column content (map + briefing) to scroll if needed */
            padding-right: 10px;
        }
        
        .intel-right-column {
            overflow-y: auto; /* Allows right column content (setup) to scroll if needed */
            padding-right: 10px;
        }
        
        /* Ensure map container is sized correctly within the left column */
        .intel-map-container {
            flex-shrink: 0;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            position: relative;
        }
        .intel-map-container img {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.8) contrast(1.1);
        }

        .ai-briefing {
            font-family: 'JetBrains Mono', monospace; 
            line-height: 1.6; 
            color: #ccc;
        }

        .close-modal { cursor: pointer; pointer-events: auto; font-size: 1.5rem; color: #fff; transition: color 0.2s; }
        .close-modal:hover { color: var(--accent-cyan); }

        /* NEW SETUP DISPLAY STYLES */
        .setup-display {
            margin-bottom: 1.5rem;
            border: 1px solid var(--accent-red);
            padding: 1rem;
            background: rgba(255, 31, 75, 0.05);
        }
        .setup-display h4 {
            color: var(--accent-red);
            font-size: 1rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        .setup-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            /* Ensure text aligns centrally within the setup card */
            text-align: left; 
        }
        .setup-table td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            text-align: left; /* Default left align */
        }
        .setup-table td:first-child {
            color: var(--accent-cyan);
            font-weight: 700;
            width: 50%; /* Give enough space for parameter name */
        }
        /* ALIGNMENT FIX: Right-align the numerical/value column */
        .setup-table td:last-child {
            text-align: right; 
            color: #fff;
            font-weight: 500;
            width: 50%;
        }


        @media (max-width: 768px) {
            .countdown-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .countdown-item { min-width: auto; padding: 0.8rem; }
            .slide-title { font-size: 4.5rem; }
            .garage-grid { grid-template-columns: 1fr; }
            .table-scroll { overflow-x: auto; }
            .team-radio-btn { width: 50px; height: 50px; bottom: 1.5rem; right: 1.5rem; }
            .intel-modal { padding: 1rem; }
            
            /* Mobile Grid Stack */
            .intel-content-layout {
                grid-template-columns: 1fr; /* Stack vertically */
                max-height: 80vh;
                overflow-y: auto; /* Main modal content scrolls */
            }
            .intel-left-column, .intel-right-column {
                overflow-y: visible; /* Let the main modal scroll */
                padding-right: 0;
            }
            .intel-map-container {
                height: 200px; /* Fixed height for mobile view */
                padding-bottom: 0;
            }
            .intel-map-container img {
                position: static;
                height: 100%;
            }
            
            /* Mobile menu button adjustment */
            .fixed-ui { padding: 1rem 1.5rem; }
            .header-right { gap: 1rem; }
            .top-nav { display: none; /* Hide full menu on mobile */ }
        }
    </style>
</head>
<body>

    <!-- CUSTOM CURSOR -->
    <div id="cursor"></div>
    <div id="cursor-follower"></div>

    <!-- LOADER -->
    <div id="loader">
        <div class="tech-font" style="letter-spacing: 0.3em; font-size: 1.5rem;">INITIALIZING RACE CONTROL</div>
        <div class="loader-bar"><div class="loader-progress" id="load-bar"></div></div>
        <div class="mono-font" style="margin-top: 10px; font-size: 0.8rem; color: #666;">V 2.5.0 // TTRL SYSTEM</div>
    </div>

    <div class="cinematic-grain"></div>

    <div class="fixed-ui">
        <img src="https://raw.githubusercontent.com/HARISHWINNER/TTRL/ade50d630c482acbb96676fc69c2849a58494f7f/RESOURCES/image.png" alt="TTRL" class="logo hover-target">
        <div class="header-right">
            <!-- NEW TOP NAVIGATION LINKS -->
            <div class="top-nav">
                <a href="#" class="nav-link active hover-target" data-slide="0">HOME</a>
                <a href="#" class="nav-link hover-target" data-slide="1">CALENDAR</a>
                <a href="#" class="nav-link hover-target" data-slide="2">STANDINGS</a>
                <a href="#" class="nav-link hover-target" data-slide="3">REGISTER</a>
                <a href="#" class="nav-link hover-target" data-slide="4">PADDOCK</a>
            </div>
            <div class="mono-font text-sm uppercase tracking-widest">
                <span style="color: var(--accent-cyan)">Season 1</span> <span style="animation: blink 1s infinite">// Live</span>
            </div>
        </div>
    </div>

    <!-- SIDE MENU OVERLAY (Removed functionality) -->
    <div class="modal-overlay" id="side-menu">
        <div class="side-menu-content">
            <!-- Content here is redundant but kept for structural completeness -->
        </div>
    </div>

    <!-- TEAM RADIO BUTTON -->
    <div class="team-radio-btn hover-target" id="team-radio-toggle" title="Talk to Race Engineer">
        <i class="fa-solid fa-headset fa-xl" style="color: white;"></i>
    </div>

    <!-- TEAM RADIO MODAL -->
    <div class="modal-overlay" id="radio-modal">
        <div class="chat-interface">
            <div class="chat-header">
                <span><i class="fa-solid fa-tower-broadcast"></i> PIT WALL // CHIEF</span>
                <span class="close-modal hover-target" onclick="toggleRadio()">&times;</span>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="message ai">Radio Check. I'm Chief, your Race Engineer. I can help with setups, strategy, or track info. Over.</div>
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input hover-target" id="user-input" placeholder="Ask about setup, strategy..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="chat-send-btn hover-target" onclick="sendMessage()">TX</button>
            </div>
        </div>
    </div>

    <!-- INTEL MODAL -->
    <div class="modal-overlay" id="intel-modal-overlay">
        <div class="intel-modal">
            <div class="chat-header" style="background:transparent; padding:0; margin-bottom:1rem;">
                <span style="color:var(--accent-cyan)">TACTICAL BRIEFING</span>
                <span class="close-modal hover-target" onclick="closeIntel()">&times;</span>
            </div>
            <div class="intel-title" id="intel-title">GP NAME</div>
            
            <!-- NEW GRID LAYOUT: Map (L-Top), Briefing (L-Bottom), Setup (R-Full) -->
            <div class="intel-content-layout">
                
                <!-- LEFT COLUMN: MAP + AI BRIEFING (Stacked) -->
                <div class="intel-left-column">
                    <div class="intel-map-container">
                        <img id="intel-map" src="" alt="Track Map Placeholder" onerror="this.onerror=null; this.src='https://placehold.co/768x432/111111/FFFFFF?text=MAP+LOADING...'">
                    </div>
                    <!-- AI Briefing goes here -->
                    <div id="ai-briefing" class="ai-briefing"></div>
                </div>
                
                <!-- RIGHT COLUMN: SETUP TABLE -->
                <div class="intel-right-column">
                    <div id="setup-display" class="setup-display mono-font"></div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- REMOVED: Nav Dots -->

    <div class="slides-wrapper">
        <!-- SLIDE 0: HERO -->
        <section class="slide active" id="slide-0">
            <div class="slide-bg" style="background-image: url('https://raw.githubusercontent.com/S-HARISH44/TTRL/577532eaacf8de58ca32f2b9e5d0112cf71a3689/RESOURCES/001-EA-Sports-F1-2023-Video-Game-Review.jpg')"></div>
            <div class="slide-content" style="align-items: center; text-align: center;">
                <div class="slide-tag" id="hero-next-tag">NEXT RACE // LOADING...</div>
                <h1 class="slide-title tech-font glitch-effect" data-text="TURBO TRIBE">TURBO<br><span class="text-outline">TRIBE</span></h1>
                
                <div class="countdown-grid hover-target" id="hero-countdown">
                    <div class="countdown-item"><span class="countdown-val" id="cd-days">00</span><span class="countdown-label">DAYS</span></div>
                    <div class="countdown-item"><span class="countdown-val" id="cd-hours">00</span><span class="countdown-label">HRS</span></div>
                    <div class="countdown-item"><span class="countdown-val" id="cd-minutes">00</span><span class="countdown-label">MIN</span></div>
                    <div class="countdown-item"><span class="countdown-val" id="cd-seconds">00</span><span class="countdown-label">SEC</span></div>
                </div>
                
                <p class="slide-desc">Experience the pinnacle of F1 25 sim racing. Elite competition, precision driving, and a community like no other.</p>
                <div class="btn-container"><button id="start-engine-btn" class="btn-tech hover-target">ENTER PADDOCK</button></div>
            </div>
        </section>

        <!-- SLIDE 1: CALENDAR -->
        <section class="slide" id="slide-1">
            <div class="slide-bg" style="background-image: url('https://raw.githubusercontent.com/S-HARISH44/TTRL/577532eaacf8de58ca32f2b9e5d0112cf71a3689/RESOURCES/Belgium.avif')"></div>
            <div class="slide-content">
                <div class="slide-tag">02 // GLOBAL TOUR</div>
                <h2 class="slide-title tech-font glitch-effect" data-text="RACE CALENDAR">RACE<br><span class="text-outline">CALENDAR</span></h2>
                <div id="calendar-grid" class="cal-grid mono-font"></div>
            </div>
        </section>

        <!-- SLIDE 2: STANDINGS -->
        <section class="slide" id="slide-2">
            <div class="slide-bg" style="background-image: url('https://f1chronicle.com/wp-content/uploads/2024/01/SI202412010400-1920x1080.jpg')"></div>
            <div class="slide-content">
                <div class="slide-tag">03 // LEADERBOARD</div>
                <h2 class="slide-title tech-font glitch-effect" data-text="TOP PERFORMERS">TOP<br><span class="text-outline">PERFORMERS</span></h2>
                <div class="standings-tabs">
                    <button class="tab-btn active hover-target" data-tab="drivers">DRIVERS</button>
                    <button class="tab-btn hover-target" data-tab="constructors">TEAMS</button>
                    <button class="tab-btn hover-target" data-tab="dotd">AWARDS</button>
                </div>
                <div class="standings-wrapper">
                    <div class="standings-view active-view" id="view-drivers">
                         <div class="table-scroll">
                            <table class="standings-table">
                                <thead><tr><th>POS</th><th>DRIVER</th><th>TEAM</th><th>PTS</th></tr></thead>
                                <tbody id="drivers-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="standings-view" id="view-constructors">
                        <div class="garage-grid" id="garage-grid"></div>
                    </div>
                    <div class="standings-view" id="view-dotd">
                        <div class="dotd-accordion-container" id="dotd-container"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SLIDE 3: REGISTER -->
        <section class="slide" id="slide-3">
            <div class="slide-bg" style="background-image: url('https://raw.githubusercontent.com/S-HARISH44/TTRL/577532eaacf8de58ca32f2b9e5d0112cf71a3689/RESOURCES/1-w-GettyImages-2048270135.webp')"></div>
            <div class="slide-content">
                <div class="slide-tag">04 // ENLIST</div>
                <h2 class="slide-title tech-font glitch-effect" data-text="JOIN THE GRID">JOIN<br><span class="text-outline">THE GRID</span></h2>
                <p class="slide-desc">Seats are limited for Season 2. Secure your place in the most competitive league on the platform.</p>
                <div class="btn-container"><a href="https://docs.google.com/forms/d/e/1FAIpQLSc1xE8SkAOIKoHaryLjNgTNXJfmBCSv73vdgxaAA0_uxnmUTw/viewform" target="_blank" class="btn-tech hover-target">REGISTER NOW</a></div>
            </div>
        </section>

         <!-- SLIDE 4: CONTACT -->
        <section class="slide" id="slide-4">
            <div class="slide-bg" id="vanta-bg"></div>
            <div class="slide-content">
                <div class="slide-tag">05 // PADDOCK</div>
                <h2 class="slide-title tech-font glitch-effect" data-text="CONNECT">CONNECT<br><span class="text-outline">WITH US</span></h2>
                <p class="slide-desc">Join our Discord server for live race updates.</p>
                <div class="contact-grid mono-font">
                    <a href="https://discord.gg/EuyPTXqbg6" target="_blank" class="contact-item hover-target"><i class="fa-brands fa-discord"></i> <span>DISCORD</span></a>
                    <a href="https://www.youtube.com/@TurboTribeRacingLeague" target="_blank" class="contact-item hover-target"><i class="fa-brands fa-youtube"></i> <span>YOUTUBE</span></a>
                    <a href="mailto:turbotriberacingleague@gmail.com" class="contact-item hover-target"><i class="fa-solid fa-envelope"></i> <span>EMAIL</span></a>
                </div>
            </div>
        </section>
    </div>

    <!-- REQUIRED LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Observer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.net.min.js"></script>

    <script>
        gsap.registerPlugin(Observer);
        
        // --- API KEY CONFIGURATION ---
        // The key is split into parts to prevent simple scraping, then reassembled at runtime.
        const _k_parts = [
            "AIzaSyBUpBE",
            "iHMqvfc5PCFn",
            "3aqTwfBZg8d9QThI"
        ];
        const apiKey = _k_parts.join('');

        // --- GEMINI API INTEGRATION ---
        async function callGemini(prompt, systemInstruction = "") {
            try {
                // Implementing basic exponential backoff
                const maxRetries = 3;
                let delay = 1000;
                
                for (let i = 0; i < maxRetries; i++) {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    }
                    
                    // If not OK, wait and retry
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Double the delay
                    }
                }
                
                throw new Error('API Call Failed after retries');

            } catch (error) {
                console.error(error);
                return "Radio interference... Signal lost. Please check your connection.";
            }
        }

        // --- NAVIGATION LOGIC ---
        const navLinks = document.querySelectorAll('.top-nav .nav-link');
        
        function updateActiveLink(index) {
            navLinks.forEach(link => link.classList.remove('active'));
            if (navLinks[index]) {
                navLinks[index].classList.add('active');
            }
        }

        navLinks.forEach((link, index) => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                gotoSlide(index);
            });
        });


        // --- TEAM RADIO LOGIC ---
        const radioBtn = document.getElementById('team-radio-toggle');
        const radioModal = document.getElementById('radio-modal');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');

        radioBtn.addEventListener('click', toggleRadio);

        function toggleRadio() {
            radioModal.classList.toggle('active');
            if (radioModal.classList.contains('active')) userInput.focus();
        }

        function getSetupDataForAI(gpName) {
             const setup = f125SetupData[gpName];
             if (!setup) return "No specific setup data available for this track.";
             
             return `
             --- F1 25 Setup Prediction for ${gpName} ---
             Aero: ${setup.aero}
             Differential (On/Off): ${setup.differential}
             Suspension Geometry: ${setup.suspGeometry}
             Suspension (Front/Rear Springs, Front/Rear ARB, Front/Rear Ride Height): ${setup.suspension}
             Brakes (Pressure/Bias): ${setup.brakes}
             Tire Pressure (Q/R): ${setup.tiresQ} / ${setup.tiresR}
             Notes: ${setup.notes}
             ----------------------------------------
             `;
        }

        function getLeagueContext(currentQuery = "") {
            // Converts JS objects into a readable text format for the AI
            const drivers = driverData.map(d => `${d.driver} (${d.team}): ${d.points}pts`).join(', ');
            // Updated to use the decoupled constructor data
            const teams = getConstructorData().map(c => `${c.team}: ${c.points}pts`).join(', ');
            const schedule = leagueCalendar.map(r => `Rd ${r.round} ${r.gp} (${r.date})`).filter(r => r.round !== 'break').join(', ');
            
            // NEW: Add DOTD Data to the context
            const dotdHistory = dotdData.map(d => `${d.gp}: ${d.driver} (${d.team})`).join(', ');

            // Look for potential setup query to inject setup data
            const lastQuery = currentQuery.toLowerCase();
            let setupHint = '';
            
            // Broad check for setup-related keywords
            if (lastQuery.includes('setup') || lastQuery.includes('aero') || lastQuery.includes('diff') || lastQuery.includes('suspension') || lastQuery.includes('wing') || lastQuery.includes('brakes') || lastQuery.includes('tyre') || lastQuery.includes('tire')) {
                
                // Iterate through available setups to find a match
                const availableTracks = Object.keys(f125SetupData);
                
                for (const gpName of availableTracks) {
                    // Create flexible matching terms
                    const firstWord = gpName.split(' ')[0].toLowerCase(); // e.g., "bahrain", "australian"
                    
                    // Match logic: 
                    // 1. Direct match of first word (e.g. "Bahrain")
                    // 2. Common aliases (Australia/Australian, Brazil/Sao Paulo, Imola/Emilia, Silverstone/Great Britain)
                    const isMatch = lastQuery.includes(firstWord) || 
                                   (firstWord === 'australian' && lastQuery.includes('australia')) ||
                                   (firstWord === 'emilia' && lastQuery.includes('imola')) ||
                                   (firstWord === 'great' && (lastQuery.includes('britain') || lastQuery.includes('silverstone') || lastQuery.includes('uk'))) ||
                                   (firstWord === 'so' && (lastQuery.includes('brazil') || lastQuery.includes('sao') || lastQuery.includes('interlagos')));

                    if (isMatch) {
                        setupHint = getSetupDataForAI(gpName);
                        break;
                    }
                }
                
                // Fallback: If user asks for setup but no track is identified, give the AI the list of available tracks so it can ask.
                if (!setupHint) {
                    setupHint = `SYSTEM NOTE: User asked for setup but no specific track was detected in the query. 
                    Available Setups: ${availableTracks.map(t => t.split(' ')[0]).join(', ')}. 
                    Please ask the user which track they need.`;
                }
            }


            return `
            CURRENT STANDINGS (After So Paulo GP):
            Drivers: ${drivers}
            Constructors: ${teams}
            
            DRIVER OF THE DAY AWARDS:
            ${dotdHistory}

            CALENDAR: ${schedule}
            
            ${setupHint}
            `;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // Add User Message
            appendMessage(text, 'user');
            // Store query temporarily before clearing for context lookup
            const queryForContext = userInput.value;
            userInput.value = '';

            // Loading Indicator
            const loadingId = appendMessage('Copy...', 'ai', true);

            // Call Gemini WITH LEAGUE CONTEXT
            const context = getLeagueContext(queryForContext);
            const systemPrompt = `You are 'Chief', a Race Engineer for the Turbo Tribe Racing League (TTRL). 
            
            Here is the COMPLETE TTRL League Data database. Use this to answer any questions about standings, awards, schedule, or car setups:
            ${context}
            
            INSTRUCTIONS:
            - Answer user questions based on the Data above.
            - If asked who is winning, check the points.
            - If asked about Driver of the Day, check the Awards section.
            - If asked for a setup, provide the specific values from the data.
            - Be concise, tactical, and use F1 jargon (Box box, Delta, Apex, Sector, Deg).
            - Keep responses under 50 words.
            - Do not use markdown formatting like **bold** or *italics*.`;
            
            // FIX: Ensure systemPrompt is passed correctly (already fixed in previous step)
            const reply = await callGemini(text, systemPrompt); 

            // Remove loading and add AI response
            document.getElementById(loadingId).remove();
            appendMessage(reply, 'ai');
        }

        function appendMessage(text, sender, isLoading = false) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            if (isLoading) {
                div.id = 'loading-' + Date.now();
                div.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${text}`;
            } else {
                div.innerText = text;
            }
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return div.id;
        }

        // --- TRACK INTEL LOGIC ---
        const intelModal = document.getElementById('intel-modal-overlay');
        const intelTitle = document.getElementById('intel-title');
        // const intelContent = document.getElementById('intel-content'); // Removed
        const intelMap = document.getElementById('intel-map');
        const setupDisplay = document.getElementById('setup-display');
        const aiBriefing = document.getElementById('ai-briefing');

        function closeIntel() {
            intelModal.classList.remove('active');
        }

        function displaySetupData(setup) {
            if (!setup) {
                setupDisplay.innerHTML = "<h4>Baseline Setup Prediction</h4><p>No specific F1 25 setup data available for this track.</p>";
                return;
            }

            // Suspension format: "41-3-7-16-21-40 (Springs F/R, ARB F/R, Ride Height F/R)"
            const suspPartsRegex = /(\d+)-(\d+)-(\d+)-(\d+)-(\d+)-(\d+)/;
            const match = setup.suspension.match(suspPartsRegex);
            
            let springs = setup.suspension;
            let arb = 'N/A';
            let rideHeight = 'N/A';

            if (match) {
                springs = `${match[1]} - ${match[2]}`;
                arb = `${match[3]} - ${match[4]}`;
                rideHeight = `${match[5]} - ${match[6]}`;
            }

            setupDisplay.innerHTML = `
                <h4>F1 25 Baseline Setup Prediction</h4>
                <table class="setup-table">
                    <tr><td>Aero (F/R)</td><td>${setup.aero}</td></tr>
                    <tr><td>Differential (On/Off)</td><td>${setup.differential}</td></tr>
                    <tr><td>Susp. Geometry</td><td>${setup.suspGeometry}</td></tr>
                    <tr><td>Suspension Springs (F/R)</td><td>${springs}</td></tr>
                    <tr><td>Anti-roll Bar (F/R)</td><td>${arb}</td></tr>
                    <tr><td>Ride Height (F/R)</td><td>${rideHeight}</td></tr>
                    <tr><td>Brakes (Pressure/Bias)</td><td>${setup.brakes}</td></tr>
                    <tr><td>Tires Pressure (Q/R)</td><td>${setup.tiresQ.split('/')[0].trim()} / ${setup.tiresR.split('/')[0].trim()}</td></tr>
                    <tr><td>Compounds</td><td>${setup.compounds}</td></tr>
                </table>
            `;
        }


        async function fetchTrackIntel(gpName) {
            intelModal.classList.add('active');
            
            // Use requestAnimationFrame to ensure the animation starts smoothly before JS logic kicks in
            requestAnimationFrame(async () => {
                const raceData = leagueCalendar.find(r => r.gp === gpName);
                const setup = f125SetupData[gpName];

                const mapUrl = raceData ? raceData.mapUrl : 'https://placehold.co/768x432/111111/FFFFFF?text=MAP+NOT+FOUND';
                const trackName = raceData ? raceData.track : gpName;

                intelTitle.innerText = gpName.toUpperCase();
                intelMap.src = mapUrl; // Set the track map image
                
                displaySetupData(setup); // Display the structured setup data immediately

                aiBriefing.innerHTML = `<i class="fa-solid fa-satellite-dish fa-spin"></i> DOWNLOADING TACTICAL BRIEFING...`;

                // Enhanced prompt for AI briefing
                const prompt = `Provide a tactical summary briefing for the ${gpName} (${trackName}) in F1 23/24 video game. 
                Focus on: 1. Key overtaking spots. 2. Tire wear warning. 
                Keep it strictly tactical, conversational, and under 50 words. No intro/outro.`;
                
                const briefing = await callGemini(prompt);
                
                // Optimized Typewriter using textContent and requestAnimationFrame
                aiBriefing.textContent = "";
                let i = 0;
                
                function typeWriter() {
                    // Performance: Append chunks of text instead of single characters to reduce layout trashing
                    // and use textContent to avoid HTML parsing overhead.
                    if (i < briefing.length) {
                        const chunk = briefing.slice(i, i + 3); // Add 3 chars at a time for performance
                        aiBriefing.textContent += chunk;
                        i += 3;
                        
                        // Use requestAnimationFrame for smoother visual updates
                        if (i < briefing.length) {
                            setTimeout(() => requestAnimationFrame(typeWriter), 20); 
                        }
                    }
                }
                typeWriter();
            });
        }


        // --- ASSETS & DATA ---
        // Added Team Colors Map for Dynamic Branding
        const teamColors = {
            "FERRARI": "#E80020", "WILLIAMS": "#64C4FF", "ALPINE": "#0093CC", "HAAS": "#B6BABD", "MCLAREN": "#FF8000",
            "KICK SAUBER": "#52E252", "ASTON MARTIN": "#229971", "RACING BULLS": "#6692FF", "MERCEDES": "#27F4D2",
            "RED BULL RACING": "#3671C6"
        };
        const teamLogoMap = { "FERRARI": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/ferrari.png", "WILLIAMS": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/williams.png", "ALPINE": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/alpine.png", "HAAS": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/haas.png", "MCLAREN": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/mclaren.png", "KICK SAUBER": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/kick_sauber.png", "ASTON MARTIN": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/martin.png", "RACING BULLS": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/vcarb.png", "MERCEDES": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/mercedes.png", "RED BULL RACING": "https://raw.githubusercontent.com/S-HARISH44/TTRL-RESOURCES/d4faca0970a4d20419af0e364a9e1aebb9af0fe0/LOGOS/redbull.png" };
        const teamCarMap = { "FERRARI": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025ferraricarright.png", "WILLIAMS": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025williamscarright.png", "ALPINE": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025alpinecarright.png", "HAAS": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025haasf1teamcarright.png", "ASTON MARTIN": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025astonmartincarright.png", "KICK SAUBER": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025kicksaubercarright.png", "MCLAREN": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025mclarencarright.png", "RED BULL RACING": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025redbullracingcarright.png", "RACING BULLS": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025racingbullscarright.png", "MERCEDES": "https://raw.githubusercontent.com/S-HARISH44/TTRL/81a0eb55cacfee2f08a1b599ecd314608b6b0424/RESOURCES/Constructor/2025mercedescarright.png" };
        
        // --- UPDATED LEAGUE CALENDAR DATA ---
        const leagueCalendar = [
            { round: 0, gp: "Pre-Season Testing", date: "12/09/25", track: "Suzuka International Racing Course", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2022/07/Suzuka-International-Racing-Course--768x432.png", insight: "A crucial time for teams to gather data, test new parts, and understand the car before the championship begins at Bahrain.", stats: null },
            { round: 1, gp: "Bahrain Grand Prix", date: "19/09/25", track: "Bahrain International Circuit", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2022/07/Bahrain-circuit-768x432.png", insight: "A 'stop and go' track known for heavy braking zones and good overtaking opportunities, especially into Turns 1 and 4. Tire degradation is a major factor.", stats: null },
            { round: 2, gp: "Australian Grand Prix", date: "26/09/25", track: "Albert Park Circuit", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2022/07/Albert-Park-Circuit-768x432.png", insight: "A fast, flowing street circuit with multiple DRS zones. It's a high-speed track that feels like a permanent circuit. Key overtaking spots are Turns 1, 3, and 9.", stats: null },
            { round: 3, gp: "Emilia Romagna Grand Prix", date: "03/10/25", track: "Autodromo Enzo e Dino Ferrari (Imola)", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2022/07/Autodromo-Enzo-e-Dino-Ferrari-768x432.png", insight: "An old-school, narrow track with punishing gravel traps. It's fast, unforgiving, and very technical. Overtaking is notoriously difficult, so qualifying and strategy are critical.", stats: null },
            { round: 4, gp: "Spanish Grand Prix", date: "10/10/25", track: "Circuit de Barcelona-Catalunya", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2024/02/Circuit-de-Barcelona-768x432.png", insight: "A well-known test track with a great mix of high and low-speed corners. The long, sweeping Turn 3 is a true test of car balance. Tire management is crucial here.", stats: null },
            { round: "break", gp: "Season Break", date: "17/10/25", track: "Time for teams to regroup and upgrade.", mapUrl: "https://placehold.co/768x432/1f2937/e11d48?text=SEASON+BREAK", insight: "A mid-season break for teams to analyze performance, develop upgrades, and for drivers to recharge.", stats: null },
            { round: 5, gp: "Great Britain Grand Prix", date: "24/10/25", track: "Silverstone Circuit", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2022/07/Silverstone-Circuit--768x432.png", insight: "An iconic, high-speed circuit featuring legendary corners like Maggotts, Becketts, and Chapel. Requires high downforce and strong aerodynamic efficiency.", stats: null },
            { round: 6, gp: "Las Vegas Grand Prix", date: "31/10/25", track: "Las Vegas Strip Circuit", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2024/02/Las-Vegas-GP-768x432.png", insight: "A fast street circuit with long straights, especially down the famous Strip. Expect high top speeds, heavy braking, and many overtaking opportunities.", stats: null },
            { round: 7, gp: "Belgian Grand Prix", date: "07/11/25", track: "Circuit de Spa-Francorchamps", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2022/07/Circuit-de-Spa-Francorchamps-768x432.png", insight: "A driver favorite, known for its length, elevation changes, and the iconic Eau Rouge/Raidillon sequence. It's a high-speed, low-downforce track.", stats: null },
            { round: 8, gp: "Austrian Grand Prix", date: "14/11/25", track: "Red Bull Ring", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2022/07/Red-Bull-Ring-768x432.png", insight: "A short, 'power' circuit with long straights and heavy uphill braking zones. The lap is very quick. It offers great overtaking opportunities into Turns 1, 3, and 4.", stats: null },
            { round: 9, gp: "So Paulo Grand Prix", date: "21/11/25", track: "Autdromo Jos Carlos Pace (Interlagos)", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2022/07/Auto%CC%81dromo-Jose%CC%81-Carlos-Pace--768x432.png", insight: "A classic anti-clockwise track with significant elevation changes. The long uphill run to Turn 1 is a major DRS zone. The 'Senna S' is an iconic opening sequence.", stats: null },
            { round: 10, gp: "Abu Dhabi Grand Prix", date: "28/11/25", track: "Yas Marina Circuit", mapUrl: "https://www.sportmonks.com/wp-content/uploads/2022/07/Yas-Marina-Circuit--768x432.png", insight: "A modern circuit with a mix of high-speed straights and a technical final sector. Overtaking was improved with recent layout changes.", stats: null }
        ];

        // --- DOTD DATA ---
        // Updated with correct image URLs from the user
        const dotdData = [
            { 
                gp: "Bahrain Grand Prix", 
                driver: "Sanju Vibhi", 
                team: "ASTON MARTIN", 
                image: "https://raw.githubusercontent.com/S-HARISH44/TTRL/59bd92e0c4dff4bded6f75ae03ddf28148b4779a/RESOURCES/DOTD/Sanju.png",
                desc: "Voted Driver of the Day for a stellar performance."
            },
            { 
                gp: "Australian Grand Prix", 
                driver: "Apex Entropy", 
                team: "KICK SAUBER", 
                image: "https://raw.githubusercontent.com/S-HARISH44/TTRL/59bd92e0c4dff4bded6f75ae03ddf28148b4779a/RESOURCES/DOTD/Apex%201.png",
                desc: "Exceptional pace down under at Albert Park."
            },
            { 
                gp: "Emilia Romagna GP", 
                driver: "Mahesh", 
                team: "WILLIAMS", 
                image: "https://raw.githubusercontent.com/S-HARISH44/TTRL/59bd92e0c4dff4bded6f75ae03ddf28148b4779a/RESOURCES/DOTD/Mahesh.png",
                desc: "A fan-favorite drive at Imola's historic circuit."
            },
            { 
                gp: "Spanish Grand Prix", 
                driver: "Apex Entropy", 
                team: "ALPINE", 
                image: "https://raw.githubusercontent.com/S-HARISH44/TTRL/59bd92e0c4dff4bded6f75ae03ddf28148b4779a/RESOURCES/DOTD/Apex.png",
                desc: "Superb driving at Catalunya earned the fans' vote."
            },
            { 
                gp: "Great Britain GP", 
                driver: "Sanju Vibhi", 
                team: "ASTON MARTIN", 
                image: "https://raw.githubusercontent.com/S-HARISH44/TTRL/59bd92e0c4dff4bded6f75ae03ddf28148b4779a/RESOURCES/DOTD/Sanju%201.png",
                desc: "A standout performance at Silverstone."
            },
            { 
                gp: "Las Vegas Grand Prix", 
                driver: "Harish", 
                team: "HAAS", 
                image: "https://raw.githubusercontent.com/S-HARISH44/TTRL/59bd92e0c4dff4bded6f75ae03ddf28148b4779a/RESOURCES/DOTD/Harish.png",
                desc: "Electrifying drive on the Vegas Strip."
            },
            { 
                gp: "Belgian Grand Prix", 
                driver: "Sandeep Mareedu", 
                team: "RACING BULLS", 
                image: "https://raw.githubusercontent.com/S-HARISH44/TTRL/59bd92e0c4dff4bded6f75ae03ddf28148b4779a/RESOURCES/DOTD/Sandeep.png",
                desc: "Incredible drive as a reserve for Racing Bulls."
            },
            { 
                gp: "Austrian Grand Prix", 
                driver: "Wi7ard", 
                team: "WILLIAMS", 
                image: "https://raw.githubusercontent.com/S-HARISH44/TTRL/59bd92e0c4dff4bded6f75ae03ddf28148b4779a/RESOURCES/DOTD/Wizard.png",
                desc: "Magical performance at the Red Bull Ring."
            },
            { 
                gp: "So Paulo Grand Prix", 
                driver: "TheGodfather", 
                team: "ALPINE", 
                image: "https://raw.githubusercontent.com/S-HARISH44/TTRL/59bd92e0c4dff4bded6f75ae03ddf28148b4779a/RESOURCES/DOTD/Godfather.png",
                desc: "An offer Interlagos couldn't refuse."
            }
        ];


        // --- UPDATED POINTS - Data is accurate up to (and including) the So Paulo Grand Prix ---
        const driverData = [ 
            { driver: "SIMMAN", team: "FERRARI", points: 158 }, 
            { driver: "WI7ARD", team: "WILLIAMS", points: 160 }, 
            { driver: "THEGODFATHER", team: "ALPINE", points: 72 }, 
            { driver: "HARISH", team: "HAAS", points: 74 }, 
            { driver: "APEXENTROPY", team: "ALPINE", points: 58 }, 
            { driver: "OVERLOAD", team: "MCLAREN", points: 34 }, 
            { driver: "VIBIN", team: "ASTON MARTIN", points: 88 }, 
            { driver: "KENTUCKY", team: "HAAS", points: 41 }, 
            { driver: "MAHESH", team: "WILLIAMS", points: 35 }, 
            { driver: "OXYGEN", team: "KICK SAUBER", points: 18 }, 
            { driver: "MEMB", team: "MERCEDES", points: 18 }, 
            { driver: "APURRV", team: "ASTON MARTIN", points: 21 },
            { driver: "BOPEDOPE", team: "MCLAREN", points: 24 }, 
            { driver: "CLONE", team: "RACING BULLS", points: 8 }, 
            { driver: "DENJI", team: "RED BULL RACING", points: 8 }, 
            { driver: "MAAYAONE", team: "MERCEDES", points: 0 }, 
            { driver: "BALA", team: "KICK SAUBER", points: 0 }, 
            { driver: "NIGHTFURY", team: "FERRARI", points: 0 }, 
            { driver: "SPARTAN GAMER", team: "RACING BULLS", points: 0 }, 
            { driver: "HARRYBECKHAM", team: "RED BULL RACING", points: 1 } 
        ];

        // --- NEW: MANUAL CONSTRUCTOR POINTS (Decoupled from Driver Points) ---
        const manualConstructorPoints = {
            "WILLIAMS": 195,
            "FERRARI": 162,
            "ALPINE": 116,
            "HAAS": 116,
            "ASTON MARTIN": 111,
            "MCLAREN": 60,
            "KICK SAUBER": 51,
            "MERCEDES": 42,
            "RACING BULLS": 34,
            "RED BULL RACING": 30
        };

        // --- F1 25 SETUP DATASET (Source: F1 25 setup.xlsx - F1 25 .csv) ---
        // The data is normalized to match the GP names in leagueCalendar.
        const f125SetupData = {
            "Australian Grand Prix": {
                aero: "13-9 (Q) / 9-3 (R)",
                differential: "100 (On) - 20 (Off)",
                suspGeometry: "LLLL (Full Left)",
                suspension: "41-3-7-16-21-40 (Springs F/R, ARB F/R, Ride Height F/R)",
                brakes: "100% / 54-55%",
                tiresQ: "MAX / MAX (27.0 PSI / 23.5 PSI)",
                tiresR: "MAX / MAX (27.5 PSI / 23.5 PSI)",
                compounds: "C3-C5",
                notes: "High degradation on C4/C5. Requires sharp turning setup. Base setup is for Quali/Race mix."
            },
            "Bahrain Grand Prix": {
                aero: "20-15",
                differential: "80 (On) - 50 (Off)",
                suspGeometry: "RLRL",
                suspension: "5-3-9-3-20-40",
                brakes: "100% / 50%",
                tiresQ: "23.2 PSI / 21.0 PSI",
                tiresR: "21.2 PSI / 19.0 PSI",
                compounds: "C2-C4",
                notes: "High traction focus needed for stop/go corners. Manage rear tire temp."
            },
            "Emilia Romagna Grand Prix": {
                aero: "35-30",
                differential: "50 (On) - 50 (Off)",
                suspGeometry: "LLLR",
                suspension: "7-8-3-1-30-40",
                brakes: "100% / 52%",
                tiresQ: "24.0 PSI / 21.5 PSI",
                tiresR: "22.0 PSI / 20.0 PSI",
                compounds: "C3-C5",
                notes: "High downforce, low-speed technicality. Low differential lock helps rotation."
            },
            "Spanish Grand Prix": {
                aero: "38-30",
                differential: "60 (On) - 55 (Off)",
                suspGeometry: "RRRR",
                suspension: "3-8-4-1-20-40",
                brakes: "100% / 55%",
                tiresQ: "24.2 PSI / 21.8 PSI",
                tiresR: "22.2 PSI / 20.8 PSI",
                compounds: "C1-C3",
                notes: "Long sweeping corners (T3) kill the front-left. Manage tire deg. Medium-high downforce bias."
            },
            "Great Britain Grand Prix": {
                aero: "20-15",
                differential: "90 (On) - 60 (Off)",
                suspGeometry: "LLRL",
                suspension: "10-1-5-1-15-30",
                brakes: "100% / 53%",
                tiresQ: "23.5 PSI / 21.0 PSI",
                tiresR: "21.5 PSI / 19.5 PSI",
                compounds: "C1-C3",
                notes: "High speed, low downforce track. Setup focused on aerodynamic efficiency for Maggotts/Becketts."
            },
            "Las Vegas Grand Prix": {
                aero: "10-5",
                differential: "100 (On) - 20 (Off)",
                suspGeometry: "LLLL",
                suspension: "1-1-1-1-30-40",
                brakes: "100% / 50%",
                tiresQ: "23.0 PSI / 21.0 PSI",
                tiresR: "21.0 PSI / 19.0 PSI",
                compounds: "C4-C5",
                notes: "Absolute minimum drag required for the long straight. Soft suspension for bumps."
            },
            "Belgian Grand Prix": {
                aero: "15-10",
                differential: "90 (On) - 60 (Off)",
                suspGeometry: "RRRL",
                suspension: "1-1-1-1-25-30",
                brakes: "100% / 50%",
                tiresQ: "22.8 PSI / 20.8 PSI",
                tiresR: "20.8 PSI / 18.8 PSI",
                compounds: "C2-C4",
                notes: "Maximum straight-line speed essential. Compromise downforce for drag."
            },
            "Austrian Grand Prix": {
                aero: "20-15",
                differential: "95 (On) - 65 (Off)",
                suspGeometry: "LLLR",
                suspension: "5-1-4-1-20-30",
                brakes: "100% / 54%",
                tiresQ: "23.0 PSI / 21.0 PSI",
                tiresR: "21.0 PSI / 19.0 PSI",
                compounds: "C3-C5",
                notes: "Shortest lap, heavy braking after long straights. Soft suspension for kerbs."
            },
            "So Paulo Grand Prix": {
                aero: "30-25",
                differential: "50 (On) - 50 (Off)",
                suspGeometry: "RRRR",
                suspension: "7-8-3-1-25-40",
                brakes: "100% / 52%",
                tiresQ: "24.0 PSI / 21.5 PSI",
                tiresR: "22.0 PSI / 20.0 PSI",
                compounds: "C3-C5",
                notes: "Anti-clockwise track. Needs rotation in the Senna S. High downforce balance."
            },
            "Abu Dhabi Grand Prix": {
                aero: "25-20",
                differential: "70 (On) - 55 (Off)",
                suspGeometry: "LLRL",
                suspension: "3-5-2-1-20-40",
                brakes: "100% / 53%",
                tiresQ: "23.8 PSI / 21.3 PSI",
                tiresR: "21.8 PSI / 19.8 PSI",
                compounds: "C3-C5",
                notes: "Technical final sector. Setup is a compromise between high-speed and corner stability."
            },
            // Note: Data for "Pre-Season Testing" and "Season Break" is intentionally omitted as a setup is irrelevant.
        };
        // --- END F1 25 SETUP DATASET ---

        // --- CORE FUNCTIONS ---
        
        // 1. Loading Sequence
        window.addEventListener('load', () => {
            gsap.to('#load-bar', { width: '100%', duration: 1.5, ease: 'power2.inOut', onComplete: () => {
                gsap.to('#loader', { y: '-100%', duration: 0.8, ease: 'power3.inOut' });
                // Reveal Hero Elements
                setTimeout(() => {
                    revealSlideContent(document.querySelector('#slide-0'));
                }, 500);
            }});
        });

        // 2. Custom Cursor Logic
        function initCursor() {
            const cursor = document.getElementById('cursor');
            const follower = document.getElementById('cursor-follower');
            
            let mouseX = 0, mouseY = 0;
            let posX = 0, posY = 0;

            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                // Instant update for small dot
                cursor.style.left = mouseX + 'px';
                cursor.style.top = mouseY + 'px';
            });

            // Smooth follow for circle
            gsap.ticker.add(() => {
                posX += (mouseX - posX) / 6;
                posY += (mouseY - posY) / 6;
                follower.style.left = posX + 'px';
                follower.style.top = posY + 'px';
            });

            // Hover effects
            const hoverTargets = document.querySelectorAll('a, button, .hover-target, .tab-btn, .team-radio-btn');
            hoverTargets.forEach(el => {
                el.addEventListener('mouseenter', () => document.body.classList.add('hovering'));
                el.addEventListener('mouseleave', () => document.body.classList.remove('hovering'));
            });
        }

        // 3. 3D Tilt Effect for Cards (Optimized)
        function initTilt() {
            // OPTIMIZATION: Disable on touch devices to save resources
            if (window.matchMedia("(pointer: coarse)").matches) return;

            document.querySelectorAll('.constructor-card').forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const rotateX = ((y - centerY) / centerY) * -10; // Max 10deg rotation
                    const rotateY = ((x - centerX) / centerX) * 10;

                    gsap.to(card, { transform: `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`, duration: 0.1 });
                });
                
                card.addEventListener('mouseleave', () => {
                    gsap.to(card, { transform: `perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)`, duration: 0.5 });
                });
            });
        }

        function getConstructorData() {
            const teamMap = {};
            
            // Initialize from MANUAL points (ensure all teams exist and have correct fixed points)
            Object.keys(manualConstructorPoints).forEach(team => {
                teamMap[team] = { 
                    points: manualConstructorPoints[team], 
                    drivers: [] 
                };
            });

            // Populate current drivers for display only (DO NOT calculate points from them)
            driverData.forEach(d => { 
                if (teamMap[d.team]) {
                    teamMap[d.team].drivers.push(d.driver);
                }
            });

            return Object.entries(teamMap)
                .map(([team, data]) => ({ 
                    team, 
                    points: data.points, 
                    drivers: data.drivers.join(', ') 
                }))
                .sort((a, b) => b.points - a.points);
        }

        // UPDATED CALENDAR WITH AI INTEL BUTTON AND NEW DATA STRUCTURE
        function populateCalendar() {
            const now = new Date();
            const RACE_TIME = { hours: 17, minutes: 0 };
            document.getElementById('calendar-grid').innerHTML = leagueCalendar.filter(r => r.round !== 0).map(r => { // Filter out Pre-Season Testing for main display
                const roundText = r.round === 'break' ? 'BREAK' : 'RD ' + String(r.round).padStart(2, '0');
                const [d, m, y] = r.date.split('/').map(Number);
                const raceDate = new Date(Date.UTC(y, m - 1, d, RACE_TIME.hours, RACE_TIME.minutes));
                
                let statusClass = '';
                let statusText = roundText;

                if (r.round === 'break') {
                    statusClass = '';
                } else if (raceDate < now) { 
                     statusClass = ''; 
                } else {
                    statusClass = 'future-race';
                    const isNext = !leagueCalendar.some(prev => {
                        if (prev.round === 'break' || prev.round === 0) return false;
                        const [pd, pm, py] = prev.date.split('/').map(Number);
                        const prevDate = new Date(Date.UTC(py, pm - 1, pd, RACE_TIME.hours, RACE_TIME.minutes));
                        return prevDate > now && prevDate < raceDate;
                    });
                    if (isNext) { statusClass = 'next-race'; statusText = 'NEXT UP'; }
                }
                
                // Only show Strategy button for actual race rounds
                let footerContent = '';
                if (r.round === 'break') {
                    footerContent = `<span style="margin-top: 0.8rem; display: block; color: #555; font-size: 0.75rem;">TEAM REGROUP</span>`;
                } else {
                     footerContent = `
                        <button class="btn-ai-intel hover-target" onclick="fetchTrackIntel('${r.gp}')">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> STRATEGY
                        </button>`;
                }

                return `
                <div class="cal-item ${statusClass} hover-target">
                    <span class="round">${statusText}</span>
                    <span class="gp">${r.gp.split(' ')[0].toUpperCase()}</span>
                    <span class="date">${r.date.slice(0, 5)}</span>
                    ${footerContent}
                </div>`;
            }).join('');
        }
        
        function populateDrivers() {
             document.getElementById('drivers-body').innerHTML = [...driverData].sort((a,b)=>b.points-a.points).map((d,i) => {
                 const tColor = teamColors[d.team] || '#fff';
                 return `<tr style="--team-color: ${tColor}"><td style="color:${i<3?['#FFD700','#C0C0C0','#CD7F32'][i]:'inherit'}">${String(i+1).padStart(2,'0')}</td><td style="font-weight:700;color:#fff">${d.driver}</td><td class="team-cell"><img src="${teamLogoMap[d.team] || ''}" class="team-logo-mini" alt="${d.team}"> ${d.team}</td><td style="color:var(--accent-cyan);font-weight:700">${d.points}</td></tr>`;
             }).join('');
        }

        function populateGarage() {
            document.getElementById('garage-grid').innerHTML = getConstructorData().map((c,i) => {
                const tColor = teamColors[c.team] || '#fff';
                
                // FIX: Specific adjustment for Ferrari image to align it with others
                let customImgStyle = '';
                if (c.team === 'FERRARI') {
                    customImgStyle = 'transform: translateY(-8px) scale(1.15);'; // Lift up and slightly enlarge to match visual weight
                }

                return `<div class="constructor-card hover-target" data-rank="${String(i+1).padStart(2,'0')}" style="--team-color: ${tColor}">
                    <div class="cc-bg-rank">${String(i+1).padStart(2,'0')}</div>
                    <div class="cc-header">
                        <span class="cc-name">${c.team}</span>
                        <span class="cc-points" data-drivers="${c.drivers}">${c.points} PTS</span>
                    </div>
                    <div class="cc-img-container">
                        <img src="${teamCarMap[c.team] || 'https://placehold.co/300x100?text=Car'}" class="cc-car-img" alt="${c.team} Car" style="${customImgStyle}">
                    </div>
                </div>`;
            }).join('');
            
            // Re-init tilt after DOM population
            setTimeout(initTilt, 100);
        }

        // --- NEW FUNCTION: RENDER ACCORDION DOTD ---
        function renderDOTDAccordion() {
            const container = document.getElementById('dotd-container');
            
            // Generate HTML
            const html = dotdData.map((data, index) => {
                const tColor = teamColors[data.team] || '#fff';
                // Active class for the last item initially (most recent race)
                // const isActive = index === dotdData.length - 1 ? 'active' : ''; // Removed as per new hover logic
                
                return `
                <div class="dotd-panel" 
                     style="background-image: url('${data.image}'); --team-color: ${tColor}">
                    
                    <div class="dotd-label">${data.driver.split(' ')[0]}</div>
                    <div class="dotd-badge-icon"><i class="fa-solid fa-award"></i></div>
                    
                    <div class="dotd-content">
                        <div class="dotd-gp-name">${data.gp}</div>
                        <div class="dotd-driver-name">${data.driver}</div>
                        <div class="dotd-team-name" style="color:${tColor}">${data.team}</div>
                        <div class="mono-font" style="font-size:0.8rem; color:#ccc; margin-top:0.5rem;">${data.desc}</div>
                    </div>
                </div>`;
            }).join('');
            
            container.innerHTML = html;
        }

        // FIX 2: Corrected Countdown Clock Logic
        function initSyncedCountdown() {
            // Set the current date to UTC to prevent local timezone issues with future race dates
            const now = new Date();
            const RACE_TIME = { hours: 17, minutes: 0 }; // Assuming race time is 17:00 UTC
            let nextRace = null;
            
            for (const race of leagueCalendar) {
                if (race.round === 'break' || race.round === 0) continue;
                
                // Parse date components: DD/MM/YY
                let [d, m, y] = race.date.split('/').map(Number);
                
                // FIX: Handle 2-digit years correctly (e.g., 25 -> 2025)
                if (y < 100) y += 2000;

                // Create Date object using UTC constructor (Year, Month Index (0-11), Day, Hour, Minute)
                const raceDate = new Date(Date.UTC(y, m - 1, d, RACE_TIME.hours, RACE_TIME.minutes));

                if (raceDate.getTime() > now.getTime()) { 
                    nextRace = { ...race, raceDate }; 
                    break;
                }
            }
            
            const nextTagEl = document.getElementById('hero-next-tag');
            const els = { d: document.getElementById('cd-days'), h: document.getElementById('cd-hours'), m: document.getElementById('cd-minutes'), s: document.getElementById('cd-seconds') };

            if (!nextRace) { 
                nextTagEl.textContent = "SEASON COMPLETED"; 
                Object.values(els).forEach(e => e.textContent = "GO"); 
                return; 
            }
            
            nextTagEl.textContent = `NEXT RACE // ${nextRace.gp.toUpperCase().replace(' GRAND PRIX', '')}`;

            function updateTimer() {
                const currentTime = new Date().getTime(); // Always use current time
                const dist = nextRace.raceDate.getTime() - currentTime;
                
                if (dist < 0) { 
                    Object.values(els).forEach(e => e.textContent = "GO"); 
                    return; 
                }
                
                const dayMs = 864e5; // 1000 * 60 * 60 * 24
                const hourMs = 36e5; // 1000 * 60 * 60
                const minuteMs = 6e4; // 1000 * 60

                els.d.textContent = String(Math.floor(dist / dayMs)).padStart(2, '0');
                els.h.textContent = String(Math.floor((dist % dayMs) / hourMs)).padStart(2, '0');
                els.m.textContent = String(Math.floor((dist % hourMs) / minuteMs)).padStart(2, '0');
                els.s.textContent = String(Math.floor((dist % minuteMs) / 1000)).padStart(2, '0');
            }
            updateTimer(); 
            setInterval(updateTimer, 1000);
        }

        // --- ANIMATION ENGINE ---
        const slides = document.querySelectorAll('.slide');
        const totalSlides = slides.length;
        let currentIndex = 0;
        let isAnimating = false;

        function splitText(selector) {
            document.querySelectorAll(selector).forEach(e => {
                // Only split if not already special (avoiding glitch conflict)
                if(e.classList.contains('glitch-effect')) return;
                e.innerHTML = e.innerText.split('').map(c => `<span class="char" style="opacity:0">${c===' '?'&nbsp;':c}</span>`).join('');
            });
        }

        populateCalendar();
        populateDrivers();
        populateGarage();
        renderDOTDAccordion(); // Initialize the new accordion
        initSyncedCountdown();
        initCursor();
        
        // OPTIMIZATION: Reduced Vanta.js intensity for better performance
        VANTA.NET({
            el: "#vanta-bg",
            mouseControls: true, touchControls: true, gyroControls: false,
            minHeight: 200.00, minWidth: 200.00, scale: 1.00, scaleMobile: 1.00,
            color: 0x00f0ff, backgroundColor: 0x050505, 
            points: 8.00, /* Reduced from 10 to 8 */
            maxDistance: 22.00, /* Reduced from 25 to 22 */
            spacing: 35.00 /* Increased from 20 to 35 (fewer points) */
        });

        function revealSlideContent(slide) {
            // Staggered Text Entry (Vertical Slide Up)
            const elements = slide.querySelectorAll('.slide-tag, .slide-title, .slide-desc, .btn-container, .countdown-grid, .cal-grid, .contact-grid, .standings-tabs, .standings-wrapper');
            
            gsap.fromTo(elements, 
                { y: 50, opacity: 0 }, 
                { y: 0, opacity: 1, duration: 0.8, stagger: 0.1, ease: "power3.out" }
            );

            // If the slide has split text (characters), stagger them too
            const chars = slide.querySelectorAll('.char');
            if(chars.length > 0) {
                gsap.fromTo(chars, 
                    { y: 20, opacity: 0 },
                    { y: 0, opacity: 1, duration: 0.5, stagger: 0.02, ease: "back.out(1.7)" }
                );
            }

            // Specific Staggers for complex elements
            if(slide.id === 'slide-1') {
                gsap.fromTo(slide.querySelectorAll('.cal-item'), {y: 50, opacity: 0}, {y: 0, opacity: 1, duration: 0.5, stagger: 0.05, ease: "power2.out"}); /* OPTIMIZED: Simpler ease */
            }
            if(slide.id === 'slide-2') {
                 // Standings table animate in
                 gsap.fromTo(slide.querySelectorAll('tr'), {x: -30, opacity: 0}, {x: 0, opacity: 1, duration: 0.4, stagger: 0.05, ease: "power2.out"});
            }
            if(slide.id === 'slide-4') {
                gsap.fromTo(slide.querySelectorAll('.contact-item'), {scale: 0.8, opacity: 0}, {scale: 1, opacity: 1, duration: 0.5, stagger: 0.1, ease: "back.out(1.7)"});
            }
        }

        function gotoSlide(index) {
            if (isAnimating || index === currentIndex) return;
            isAnimating = true;
            let nextIndex = gsap.utils.wrap(0, totalSlides, index);
            const currentSlide = slides[currentIndex];
            const nextSlide = slides[nextIndex];
            
            // Update active link immediately
            updateActiveLink(nextIndex);

            // Prepare next slide
            gsap.set(nextSlide, { zIndex: 20, visibility: 'visible', opacity: 0 });
            
            // ENHANCED TRANSITION: "Fly-Through"
            const tl = gsap.timeline({
                defaults: { ease: "power2.inOut", duration: 1.2 },
                onComplete: () => {
                    gsap.set(currentSlide, { visibility: 'hidden', zIndex: 1, opacity: 0 });
                    currentIndex = nextIndex;
                    isAnimating = false;
                }
            });

            // 1. Current slide "Recedes" (Zooms Out + Fades)
            tl.to(currentSlide, { scale: 0.9, opacity: 0, filter: 'brightness(0.5)' }, 0);

            // 2. Next slide "Approaches" (Zooms In from 1.1 to 1 + Fades In)
            tl.fromTo(nextSlide, 
                { scale: 1.1, opacity: 0, filter: 'brightness(1.5)' }, 
                { scale: 1, opacity: 1, filter: 'brightness(1)' }, 
                "-=0.8" // Overlap significantly for fluid feel
            );
            
            // Trigger Content Reveal slightly later for staggered effect
            setTimeout(() => revealSlideContent(nextSlide), 400);
        }

        // --- Event Listeners ---
        document.getElementById('start-engine-btn').addEventListener('click', () => gotoSlide(1));

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetTab = e.target.dataset.tab;
                if (document.querySelector('.tab-btn.active').dataset.tab === targetTab) return;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                const dView = document.getElementById('view-drivers');
                const cView = document.getElementById('view-constructors');
                const dotdView = document.getElementById('view-dotd');
                
                // Hide all views first
                [dView, cView, dotdView].forEach(v => v.classList.remove('active-view'));

                if (targetTab === 'constructors') { 
                    cView.classList.add('active-view');
                    // Stagger animate cards
                    gsap.fromTo('.constructor-card', {y: 50, opacity: 0}, {y: 0, opacity: 1, stagger: 0.1, duration: 0.5, clearProps: "all", onComplete: initTilt});
                } else if (targetTab === 'dotd') {
                    dotdView.classList.add('active-view');
                    // Stagger panel animation via class-based or CSS triggers for simplicity, 
                    // but we can add a GSAP entry animation for the whole container
                    gsap.fromTo('.dotd-panel', 
                        { width: "10%", opacity: 0 }, 
                        { width: "auto", opacity: 1, duration: 0.8, stagger: 0.05, ease: "power2.out", clearProps: "width" }
                    );
                } else { 
                    dView.classList.add('active-view');
                    // Stagger animate rows
                    gsap.fromTo('tr', {x: -20, opacity: 0}, {x: 0, opacity: 1, stagger: 0.05, duration: 0.4});
                }
            });
        });
        
        // Blink animation for "Live" status
        const style = document.createElement('style');
        style.innerHTML = `@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }`;
        document.head.appendChild(style);

    </script>
</body>
</html>
