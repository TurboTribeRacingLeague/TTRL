<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTRL | Mission Control</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@500;700;800&family=JetBrains+Mono:wght@500;700&family=Orbitron:wght@900&family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <!-- Added for Result Generator -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            prefix: 'tw-', // Prevent tailwind from overriding admin panel styles
            corePlugins: {
                preflight: false, // Disable base reset to protect admin panel styles
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* ================== ADMIN PANEL STYLES ================== */
        :root {
            /* --- GLASSMORPHISM DARK PALETTE --- */
            --bg-body: #080710;      
            --bg-panel: rgba(255, 255, 255, 0.05); /* Very transparent */
            --bg-header: rgba(255, 255, 255, 0.03);
            --sidebar-bg: rgba(255, 255, 255, 0.03);   
            --sidebar-text: #e5e5e5;
            --sidebar-text-active: #ffffff;
            --border-dim: rgba(255, 255, 255, 0.1); /* Subtle white border */
            --border-light: rgba(255, 255, 255, 0.2);
            
            /* Accents remain bright for contrast */
            --accent-cyan: #23a2f6;  
            --accent-red: #ff512f;   
            --accent-green: #10b981; 
            --accent-yellow: #f09819; 
            --accent-purple: #8b5cf6; 
            
            --text-primary: #ffffff;  
            --text-secondary: #e5e5e5; 
            --text-muted: #a0a0a0;     
            
            --font-display: 'Poppins', sans-serif; 
            --font-ui: 'Poppins', sans-serif;
            --font-data: 'JetBrains Mono', monospace;
            
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 72px;
            --header-height: 70px;
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-md: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Glass shadow */
            --shadow-lg: 0 8px 32px 0 rgba(31, 38, 135, 0.5);
            
            --glass-blur: blur(12px);
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            font-family: var(--font-ui); 
            height: 100vh; 
            overflow: hidden; 
            /* Radial pattern removed for glass shapes */
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* BACKGROUND SHAPES (Global) */
        .bg-shape-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; overflow: hidden;
        }
        .bg-shape {
            height: 300px; width: 300px; position: absolute; border-radius: 50%; opacity: 0.6; filter: blur(40px);
        }
        .bg-shape:first-child {
            background: linear-gradient(#1845ad, #23a2f6);
            left: -50px; top: -50px;
        }
        .bg-shape:last-child {
            background: linear-gradient(to right, #ff512f, #f09819);
            right: -50px; bottom: -50px;
        }

        .app-layout { display: flex; height: 100vh; width: 100vw; opacity: 0; transition: opacity 0.5s ease; }
        
        /* SIDEBAR (Glass) */
        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--sidebar-bg); 
            backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border-right: 1px solid var(--border-dim); 
            display: flex; flex-direction: column; flex-shrink: 0; 
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 50; 
            box-shadow: var(--shadow-md); 
        }
        .sidebar.collapsed { width: var(--sidebar-width-collapsed); }
        
        .logo-area { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; border-bottom: 1px solid var(--border-dim); gap: 12px; overflow: hidden; background: rgba(0,0,0,0.1); }
        .logo-img { height: 36px; width: auto; object-fit: contain; }
        .logo-text { font-family: var(--font-display); font-weight: 600; font-size: 1.4rem; letter-spacing: 0.5px; white-space: nowrap; color: #fff; }
        .sidebar.collapsed .logo-text { opacity: 0; pointer-events: none; }
        
        .nav-links { flex: 1; padding: 20px 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .nav-group-label { font-size: 0.7rem; color: rgba(255,255,255,0.4); font-weight: 600; padding: 16px 16px 8px; letter-spacing: 1px; text-transform: uppercase; }
        .sidebar.collapsed .nav-group-label { display: none; }
        
        .nav-btn { display: flex; align-items: center; padding: 12px 16px; color: var(--sidebar-text); text-decoration: none; border-radius: 8px; transition: all 0.2s; cursor: pointer; font-weight: 500; font-size: 0.9rem; position: relative; overflow: hidden; }
        .nav-btn i { width: 24px; text-align: center; font-size: 1.1rem; margin-right: 12px; transition: color 0.2s; }
        .nav-btn span { white-space: nowrap; transition: opacity 0.2s; }
        .sidebar.collapsed .nav-btn span { opacity: 0; width: 0; }
        .sidebar.collapsed .nav-btn i { margin-right: 0; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .nav-btn.active { background: rgba(35, 162, 246, 0.3); color: #fff; border: 1px solid var(--accent-cyan); box-shadow: 0 0 10px rgba(35, 162, 246, 0.2); }
        .nav-btn.active i { color: #fff; }
        
        .user-panel { padding: 20px; border-top: 1px solid var(--border-dim); background: rgba(0,0,0,0.2); }
        .user-panel-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .user-name { font-size: 0.95rem; font-weight: 600; color: #fff; white-space: nowrap; }
        .user-role { font-size: 0.7rem; color: var(--accent-cyan); font-family: var(--font-data); font-weight: 600; background: rgba(35, 162, 246, 0.1); padding: 2px 6px; border-radius: 4px; border:1px solid rgba(35, 162, 246, 0.3); }
        .sidebar.collapsed .user-panel-row { display: none; }
        .sidebar.collapsed .user-panel .btn { justify-content: center; padding: 10px; }
        .sidebar.collapsed .user-panel .btn span { display: none; }
        .sidebar.collapsed .user-panel .btn i { margin: 0; }
        
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* TOP BAR (Glass) */
        .top-bar { 
            height: var(--header-height); 
            border-bottom: 1px solid var(--border-dim); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 32px; 
            background: var(--bg-header); 
            backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            z-index: 40; 
        }
        
        .toggle-sidebar { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .toggle-sidebar:hover { color: var(--accent-cyan); transform: scale(1.1); }
        
        .season-control { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.07); padding: 6px 16px; border-radius: 8px; border: 1px solid var(--border-dim); }
        .season-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .season-input { background: none; border: none; color: #fff; font-family: var(--font-display); font-weight: 600; font-size: 1rem; text-transform: uppercase; width: 180px; text-align: center; }
        .season-input::placeholder { color: rgba(255,255,255,0.3); }
        .season-input:focus { color: var(--accent-cyan); }
        
        .action-cluster { display: flex; gap: 12px; }
        
        /* BUTTONS */
        .btn { 
            background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: #fff; 
            padding: 8px 16px; 
            font-family: var(--font-ui); font-weight: 500; font-size: 0.85rem; 
            cursor: pointer; transition: all 0.2s; border-radius: 5px; 
            display: inline-flex; align-items: center; gap: 8px; 
            backdrop-filter: blur(5px);
        }
        .btn:hover { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); transform: translateY(-1px); }
        
        .btn-primary { background: rgba(35, 162, 246, 0.4); border-color: var(--accent-cyan); color: #fff; }
        .btn-primary:hover { background: rgba(35, 162, 246, 0.6); box-shadow: 0 0 10px rgba(35, 162, 246, 0.4); }
        
        .btn-danger { background: rgba(255, 81, 47, 0.2); border-color: var(--accent-red); color: #ffccc7; }
        .btn-danger:hover { background: rgba(255, 81, 47, 0.4); color: #fff; }
        
        .btn-success { background: rgba(16, 185, 129, 0.2); border-color: var(--accent-green); color: #d1fae5; }
        .btn-success:hover { background: rgba(16, 185, 129, 0.4); color: #fff; }
        
        .workspace { flex: 1; padding: 32px; overflow-y: auto; position: relative; }
        .section { display: none; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* PANELS (Glass) */
        .panel { 
            background: var(--bg-panel); 
            backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-dim); 
            border-radius: 12px; 
            margin-bottom: 24px; 
            position: relative; overflow: hidden; 
            box-shadow: var(--shadow-md); 
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 16px 24px; border-bottom: 1px solid var(--border-dim); }
        .panel-body { padding: 24px; }
        .panel-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .panel-title i { color: var(--accent-cyan); font-size: 1.1rem; }
        
        .dashboard-grid-full { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px; }
        
        /* STAT CARDS (Glass) */
        .stat-card { 
            background: var(--bg-panel); 
            backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-dim); 
            padding: 24px; border-radius: 12px; 
            position: relative; overflow: hidden; 
            transition: transform 0.2s; 
            box-shadow: var(--shadow-md); 
            display: flex; flex-direction: column; justify-content: space-between; 
        }
        .stat-card:hover { transform: translateY(-3px); border-color: rgba(255,255,255,0.3); }
        .stat-icon { position: absolute; right: -10px; top: -10px; font-size: 6rem; opacity: 0.05; transform: rotate(15deg); color: #fff; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .stat-value { font-family: var(--font-display); font-size: 2.5rem; font-weight: 600; color: #fff; line-height: 1; }
        .stat-footer { margin-top: 12px; font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; font-weight: 500; }
        
        /* GRADIENT ACCENTS (Transparent) */
        .card-accent-blue { background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(35, 162, 246, 0.15) 100%); border-top: 2px solid var(--accent-cyan); }
        .card-accent-red { background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255, 81, 47, 0.15) 100%); border-top: 2px solid var(--accent-red); }
        .card-accent-green { background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(16, 185, 129, 0.15) 100%); border-top: 2px solid var(--accent-green); }
        .card-accent-purple { background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(139, 92, 246, 0.15) 100%); border-top: 2px solid var(--accent-purple); }
        
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
        
        /* FORM CONTROLS (Glass) */
        .form-control { 
            width: 100%; 
            background: rgba(255,255,255,0.07); 
            border: 1px solid transparent; 
            color: #fff; 
            padding: 10px 14px; 
            font-size: 0.95rem; 
            border-radius: 5px; 
            transition: all 0.2s; font-weight: 400; 
        }
        .form-control:focus { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        /* Fix for select dropdowns on dark bg */
        option { background: #080710; color: #fff; }
        
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        /* DRIVER CARDS (Glass) */
        .driver-card { 
            background: rgba(255,255,255,0.05); 
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-dim); 
            /* Team color strip instead of full border */
            border-left: 4px solid var(--team-color, #94a3b8);
            border-radius: 8px; 
            padding: 16px 20px; 
            display: flex; align-items: center; justify-content: space-between; 
            transition: all 0.2s; 
            box-shadow: var(--shadow-sm); 
            position: relative; overflow: hidden; height: 100%; 
        }
        .driver-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.1); }
        .driver-info { position: relative; z-index: 2; }
        .driver-info h4 { font-size: 1.1rem; margin: 0; font-weight: 600; color: #fff; }
        .driver-info p { font-size: 0.8rem; color: var(--team-color); filter: brightness(1.2); margin: 4px 0 0; text-transform: uppercase; font-weight: 600; }
        
        .icon-btn { position: relative; z-index: 10; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: 0.2s; }
        .icon-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .icon-btn.delete:hover { background: rgba(255, 81, 47, 0.3); border-color: var(--accent-red); color: #fff; }
        
        .admin-team-logo { width: 32px; height: 32px; object-fit: contain; margin-right: 12px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        .team-strip { width: 4px; height: 100%; position: absolute; left: 0; top: 0; background: var(--team-color, #ccc); }
        
        /* TABLES (Glass) */
        .tech-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; color: #eee; }
        .tech-table th { text-align: left; padding: 16px 20px; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--border-dim); font-weight: 600; letter-spacing: 0.5px; background: rgba(255,255,255,0.02); }
        .tech-table td { padding: 14px 20px; border-bottom: 1px solid var(--border-dim); color: #fff; font-weight: 400; }
        .tech-table tr:hover td { background: rgba(255,255,255,0.05); }
        .tech-table tr:last-child td { border-bottom: none; }
        
        /* CALENDAR CARDS */
        #trackConfigList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .track-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-dim);
            border-radius: 8px;
            padding: 20px;
            position: relative;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 16px;
            transition: transform 0.2s;
        }
        .track-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.08); }
        .track-header { display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border-dim); padding-bottom: 12px; }
        .track-name { font-weight: 600; font-size: 1rem; color: #fff; }
        .track-body { display: flex; flex-direction: column; gap: 8px; }
        .track-checkbox { transform: scale(1.3); accent-color: var(--accent-cyan); background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-box { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2); 
            width: 90%; max-width: 480px; padding: 32px; 
            border-radius: 16px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            text-align: center; color: #fff;
        }
        .modal-title { font-size: 1.5rem; color: #fff; margin-bottom: 12px; font-weight: 600; }
        
        .toast { position: fixed; bottom: 30px; right: 30px; background: rgba(16, 185, 129, 0.2); backdrop-filter: blur(10px); border: 1px solid var(--accent-green); border-left: 5px solid var(--accent-green); padding: 16px 24px; color: #ffffff; transform: translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000; font-family: var(--font-ui); font-weight: 600; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast i { color: var(--accent-green); font-size: 1.1rem; }
        
        /* --- GLASSMORPHISM LOGIN STYLES --- */
        #login-screen {
            position: fixed;
            inset: 0;
            z-index: 999;
            background-color: #080710;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Poppins', sans-serif;
        }
        #login-screen .background { width: 430px; height: 520px; position: absolute; transform: translate(-50%,-50%); left: 50%; top: 50%; }
        #login-screen .shape { height: 200px; width: 200px; position: absolute; border-radius: 50%; }
        #login-screen .shape:first-child { background: linear-gradient(#1845ad, #23a2f6); left: -80px; top: -80px; }
        #login-screen .shape:last-child { background: linear-gradient(to right, #ff512f, #f09819); right: -30px; bottom: -80px; }
        #login-screen form {
            height: 520px; width: 400px; background-color: rgba(255,255,255,0.13);
            position: absolute; transform: translate(-50%,-50%); top: 50%; left: 50%;
            border-radius: 10px; backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 40px rgba(8,7,16,0.6); padding: 50px 35px;
        }
        #login-screen form * { font-family: 'Poppins', sans-serif; color: #ffffff; letter-spacing: 0.5px; outline: none; border: none; }
        #login-screen form h3 { font-size: 32px; font-weight: 500; line-height: 42px; text-align: center; margin-bottom: 20px; }
        #login-screen label { display: block; margin-top: 30px; font-size: 16px; font-weight: 500; }
        #login-screen input { display: block; height: 50px; width: 100%; background-color: rgba(255,255,255,0.07); border-radius: 3px; padding: 0 10px; margin-top: 8px; font-size: 14px; font-weight: 300; }
        #login-screen ::placeholder { color: #e5e5e5; }
        #login-screen button { margin-top: 50px; width: 100%; background-color: #ffffff; color: #080710; padding: 15px 0; font-size: 18px; font-weight: 600; border-radius: 5px; cursor: pointer; }
        #login-screen .social { margin-top: 30px; display: flex; justify-content: center; }
        #login-screen .social div { width: 100%; border-radius: 3px; padding: 5px 10px 10px 5px; background-color: rgba(255,255,255,0.27); color: #eaf0fb; text-align: center; cursor: pointer; transition: background 0.3s; }
        #login-screen .social div:hover { background-color: rgba(255,255,255,0.47); }

        @media (max-width: 900px) {
            .app-layout { flex-direction: column; height: auto; min-height: 100vh; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border-dim); }
            .sidebar.collapsed .nav-links { display: none; }
            .main-wrapper { height: auto; overflow: visible; }
            .top-bar { padding: 0 20px; flex-direction: column; height: auto; padding-bottom: 15px; gap: 12px; }
            .action-cluster { flex-wrap: wrap; justify-content: center; }
            .nav-links { flex-direction: row; overflow-x: auto; padding: 12px; }
            .nav-btn span { display: none; } 
            .nav-btn i { margin: 0; font-size: 1.2rem; }
            .workspace { padding: 20px; }
        }

        /* ================== RESULT GENERATOR SPECIFIC STYLES ================== */
        /* Namespaced with 'rg_' to prevent conflicts with admin panel */
        #rg_result-card {
            width: 1280px; height: 720px;
            background-image: url('https://raw.githubusercontent.com/HARISHWINNER/TTRL-RESOURCES/1de52755d3c67ebb0917c0fcc67ee3ed7bee1a4a/Background/race_res_bg.png'); 
            background-size: cover; background-position: center; position: relative;
            color: white; overflow: hidden; flex-shrink: 0;
            font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased;
        }
        #rg_preview-title {
            position: absolute; top: 85px; left: 30px; /* Adjusted: Moved down from 71px */
            font-family: 'Orbitron', sans-serif; font-size: 33px; font-weight: 900;
            white-space: nowrap; letter-spacing: 0.5px; margin: 0; line-height: 1;
        }
        #rg_results-table-container { position: absolute; top: 180px; left: 0; width: 100%; height: 490px; overflow: hidden; }
        :root { --rg-row-height: 24.5px; }
        #rg_preview-race-body tr { display: block; position: relative; height: var(--rg-row-height); line-height: var(--rg-row-height); font-size: 11px; }
        #rg_preview-race-body td {
            position: absolute; top: 0; display: flex; align-items: center;
            height: var(--rg-row-height); font-size: 11px; white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; font-weight: 500; color: #f0f0f0; letter-spacing: 0.25px;
            padding: 0 4px; box-sizing: border-box;
        }
        #rg_preview-race-body td.rg_cell-center { justify-content: center; text-align: center; }
        
        /* UPDATED: Moves team logos DOWN slightly (2px) */
        #rg_preview-race-body .rg_td-team img.rg_team-logo {
            height: 14px; margin-right: 6px; object-fit: contain; display: inline-block; vertical-align: middle;
            transform: translateY(2px); -webkit-transform: translateY(2px);
        }
        #rg_winner-logo-box { position: absolute; top: 262px; left: 947px; width: 298px; height: 196px; display: flex; justify-content: center; align-items: center; }
        #rg_winner-logo-box img { height: 140px; object-fit: contain; display:block; }
        
        /* UPDATED: Moves winner details (from 475px back to 462px) */
        #rg_winner-details-box { position: absolute; top: 462px; left: 946px; width: 299px; height: 85px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #rg_winner-name { font-size: 24px; font-weight: 900; color: #eee; margin: 0; line-height: 28px; height: 28px; white-space: nowrap; }
        #rg_winner-team { font-size: 18px; font-weight: 700; color: #aaa; margin: 0; line-height: 22px; height: 22px; white-space: nowrap; }
        
        /* UPDATED: Moves pole position timing to 677px as requested */
        #rg_footer-awards { position: absolute; top: 677px; left: 552px; font-size: 14px; font-weight: 700; color: #7B5ED7; margin: 0; line-height: 20px; height: 20px; white-space: nowrap; }
        #rg_preview-pp { display: inline-block; line-height: 20px; height: 20px; }
        .rg_scrollbar::-webkit-scrollbar { width: 6px; }
        .rg_scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .rg_scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .rg_scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* ANALYTICS SPECIFIC STYLES */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 100px 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
        }
        .comp-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-dim);
            color: #fff;
        }
        .vs-badge {
            background: var(--text-primary);
            color: #080710;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            margin: 0 auto;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-dim);
            font-size: 0.9rem;
            color: #e5e5e5;
        }
    </style>
</head>
<body>
    <!-- BACKGROUND SHAPES -->
    <div class="bg-shape-container">
        <div class="bg-shape"></div>
        <div class="bg-shape"></div>
    </div>

    <div id="login-screen">
        <div class="background">
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
        <form onsubmit="event.preventDefault();">
            <h3>Mission Control</h3>

            <label for="loginEmail">Operator ID</label>
            <input type="text" placeholder="Email or Phone" id="loginEmail">

            <label for="loginPass">Access Key</label>
            <input type="password" placeholder="Password" id="loginPass">

            <button type="button" onclick="window.checkLogin()">Log In</button>
            
            <div class="social">
              <div class="go" onclick="window.loginWithGoogle()"><i class="fab fa-google"></i>  Google</div>
            </div>
            
            <div id="login-msg" style="margin-top: 15px; text-align: center; font-size: 14px; color: #ff512f;"></div>
            <div id="script-status" style="margin-top: 10px; text-align: center; font-size: 12px; color: #23a2f6; display:none;">SYSTEM ONLINE</div>
        </form>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div class="app-layout" id="main-interface" style="display:none;">
        <nav class="sidebar" id="appSidebar">
            <div class="logo-area"><img src="https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/image.png" class="logo-img" alt="Logo"><div class="logo-text">PITWALL</div></div>
            <div class="nav-links">
                <div class="nav-group-label">OVERVIEW</div>
                <a class="nav-btn active" onclick="window.switchTab('dashboard')"><i class="fas fa-gauge-high"></i> <span>DASHBOARD</span></a>
                <a class="nav-btn" onclick="window.switchTab('live-view')"><i class="fas fa-tower-broadcast"></i> <span>LIVE TELEMETRY</span></a>
                <a class="nav-btn" onclick="window.switchTab('driver-stats')"><i class="fas fa-chart-pie"></i> <span>ANALYTICS</span></a>
                <div class="nav-group-label">OPERATIONS</div>
                <a class="nav-btn" onclick="window.switchTab('season-setup')"><i class="fas fa-calendar-days"></i> <span>CALENDAR EDITOR</span></a>
                <a class="nav-btn" onclick="window.switchTab('manage-drivers')"><i class="fas fa-user-plus"></i> <span>DRIVER ONBOARD</span></a>
                <a class="nav-btn" onclick="window.switchTab('driver-editor')"><i class="fas fa-user-pen"></i> <span>DRIVER EDITOR</span></a>
                <a class="nav-btn" onclick="window.switchTab('race-director')"><i class="fas fa-flag-checkered"></i> <span>RACE EDITOR</span></a>
                <!-- Added Result Generator Link -->
                <div class="nav-group-label">TOOLS</div>
                <a class="nav-btn" onclick="window.switchTab('result-generator')"><i class="fas fa-image"></i> <span>RESULT GEN</span></a>
            </div>
            <div class="user-panel"><div class="user-panel-row"><div class="user-name" id="userName">OPERATOR</div><div class="user-role">ADMIN</div></div><button class="btn btn-danger" onclick="window.logout()" style="width: 100%; justify-content: center; font-size: 0.75rem;"><i class="fas fa-power-off"></i> <span>DISCONNECT</span></button></div>
        </nav>

        <div class="main-wrapper">
            <header class="top-bar">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="toggle-sidebar" onclick="window.toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <!-- UPDATED SEASON CONTROL -->
                    <div class="season-control">
                        <span class="season-label">ACTIVE SEASON:</span>
                        <!-- Input WITHOUT list attribute, purely for new creation or manual entry -->
                        <input type="text" id="seasonInput" class="season-input" placeholder="ENTER ID TO CREATE/LOAD" onchange="window.changeSeason()">
                        
                        <!-- Button to force reload the specific season -->
                        <button class="icon-btn" onclick="window.changeSeason()" title="Load Season">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        
                        <!-- Button to refresh the list of available seasons -->
                        <button class="icon-btn" onclick="window.refreshSeasonList()" title="Refresh Season List" style="margin-left:5px; opacity:0.7;">
                            <i class="fas fa-sync-alt"></i>
                        </button>

                        <!-- NEW: DELETE BUTTON -->
                        <button class="icon-btn delete" onclick="window.deleteCurrentSeason()" title="Delete Current Season" style="margin-left:5px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div id="seasonStatusMsg" style="font-family: var(--font-data); font-size: 0.75rem; color: var(--accent-green); font-weight:700;"></div>
                </div>

                <div class="action-cluster">
                    <button class="btn" onclick="window.openMigrationModal()"><i class="fas fa-exchange-alt"></i> MIGRATE</button>
                    <button class="btn" onclick="window.triggerImport()"><i class="fas fa-file-import"></i> IMPORT CSV</button>
                    <button class="btn" onclick="window.exportData()"><i class="fas fa-download"></i> BACKUP</button>
                    <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="window.handleFileSelect(this)">
                </div>
            </header>

            <div class="workspace">
                <div id="dashboard" class="section active">
                    <div class="panel-header" style="border:none; margin-bottom: 10px; background: transparent;"><div><h2 style="font-family:var(--font-display); font-weight:800; font-size:1.8rem; color:var(--text-primary); margin:0;">MISSION OVERVIEW</h2><div style="font-family:var(--font-ui); color:var(--text-secondary); font-size:0.9rem;" id="dashNextDate">SEASON ACTIVE</div></div></div>
                    
                    <!-- ADDED: Available Seasons List Panel -->
                    <div class="panel" style="margin-bottom: 24px;">
                        <div class="panel-header"><div class="panel-title"><i class="fas fa-list"></i> AVAILABLE SEASONS</div></div>
                        <div class="panel-body">
                            <div id="dashSeasonsBody" style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <!-- Populated by JS -->
                                <span style="color:var(--text-muted); font-size:0.9rem;">Fetching seasons...</span>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid-full">
                        <div class="stat-card card-accent-blue"><i class="fas fa-users stat-icon"></i><div class="stat-label">GRID SIZE</div><div class="stat-value" id="dashDriverCount">0</div><div class="stat-footer positive"><i class="fas fa-check"></i> Active Drivers</div></div>
                        <div class="stat-card card-accent-green"><i class="fas fa-map-location-dot stat-icon"></i><div class="stat-label">CALENDAR</div><div class="stat-value" id="dashTrackCount">0</div><div class="stat-footer"><i class="fas fa-flag"></i> Scheduled Races</div></div>
                        <div class="stat-card card-accent-purple"><i class="fas fa-trophy stat-icon" style="color: var(--accent-purple); opacity: 0.1;"></i><div class="stat-label">LEADER</div><div class="stat-value" id="dashLeader" style="font-size:1.5rem;">--</div><div class="stat-footer highlight" id="dashLeaderPts" style="color:var(--accent-purple);">0 PTS</div></div>
                        <div class="stat-card card-accent-red"><i class="fas fa-cogs stat-icon" style="color: var(--accent-red); opacity: 0.1;"></i><div class="stat-label">TOP TEAM</div><div class="stat-value" id="dashTeamLeader" style="font-size:1.5rem;">--</div><div class="stat-footer highlight" style="color: var(--accent-red);" id="dashTeamPts">0 PTS</div></div>
                    </div>
                    
                    <!-- UPDATED DASHBOARD CARDS ROW -->
                    <div class="dashboard-grid-full" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="stat-card" style="background:var(--bg-panel); border-left: 4px solid var(--accent-yellow);">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <div style="font-size:2.5rem; color:var(--accent-yellow);"><i class="fas fa-trophy"></i></div>
                                <div>
                                    <div class="stat-label" style="margin:0;">MOST WINS</div>
                                    <div style="font-size:1.2rem; font-weight:800; color:var(--text-primary);" id="dashMostWins">--</div>
                                    <div style="font-size:0.75rem; color:var(--text-muted); font-weight:700;" id="dashMostWinsCount">0 WINS</div>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="background:var(--bg-panel); border-left: 4px solid var(--accent-cyan);">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <div style="font-size:2.5rem; color:var(--accent-cyan);"><i class="fas fa-road"></i></div>
                                <div>
                                    <div class="stat-label" style="margin:0;">DRIVER GAP</div>
                                    <div style="font-size:1.2rem; font-weight:800; color:var(--text-primary);" id="dashDriverGap">0</div>
                                    <div style="font-size:0.75rem; color:var(--text-muted); font-weight:700;">POINTS (P1-P2)</div>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="background:var(--bg-panel); border-left: 4px solid var(--accent-red);">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <div style="font-size:2.5rem; color:var(--accent-red);"><i class="fas fa-people-group"></i></div>
                                <div>
                                    <div class="stat-label" style="margin:0;">TEAM GAP</div>
                                    <div style="font-size:1.2rem; font-weight:800; color:var(--text-primary);" id="dashTeamGap">0</div>
                                    <div style="font-size:0.75rem; color:var(--text-muted); font-weight:700;">POINTS (P1-P2)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid-full" style="grid-template-columns: 2fr 1fr;">
                        <div class="panel">
                            <div class="panel-header"><div class="panel-title"><i class="fas fa-chart-line"></i> SEASON PROGRESS</div></div>
                            <div class="panel-body">
                                <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:12px;"><div class="stat-value" id="dashProgressPct" style="font-size:3rem;">0%</div><div class="stat-footer" id="dashRacesDone" style="font-size:1rem;">0 / 0 RACES</div></div>
                                <div style="width:100%; height:12px; background:rgba(255,255,255,0.1); border-radius:6px; overflow:hidden;"><div id="dashProgressBar" style="width:0%; height:100%; background:var(--accent-green); transition: width 1s ease;"></div></div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:30px;">
                                    <div class="stat-card" style="box-shadow:none; border:1px solid var(--border-dim); background:rgba(255,255,255,0.05);"><div class="stat-label">NEXT EVENT</div><div class="stat-value" id="dashNextRace" style="font-size: 1.2rem;">--</div><div class="stat-footer"><i class="far fa-clock"></i> Scheduled</div></div>
                                    <div class="stat-card" style="box-shadow:none; border:1px solid var(--border-dim); background:rgba(255,255,255,0.05);"><div class="stat-label">LATEST VICTOR</div><div class="stat-value" id="dashLastWinner" style="font-size: 1.2rem;">--</div><div class="stat-footer" id="dashLastGP">WAITING</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="panel" style="display:flex; flex-direction:column; min-height:400px;"><div class="panel-header"><div class="panel-title"><i class="far fa-calendar-alt"></i> SCHEDULE</div></div><div id="dashCalendarList" style="flex:1; overflow-y: auto; padding:0 24px 24px;"></div></div>
                    </div>
                </div>

                <div id="season-setup" class="section">
                    <div class="panel"><div class="panel-header"><div class="panel-title"><i class="fas fa-calendar-days"></i> CALENDAR EDITOR</div><div class="action-cluster"><button class="btn" onclick="window.toggleTrackSelectAll()">SELECT ALL</button><button class="btn btn-danger" onclick="window.deleteSelectedTracks()">DELETE</button></div></div><div class="panel-body"><div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 20px; margin-bottom: 25px; align-items: end;"><div><label class="input-label">SELECT CIRCUIT</label><select id="trackSelector" class="form-control"><option>LOADING...</option></select></div><div><label class="input-label">RACE DATE</label><input type="date" id="newTrackDate" class="form-control"></div><button class="btn btn-primary" onclick="window.addTrackConfig()" style="height: 46px;"><i class="fas fa-plus"></i></button></div><div id="trackConfigList"></div></div></div>
                </div>

                <div id="manage-drivers" class="section">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-user-plus"></i> DRIVER ONBOARDING</div>
                            <div class="action-cluster">
                                <button class="btn" onclick="window.toggleSelectAll()">SELECT ALL</button>
                                <button class="btn btn-danger" onclick="window.deleteSelectedDrivers()">DELETE SELECTED</button>
                            </div>
                        </div>
                        <div class="panel-body">
                            <div style="margin-bottom:24px; display:flex; gap:12px;">
                                <input type="text" id="newDriverName" class="form-control" placeholder="DRIVER NAME">
                                <select id="newDriverTeam" class="form-control"></select>
                                <button class="btn btn-primary" onclick="window.registerDriver()">ADD</button>
                            </div>
                            
                            <h3 class="panel-title" style="margin: 20px 0 15px; border-bottom: 1px solid var(--border-dim); padding-bottom: 10px;">THE GRID</h3>
                            <div id="driverListFull" class="data-grid"></div>
                            
                            <h3 class="panel-title" style="margin: 30px 0 15px; border-bottom: 1px solid var(--border-dim); padding-bottom: 10px; color: var(--text-secondary);">RESERVE POOL</h3>
                            <div id="driverListReserve" class="data-grid"></div>
                        </div>
                    </div>
                </div>

                <div id="driver-editor" class="section">
                    <div class="panel"><div class="panel-header"><div class="panel-title"><i class="fas fa-user-pen"></i> INDIVIDUAL ADJUSTMENT</div></div><div class="panel-body">
                        <div id="editorSelectionContainer">
                            <h3 class="panel-title" style="margin: 0 0 15px; border-bottom: 1px solid var(--border-dim); padding-bottom: 10px;">THE GRID</h3>
                            <div id="editorGridFull" class="data-grid"></div>
                            
                            <h3 class="panel-title" style="margin: 30px 0 15px; border-bottom: 1px solid var(--border-dim); padding-bottom: 10px; color: var(--text-secondary);">RESERVE POOL</h3>
                            <div id="editorGridReserve" class="data-grid"></div>
                        </div>
                        <div id="editor-area" style="display:none;"><div style="display:flex; align-items:center; gap: 20px; margin-bottom: 30px;"><button class="btn" onclick="window.closeDriverEditor()"><i class="fas fa-arrow-left"></i> BACK</button><div class="input-group" style="margin:0; flex:1; display:flex; gap:10px;"><input type="text" id="editorDriverNameInput" class="form-control" style="font-size:1.5rem; font-weight:800; color:var(--text-primary); height:auto; padding:5px 10px;"><button class="btn btn-primary" onclick="window.updateDriverName()">RENAME</button></div></div><div style="max-width: 400px; margin-bottom: 30px;"><label class="input-label">MAIN TEAM CONTRACT</label><select id="editorMainTeam" class="form-control" onchange="window.updateMainTeam()"></select><input type="hidden" id="editorDriverIdHidden"></div><div id="trackGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;"></div><div style="margin-top: 32px; padding: 24px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-dim); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;"><div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">TOTAL: <span id="calculatedTotal" style="color: var(--accent-cyan);">0</span> PTS</div><button class="btn btn-primary" onclick="window.saveAllChanges()">SAVE CHANGES</button></div></div></div></div>
                </div>

                <div id="race-director" class="section">
                    <div class="panel">
                        <div class="panel-header"><div class="panel-title"><i class="fas fa-flag-checkered"></i> RACE EDITOR</div></div>
                        <div class="panel-body">
                            <div style="max-width: 400px; margin-bottom: 30px;">
                                <label class="input-label">SELECT EVENT TO GRADE</label>
                                <select id="raceDirectorTrackSelect" class="form-control" onchange="window.loadRaceGrid()"><option>Loading...</option></select>
                            </div>
                            <div id="raceDirectorGrid" style="display:none;">
                                <div id="raceInputsContainer">
                                    <h3 class="panel-title" style="margin: 0 0 15px; border-bottom: 1px solid var(--border-dim); padding-bottom: 10px;">THE GRID</h3>
                                    <div class="data-grid" id="raceGridFull"></div>
                                    
                                    <h3 class="panel-title" style="margin: 30px 0 15px; border-bottom: 1px solid var(--border-dim); padding-bottom: 10px; color: var(--text-secondary);">RESERVES</h3>
                                    <div class="data-grid" id="raceGridReserve"></div>
                                </div>
                                <div style="margin-top: 30px; border-top: 1px solid var(--border-dim); padding-top: 24px; text-align: right;">
                                    <button class="btn btn-success" onclick="window.saveRaceResults()"><i class="fas fa-save"></i> COMMIT RESULTS</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="live-view" class="section">
                    <!-- REMOVED FIXED GRID COLUMNS TO FIX VISIBILITY -->
                    <div class="dashboard-grid-full">
                        <div class="panel"><div class="panel-header"><div class="panel-title" style="color: var(--accent-cyan);"><i class="fas fa-trophy"></i> DRIVERS CHAMPIONSHIP</div></div><div class="panel-body"><table class="tech-table"><thead><tr><th>POS</th><th>DRIVER</th><th style="text-align:right;">PTS</th></tr></thead><tbody id="liveDriversBody"></tbody></table></div></div>
                        <div class="panel"><div class="panel-header"><div class="panel-title" style="color: var(--accent-red);"><i class="fas fa-wrench"></i> CONSTRUCTORS CHAMPIONSHIP</div></div><div class="panel-body"><table class="tech-table"><thead><tr><th>POS</th><th>TEAM</th><th style="text-align:right;">PTS</th></tr></thead><tbody id="liveConstructorsBody"></tbody></table></div></div>
                    </div>
                </div>

                <!-- UPDATED ANALYTICS SECTION -->
                <div id="driver-stats" class="section">
                    <div class="panel">
                        <div class="panel-header"><div class="panel-title"><i class="fas fa-chart-line"></i> PERFORMANCE ANALYTICS</div></div>
                        <div class="panel-body">
                            <!-- Controls -->
                            <div style="display:flex; gap:15px; margin-bottom: 25px; flex-wrap:wrap;">
                                <select id="statsMode" class="form-control" style="width:auto; font-weight:bold;" onchange="window.toggleStatsMode()">
                                    <option value="individual">INDIVIDUAL ANALYSIS</option>
                                    <option value="1v1">DRIVER HEAD-TO-HEAD</option>
                                    <option value="team">TEAM BATTLE</option>
                                </select>
                                
                                <div id="sel-individual" class="stats-selector">
                                    <select id="statsDriverSelect" class="form-control" onchange="window.renderStats()"></select>
                                </div>
                                
                                <div id="sel-1v1" class="stats-selector" style="display:none; gap:10px;">
                                    <select id="statsDriverA" class="form-control" onchange="window.renderStats()"></select>
                                    <span style="align-self:center; font-weight:800; color:var(--text-muted);">VS</span>
                                    <select id="statsDriverB" class="form-control" onchange="window.renderStats()"></select>
                                </div>

                                <div id="sel-team" class="stats-selector" style="display:none; gap:10px;">
                                    <select id="statsTeamA" class="form-control" onchange="window.renderStats()"></select>
                                    <span style="align-self:center; font-weight:800; color:var(--text-muted);">VS</span>
                                    <select id="statsTeamB" class="form-control" onchange="window.renderStats()"></select>
                                </div>
                            </div>

                            <!-- Content Area -->
                            <div id="statsContent">
                                <!-- Default Content (Individual) - Hidden by default, populated by JS -->
                                <div id="statsDisplay" style="display:none;">
                                    <div style="display:flex; justify-content:space-between; align-items: flex-end; margin-bottom: 32px;"><div><h1 id="statsDriverName" style="font-family: var(--font-display); font-size: 2.5rem; margin:0; font-weight:800; color:var(--text-primary);">NAME</h1><div id="statsTeamName" style="color: var(--accent-cyan); font-family: var(--font-data); font-weight:600;">TEAM</div></div><div class="stat-value" id="statPoints" style="color: var(--accent-yellow);">0 <span style="font-size: 1.2rem; color: var(--text-secondary);">PTS</span></div></div><div class="dashboard-grid-full" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 32px;"><div class="stat-card" style="padding: 16px;"><div class="stat-label">WINS</div><div class="stat-value" id="statWins">0</div></div><div class="stat-card" style="padding: 16px;"><div class="stat-label">PODIUMS</div><div class="stat-value" id="statPodiums">0</div></div><div class="stat-card" style="padding: 16px;"><div class="stat-label">AVG FINISH</div><div class="stat-value" id="statAvg">0</div></div><div class="stat-card" style="padding: 16px;"><div class="stat-label">CONSISTENCY</div><div class="stat-value" id="statConsistency">0</div></div></div><div class="dashboard-grid-full" style="grid-template-columns: 1fr 1fr; margin-bottom: 32px;"><div class="panel" style="margin:0; min-height: 350px;"><div class="panel-header"><div class="panel-title" style="font-size: 0.95rem;">CUMULATIVE POINTS</div></div><div class="panel-body"><div style="position: relative; height: 300px; width: 100%;"><canvas id="pointsChart"></canvas></div></div></div><div class="panel" style="margin:0; min-height: 350px;"><div class="panel-header"><div class="panel-title" style="font-size: 0.95rem;">RACE RESULTS</div></div><div class="panel-body"><div style="position: relative; height: 300px; width: 100%;"><canvas id="barChart"></canvas></div></div></div></div><div class="panel-title" style="margin-bottom:15px;">SEASON HISTORY</div><table class="tech-table"><thead><tr><th>TRACK</th><th>POS</th><th>TEAM</th><th style="text-align:right;">PTS</th></tr></thead><tbody id="statsHistoryBody"></tbody></table>
                                </div>
                                <!-- Comparison Content Container -->
                                <div id="comparisonDisplay" style="display:none;"></div>
                                <div id="emptyStats" style="text-align:center; color:var(--text-muted); padding:40px; background: rgba(255,255,255,0.03); border-radius: 8px;">SELECT DATA TO ANALYZE</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="import-preview" class="section">
                    <div class="panel"><div class="panel-header"><div class="panel-title" style="color: var(--accent-green);">IMPORT PREVIEW</div></div><div class="panel-body"><div style="margin-bottom: 24px; font-family: var(--font-data);">DETECTED TRACKS: <span id="detectedTracksList" style="color: var(--accent-green); font-weight:700;"></span></div><div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-dim); margin-bottom: 24px;"><table class="tech-table"><thead><tr><th>DRIVER</th><th>TEAM</th><th>PTS</th><th>STATUS</th></tr></thead><tbody id="importTableBody"></tbody></table></div><div class="action-cluster" style="justify-content: flex-end;"><button class="btn" onclick="window.cancelImport()">CANCEL</button><button class="btn btn-success" onclick="window.commitImport()">CONFIRM IMPORT</button></div></div></div>
                </div>

                <!-- ADDED RESULT GENERATOR SECTION -->
                <div id="result-generator" class="section">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title"><i class="fas fa-image"></i> RESULT IMAGE GENERATOR</div>
                        </div>
                        <div class="panel-body">
                            <!-- INTEGRATED GENERATOR CONTAINER -->
                            <!-- CHANGED LAYOUT: Vertical Stack (tw-flex-col) and Removed xl:tw-flex-row -->
                            <div id="rg_container" class="tw-w-full tw-bg-gray-900 tw-text-white tw-font-sans tw-p-4 tw-rounded-xl">
                                <div class="tw-flex tw-flex-col tw-gap-6 tw-p-4">
                                    
                                    <!-- GENERATOR CONTROLS (Full Width Top) -->
                                    <!-- Changed width to tw-w-full and removed xl width restrictions -->
                                    <div class="tw-w-full tw-bg-gray-800 tw-p-5 tw-rounded-xl tw-shadow-lg tw-border tw-border-gray-700 tw-h-fit">
                                        <div class="tw-mb-6">
                                            <h3 class="tw-text-lg tw-font-bold tw-text-red-500 tw-mb-3 tw-border-b tw-border-gray-700 tw-pb-1">Event Details</h3>
                                            <div class="tw-space-y-3">
                                                <input type="text" id="rg_leagueName" value="TTRL SEASON 1" class="tw-w-full tw-bg-gray-700 tw-text-white tw-p-2 tw-rounded tw-text-sm tw-focus:ring-1 tw-focus:ring-red-500 tw-outline-none" placeholder="League Name">
                                                <input type="text" id="rg_trackName" value="(TRACK NAME) GP 2025" class="tw-w-full tw-bg-gray-700 tw-text-white tw-p-2 tw-rounded tw-text-sm tw-focus:ring-1 tw-focus:ring-red-500 tw-outline-none" placeholder="Track & Year">
                                            </div>
                                        </div>
                                        <div class="tw-mb-6">
                                            <h3 class="tw-text-lg tw-font-bold tw-text-red-500 tw-mb-3 tw-border-b tw-border-gray-700 tw-pb-1">Pole Position</h3>
                                            <div class="tw-grid tw-grid-cols-3 tw-gap-2">
                                                <select id="rg_pp_driver" class="tw-bg-gray-700 tw-text-white tw-p-2 tw-rounded tw-text-xs tw-uppercase tw-outline-none"></select>
                                                <select id="rg_pp_team" class="tw-bg-gray-700 tw-text-white tw-p-2 tw-rounded tw-text-xs tw-uppercase tw-outline-none"></select>
                                                <input type="text" id="rg_pp_time" placeholder="Time" value="1:10.123" class="tw-bg-gray-700 tw-text-white tw-p-2 tw-rounded tw-text-xs tw-text-center tw-outline-none">
                                            </div>
                                        </div>
                                        <div class="tw-mb-6">
                                            <h3 class="tw-text-lg tw-font-bold tw-text-red-500 tw-mb-3 tw-border-b tw-border-gray-700 tw-pb-1">Standings (Top 20)</h3>
                                            <div class="tw-grid tw-grid-cols-12 tw-gap-1 tw-text-[10px] tw-text-gray-400 tw-mb-2 tw-px-1 tw-font-bold tw-uppercase tw-tracking-wider tw-text-center">
                                                <span class="tw-col-span-1">#</span>
                                                <span class="tw-col-span-3 tw-text-left tw-pl-1">Driver</span>
                                                <span class="tw-col-span-2">Team</span>
                                                <span class="tw-col-span-1">Grid</span>
                                                <span class="tw-col-span-1">Stop</span>
                                                <span class="tw-col-span-2">Time</span>
                                                <span class="tw-col-span-1">Fast</span>
                                                <span class="tw-col-span-1">Pts</span>
                                            </div>
                                            <!-- REMOVED SCROLLBAR AND HEIGHT LIMIT -->
                                            <div id="rg_race-inputs" class="tw-space-y-1 tw-pr-1"></div>
                                        </div>
                                        <div class="tw-flex tw-flex-col tw-gap-3 tw-pt-2 tw-border-t tw-border-gray-700">
                                            <div class="tw-flex tw-gap-2">
                                                <button id="rg_downloadBtn" class="tw-flex-1 tw-bg-red-600 hover:tw-bg-red-700 tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded tw-transition-all tw-text-sm tw-uppercase tw-tracking-wide tw-shadow-lg tw-border-none tw-cursor-pointer">
                                                    <i class="fas fa-download tw-mr-2"></i>Download
                                                </button>
                                                <button id="rg_resetBtn" class="tw-bg-gray-600 hover:tw-bg-gray-500 tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded tw-transition-all tw-text-sm tw-border-none tw-cursor-pointer">Reset</button>
                                            </div>
                                            <label for="rg_importFile" class="tw-flex tw-items-center tw-justify-center tw-w-full tw-bg-blue-600 hover:tw-bg-blue-700 tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded tw-cursor-pointer tw-transition-all tw-text-sm tw-uppercase tw-tracking-wide">
                                                Import Results
                                            </label>
                                            <input type="file" id="rg_importFile" class="tw-hidden" accept=".csv">
                                        </div>
                                    </div>

                                    <!-- GENERATOR PREVIEW (Full Width Bottom) -->
                                    <div class="tw-w-full">
                                        <div class="tw-bg-gray-800 tw-p-1 tw-rounded-xl tw-shadow-lg tw-border tw-border-gray-700 tw-overflow-x-auto">
                                            <div class="tw-min-w-max tw-p-4">
                                                <div id="rg_result-card">
                                                    <p id="rg_preview-title" class="f1-font-black">TTRL SEASON 1 (TRACK NAME) GP 2025</p>
                                                    <div id="rg_results-table-container">
                                                        <table class="tw-w-full tw-h-full tw-border-collapse"><tbody id="rg_preview-race-body"></tbody></table>
                                                    </div>
                                                    <div id="rg_winner-logo-box"><img id="rg_winner-logo-placeholder" src="https://placehold.co/200x80/21202e/ffffff?text=TEAM+LOGO" alt="Team logo"></div>
                                                    <div id="rg_winner-details-box"><p id="rg_winner-name"></p><p id="rg_winner-team"></p></div>
                                                    <div id="rg_footer-awards"><span id="rg_preview-pp"></span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="color: var(--accent-red);">CONFIRM ACTION</div>
            <p id="modalMessage" style="color: var(--text-secondary); margin-bottom: 28px;">Are you sure?</p>
            <div style="display: flex; gap: 16px; justify-content: center;">
                <button id="btnConfirmYes" class="btn btn-danger">PROCEED</button>
                <button id="btnConfirmNo" onclick="window.closeModal()" class="btn">CANCEL</button>
            </div>
        </div>
    </div>
    <div id="migrationModal" class="modal-overlay"><div class="modal-box" style="border-top: 4px solid var(--accent-cyan);"><div class="modal-title" style="color: var(--accent-cyan);">DATA MIGRATION</div><p style="color: var(--text-secondary); margin-bottom: 24px;">Transfer data between seasons.</p><div style="text-align: left; margin-bottom: 16px;"><label class="input-label">SOURCE (COPY FROM)</label><input type="text" id="migrateSource" class="form-control" placeholder="e.g. season_1"></div><div style="text-align: left; margin-bottom: 24px;"><label class="input-label">TARGET (PASTE TO)</label><input type="text" id="migrateTarget" class="form-control" placeholder="e.g. season_2"></div><div style="text-align: left; margin-bottom: 28px; display: flex; align-items: center; gap: 12px;"><input type="checkbox" id="migrateDelete"><label for="migrateDelete" style="font-size: 0.85rem; color: var(--text-primary); font-weight:600;">DELETE SOURCE AFTER COPY</label></div><div style="display: flex; gap: 16px; justify-content: center;"><button onclick="window.performMigration()" class="btn btn-primary">TRANSFER</button><button onclick="document.getElementById('migrationModal').style.display='none'" class="btn">CANCEL</button></div><div id="migrationStatus" style="margin-top: 16px; color: var(--accent-cyan); font-family: var(--font-data); font-size: 0.85rem; font-weight:700;"></div></div></div>
    <div id="toast" class="toast">Notification</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDoc, setDoc, getDocs, query, orderBy, onSnapshot, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // GLOBAL BINDINGS
        window.checkLogin = () => {
            // FIXED: Ensure email is lowercase to match Firestore ID format
            const email = document.getElementById("loginEmail").value.toLowerCase().trim();
            const pass = document.getElementById("loginPass").value;
            signInWithEmailAndPassword(auth, email, pass).catch(e => document.getElementById("login-msg").innerText = "ACCESS DENIED: " + e.message);
        };
        window.loginWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => console.error(e));
        window.logout = () => signOut(auth).then(() => window.location.reload());
        
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyApUD33ao9DfFa8IAfA2qby3IFKhLtcNFU",
            authDomain: "ttrl-9f3ef.firebaseapp.com",
            projectId: "ttrl-9f3ef",
            storageBucket: "ttrl-9f3ef.firebasestorage.app",
            messagingSenderId: "51144639440",
            appId: "1:51144639440:web:8a027b773bc2cddefe2fd5"
        };
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // VISUAL SIGNAL THAT SCRIPT LOADED
            const scriptStatus = document.getElementById('script-status');
            if(scriptStatus) scriptStatus.style.display = 'block';
        } catch (e) {
            console.error("Firebase Init Failed", e);
            document.getElementById('login-msg').innerText = "SYSTEM ERROR: SCRIPT INIT FAILED";
        }

        // --- CONSTANTS ---
        const TEAM_COLORS = {
            "red-bull-racing": "#3671C6", "ferrari": "#E80020", "mercedes": "#27F4D2", "mclaren": "#FF8000",
            "aston-martin": "#229971", "alpine": "#0093CC", "williams": "#64C4FF", "racing-bulls": "#1634CB",
            "kick-sauber": "#52E252", "haas": "#5B5B5B", "reserve": "#666666"
        };
        
        // UPDATED: Added Logo URLs to Main TEAMS Data
        const LOGO_BASE = "https://raw.githubusercontent.com/HARISHWINNER/TTRL-RESOURCES/1de52755d3c67ebb0917c0fcc67ee3ed7bee1a4a/LOGOS/";
        const TEAMS = [
            {id:'red-bull-racing', name:'Red Bull Racing', short:'Red Bull', logo: LOGO_BASE + 'redbull.png'}, 
            {id:'ferrari', name:'Ferrari', short:'Ferrari', logo: LOGO_BASE + 'ferrari.png'}, 
            {id:'mercedes', name:'Mercedes-AMG', short:'Mercedes', logo: LOGO_BASE + 'mercedes.png'},
            {id:'mclaren', name:'McLaren', short:'McLaren', logo: LOGO_BASE + 'mclaren.png'}, 
            {id:'aston-martin', name:'Aston Martin', short:'Aston Martin', logo: LOGO_BASE + 'martin.png'}, 
            {id:'alpine', name:'Alpine', short:'Alpine', logo: LOGO_BASE + 'alpine.png'},
            {id:'williams', name:'Williams', short:'Williams', logo: LOGO_BASE + 'williams.png'}, 
            {id:'racing-bulls', name:'Visa Cash App RB', short:'VCARB', logo: LOGO_BASE + 'vcarb.png'}, 
            {id:'kick-sauber', name:'Kick Sauber', short:'Sauber', logo: LOGO_BASE + 'kick_sauber.png'},
            {id:'haas', name:'Haas F1 Team', short:'Haas', logo: LOGO_BASE + 'haas.png'}, 
            {id:'reserve', name:'Reserve Driver', short:'Reserve', logo: 'https://placehold.co/40x40/666/fff?text=R'}
        ];

        const MASTER_TRACK_LIST = [
            { id: "bahrain", name: "Bahrain GP" }, { id: "saudi_arabia", name: "Saudi Arabian GP" }, { id: "australia", name: "Australian GP" },
            { id: "japan", name: "Japanese GP" }, { id: "china", name: "Chinese GP" }, { id: "miami", name: "Miami GP" },
            { id: "emilia_romagna", name: "Emilia Romagna GP" }, { id: "monaco", name: "Monaco GP" }, { id: "canada", name: "Canadian GP" },
            { id: "spain", name: "Spanish GP" }, { id: "austria", name: "Austrian GP" }, { id: "uk", name: "British GP" },
            { id: "hungary", name: "Hungarian GP" }, { id: "belgium", name: "Belgian GP" }, { id: "netherlands", name: "Dutch GP" },
            { id: "italy", name: "Italian GP" }, { id: "azerbaijan", name: "Azerbaijan GP" }, { id: "singapore", name: "Singapore GP" },
            { id: "usa", name: "United States GP" }, { id: "mexico", name: "Mexico City GP" }, { id: "brazil", name: "So Paulo GP" },
            { id: "las_vegas", name: "Las Vegas GP" }, { id: "qatar", name: "Qatar GP" }, { id: "abu_dhabi", name: "Abu Dhabi GP" }
        ];

        // --- APP STATE ---
        let currentSeason = "season_1"; 
        let unsubscribe = null; 
        let knownSeasons = [];
        let activeTracks = []; 
        try { knownSeasons = JSON.parse(localStorage.getItem('ttrl_seasons')) || ['season_1']; } catch(e) { knownSeasons = ['season_1']; }
        let driversCache = {};
        let allDrivers = [];
        let pendingImportData = [];
        let pendingImportTracks = new Set();
        let statsChart = null;
        let barChart = null;

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Force lowercase email lookup to match Firestore ID format
                    const emailKey = user.email.toLowerCase();
                    const adminDocRef = doc(db, "Admin", emailKey);
                    const docSnap = await getDoc(adminDocRef); 
                    
                    if (docSnap.exists()) {
                        const adminData = docSnap.data();
                        
                        // NEW CHECK: Verify the 'role' field is exactly "Admin"
                        if (adminData.role === "Admin") {
                            document.getElementById("login-screen").style.display = "none";
                            document.getElementById("main-interface").style.display = "flex";
                            setTimeout(() => document.getElementById("main-interface").style.opacity = "1", 50);
                            document.getElementById("userName").innerText = (user.displayName || user.email.split('@')[0]).toUpperCase(); 
                            initApp();
                        } else {
                            throw new Error("Insufficient Permissions: Role is not Admin");
                        }
                    } else { 
                        throw new Error("User not found in Admin database"); 
                    }
                } catch (error) {
                    console.warn("Access verification failed:", error);
                    signOut(auth).then(() => { 
                        const msgDiv = document.getElementById("login-msg");
                        msgDiv.innerText = "ACCESS DENIED: " + (error.message || "Unauthorized");
                        msgDiv.style.color = "var(--accent-red)";
                        document.getElementById("login-screen").style.display = "flex"; 
                    });
                }
            } else { 
                document.getElementById("login-screen").style.display = "flex"; 
                document.getElementById("main-interface").style.display = "none"; 
            }
        });

        // --- INITIALIZATION ---
        window.initApp = async function() {
            populateDropdowns();
            await refreshSeasonList(); // Fetch available seasons from Firebase first
            
            // Default to season_1 if input is empty, or keep current value
            const currentInput = document.getElementById("seasonInput").value;
            if(!currentInput) {
                document.getElementById("seasonInput").value = "season_1";
            }
            changeSeason();
        }

        // --- NEW: FETCH SEASONS FROM FIREBASE ---
        window.refreshSeasonList = async () => {
            // REMOVED: No longer fetching for top bar dropdown
            // const listEl = document.getElementById('seasonOptions');
            const dashListEl = document.getElementById('dashSeasonsBody');
            const statusEl = document.getElementById('seasonStatusMsg');
            
            // Visual loading state
            if(statusEl) statusEl.innerText = "FETCHING LIST...";
            if(dashListEl) dashListEl.innerHTML = '<span style="color:var(--text-muted); font-size:0.9rem;">Fetching...</span>';

            try {
                // Get all documents in the 'seasons' collection
                const q = query(collection(db, "seasons"));
                const querySnapshot = await getDocs(q);
                
                const seasonsFound = [];
                if(dashListEl) dashListEl.innerHTML = ''; // Clear dash list
                
                querySnapshot.forEach((doc) => {
                    seasonsFound.push(doc.id);
                    
                    // Add to Dashboard Visible List
                    if(dashListEl) {
                        const sBtn = document.createElement('button');
                        sBtn.className = 'btn';
                        sBtn.style.cssText = 'background:rgba(255,255,255,0.1); border:1px solid var(--border-dim); font-size:0.85rem; text-transform:uppercase; font-weight:700; color:#fff; backdrop-filter:blur(5px);';
                        sBtn.innerHTML = `<i class="fas fa-folder"></i> ${doc.id}`;
                        sBtn.onclick = () => {
                            document.getElementById('seasonInput').value = doc.id;
                            window.changeSeason();
                        };
                        dashListEl.appendChild(sBtn);
                    }
                });

                if(seasonsFound.length === 0 && dashListEl) {
                    dashListEl.innerHTML = '<span style="color:var(--text-muted);">No seasons found. Type a name above to create one.</span>';
                }

                // Update internal tracking
                knownSeasons = seasonsFound;
                if(statusEl) statusEl.innerText = `FOUND ${seasonsFound.length} SEASONS`;
                setTimeout(() => { if(statusEl) statusEl.innerText = ""; }, 2000);

            } catch(e) {
                console.error("Error fetching seasons:", e);
                if(statusEl) {
                    statusEl.innerText = "ERROR FETCHING LIST";
                    statusEl.style.color = "var(--accent-red)";
                }
            }
        };

        // --- HELPER FUNCTIONS ---
        // Internal helper, not needed in global scope
        const getTeamColor = (teamId) => {
            if(!teamId) return '#94a3b8';
            if(TEAM_COLORS[teamId]) return TEAM_COLORS[teamId];
            const lower = teamId.toLowerCase();
            if(TEAM_COLORS[lower]) return TEAM_COLORS[lower];
            const teamObj = TEAMS.find(t => t.name.toLowerCase() === lower || t.id === lower);
            if(teamObj && TEAM_COLORS[teamObj.id]) return TEAM_COLORS[teamObj.id];
            return '#94a3b8';
        };

        // Internal helper for charts
        const renderChart = (labels, lineData, barData) => {
            const gridColor = 'rgba(255,255,255,0.05)'; // Updated for dark mode
            const textColor = '#a0a0a0'; // Updated for dark mode
            const ctx1 = document.getElementById('pointsChart'); if(statsChart) statsChart.destroy(); statsChart = new Chart(ctx1, { type: 'line', data: { labels: labels, datasets: [{ label: 'Points', data: lineData, borderColor: '#23a2f6', backgroundColor: 'rgba(35, 162, 246, 0.1)', tension: 0.3, fill: true, pointBackgroundColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });
            const ctx2 = document.getElementById('barChart'); if(barChart) barChart.destroy(); barChart = new Chart(ctx2, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Points', data: barData, backgroundColor: 'rgba(255, 81, 47, 0.7)', borderColor: '#ff512f', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });
        };
        
        // Global Utils
        const showToast = (msg) => {
            const t = document.getElementById('toast');
            // Add checkmark icon if not present in message
            const iconHTML = '<i class="fas fa-check-circle"></i> ';
            t.innerHTML = iconHTML + msg;
            t.classList.add('show');
            setTimeout(() => { t.classList.remove('show'); }, 3000);
        };
        window.showToast = showToast; // Explicitly attach to window

        window.customConfirm = (msg, onYes, onNo) => {
            const m = document.getElementById('confirmModal');
            document.getElementById('modalMessage').innerText = msg;
            m.style.display = 'flex';
            
            document.getElementById('btnConfirmYes').onclick = () => { 
                m.style.display = 'none'; 
                if(onYes) onYes(); 
            };
            
            const btnNo = document.getElementById('btnConfirmNo');
            if(btnNo) {
                btnNo.onclick = () => {
                    m.style.display = 'none';
                    if(onNo) onNo();
                };
            }
        };

        // --- CORE FUNCTIONS (Attached to Window for HTML Access) ---
        window.switchTab = (id) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            const items = document.querySelectorAll('.nav-btn');
            items.forEach(i => { if(i.getAttribute('onclick').includes(id)) i.classList.add('active'); });
            
            // EXPLICIT TRIGGER FOR LIVE VIEW VISIBILITY FIX
            if(id === 'live-view') {
                if(window.updateLiveTables) window.updateLiveTables();
            }
        };

        window.toggleSidebar = () => {
             document.getElementById('appSidebar').classList.toggle('collapsed');
        };

        window.closeModal = () => document.getElementById('confirmModal').style.display = 'none';

        function populateDropdowns() {
            const ts = document.getElementById("trackSelector");
            ts.innerHTML = '<option value="">-- CHOOSE CIRCUIT --</option>';
            MASTER_TRACK_LIST.forEach(t => ts.innerHTML += `<option value="${t.id}">${t.name.toUpperCase()}</option>`);
            const teamOptions = TEAMS.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById("newDriverTeam").innerHTML = teamOptions;
            document.getElementById("editorMainTeam").innerHTML = teamOptions;
            
            // Populate Team Selectors for Analytics
            const teamSelA = document.getElementById("statsTeamA");
            const teamSelB = document.getElementById("statsTeamB");
            if(teamSelA) teamSelA.innerHTML = '<option value="">Select Team A</option>' + teamOptions;
            if(teamSelB) teamSelB.innerHTML = '<option value="">Select Team B</option>' + teamOptions;
        }

        // --- UPDATED: CHANGE SEASON LOGIC ---
        window.changeSeason = async () => {
            let inputVal = document.getElementById("seasonInput").value.trim();
            if(!inputVal) return;
            
            inputVal = inputVal.toLowerCase().replace(/\s+/g, '_');
            document.getElementById("seasonInput").value = inputVal;
            
            const statusEl = document.getElementById('seasonStatusMsg');
            if(statusEl) { statusEl.style.color = "var(--accent-cyan)"; statusEl.innerText = "CHECKING..."; }

            const docRef = doc(db, "seasons", inputVal);
            let snap;
            try {
                snap = await getDoc(docRef);
            } catch (e) {
                console.error(e);
                if(statusEl) statusEl.innerText = "ERROR";
                return;
            }

            if (!snap.exists()) {
                // Use custom modal instead of native confirm
                customConfirm(`Create new season: "${inputVal.toUpperCase()}"?`, async () => {
                    // ON YES
                    try {
                        await setDoc(docRef, { trackConfig: [] });
                        showToast(`SEASON CREATED`);
                        await refreshSeasonList();
                        loadSeasonData(inputVal); // Helper to load
                    } catch(e) {
                        console.error("Creation failed", e);
                        showToast("Error creating season");
                    }
                }, () => {
                    // ON CANCEL (Need to update customConfirm to support this or just handle UI reset)
                    document.getElementById("seasonInput").value = currentSeason;
                    if(statusEl) statusEl.innerText = "CANCELLED";
                });
                return; // Stop execution here, wait for modal
            }

            // If exists, load directly
            loadSeasonData(inputVal);
        };

        // Refactored loading logic into a separate function to be reusable
        async function loadSeasonData(seasonId) {
            currentSeason = seasonId;
            const statusEl = document.getElementById('seasonStatusMsg');
            if(statusEl) statusEl.innerText = "LOADING...";
            
            await loadTrackConfig();
            initListener();
            
            const dashDate = document.getElementById("dashNextDate");
            if(dashDate) dashDate.innerText = `ACTIVE: ${currentSeason.toUpperCase()}`;

            if(statusEl) statusEl.innerText = "READY";
            setTimeout(() => { if(statusEl) statusEl.innerText = ""; }, 1500);
        }

        // --- ADDED: DELETE SEASON FUNCTION ---
        window.deleteCurrentSeason = async () => {
            const seasonId = currentSeason;
            if (!seasonId) { 
                showToast("Invalid Season ID");
                return;
            }

            customConfirm(`PERMANENTLY DELETE ${seasonId.toUpperCase()}?`, async () => {
                const statusEl = document.getElementById('seasonStatusMsg');
                if(statusEl) statusEl.innerText = "DELETING...";

                try {
                    // 1. Delete all drivers in the subcollection
                    // Note: Client SDK requires deleting docs individually
                    const driversRef = collection(db, "seasons", seasonId, "drivers");
                    const snapshot = await getDocs(driversRef);
                    const batch = writeBatch(db);
                    snapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    // 2. Delete the season document itself
                    await deleteDoc(doc(db, "seasons", seasonId));

                    showToast(`${seasonId.toUpperCase()} DELETED`);
                    
                    // 3. Reset UI
                    document.getElementById("seasonInput").value = "";
                    currentSeason = "";
                    
                    // 4. Refresh list
                    await refreshSeasonList();
                    
                    // 5. Fallback to first available season or default
                    const firstSeason = knownSeasons[0];
                    if(firstSeason) {
                        document.getElementById("seasonInput").value = firstSeason;
                        changeSeason();
                    } else {
                        document.getElementById("seasonInput").value = "season_1"; 
                        changeSeason();
                    }

                } catch (e) {
                    console.error(e);
                    showToast("Error Deleting Season");
                    if(statusEl) statusEl.innerText = "";
                }
            });
        };

        async function loadTrackConfig() {
            const list = document.getElementById("trackConfigList");
            const docRef = doc(db, "seasons", currentSeason);
            try {
                const snap = await getDoc(docRef);
                activeTracks = (snap.exists() && snap.data().trackConfig) ? snap.data().trackConfig : [];
                activeTracks.sort((a, b) => new Date(a.date || '9999-12-31') - new Date(b.date || '9999-12-31'));
            } catch (e) { activeTracks = []; }

            // MODIFIED: Remove style attributes for height and scroll, use grid layout
            if(activeTracks.length === 0) list.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;">NO TRACKS CONFIGURED</div>`;
            else {
                // MODIFIED: HTML structure for track cards
                list.innerHTML = activeTracks.map(t => `
                    <div class="track-card">
                        <div class="track-header">
                            <input type="checkbox" class="track-checkbox" value="${t.id}">
                            <span class="track-name">${t.name}</span>
                        </div>
                        <div class="track-body">
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <label style="font-size:0.7rem; font-weight:700; color:var(--text-secondary);">RACE DATE</label>
                                <input type="date" value="${t.date || ''}" onchange="window.updateTrackDate('${t.id}', this.value)" class="form-control" style="padding:6px;">
                            </div>
                        </div>
                        <button class="icon-btn delete" onclick="window.removeTrackConfig('${t.id}')" style="position:absolute; top:16px; right:16px; width:28px; height:28px;"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
            }
            
            const rs = document.getElementById("raceDirectorTrackSelect");
            if (rs) {
                rs.innerHTML = '<option value="">-- SELECT EVENT --</option>';
                activeTracks.forEach(t => rs.innerHTML += `<option value="${t.id}">${t.name.toUpperCase()}</option>`);
            }
            updateDashboard();
        }

        function updateDashboard() {
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            safeSet('dashDriverCount', allDrivers.length);
            safeSet('dashTrackCount', activeTracks.length);
            
            let mostWins = { name: "--", count: 0 }, totalEntries = 0, totalPointsScored = 0;

            if(allDrivers.length > 0) {
                const leader = allDrivers.reduce((prev, current) => (prev.totalPoints > current.totalPoints) ? prev : current);
                safeSet('dashLeader', leader.name.toUpperCase());
                safeSet('dashLeaderPts', `${leader.totalPoints} PTS`);
                allDrivers.forEach(d => {
                      const results = d.results || {};
                      let dWins = 0;
                      Object.values(results).forEach(r => {
                          const p = (typeof r === 'object') ? r.points : r;
                          if(p > 0) { totalEntries++; totalPointsScored += p; }
                          if(p >= 25) dWins++; 
                      });
                      if(dWins > mostWins.count) mostWins = { name: d.name, count: dWins };
                });
            } else { safeSet('dashLeader', "--"); safeSet('dashLeaderPts', "0 PTS"); }

            const teamPoints = {};
            allDrivers.forEach(d => {
                const results = d.results || {};
                Object.values(results).forEach(r => {
                    const p = (typeof r === 'object') ? r.points : r;
                    const t = (typeof r === 'object') ? r.team : d.team;
                    if(t !== 'reserve') { teamPoints[t] = (teamPoints[t]||0) + p; }
                });
            });
            let topTeam = { id: '--', pts: 0 };
            Object.keys(teamPoints).forEach(tid => { if(teamPoints[tid] > topTeam.pts) topTeam = { id: tid, pts: teamPoints[tid] }; });
            const teamName = TEAMS.find(t => t.id === topTeam.id)?.name || topTeam.id;
            safeSet('dashTeamLeader', teamName.toUpperCase());
            safeSet('dashTeamPts', `${topTeam.pts} PTS`);

            // Calendar Logic
            const now = new Date();
            let nextRace = null;
            let racesDone = 0;
            const calList = document.getElementById('dashCalendarList');
            if (calList) {
                calList.innerHTML = "";
                activeTracks.forEach((t, i) => {
                    let statusColor = "var(--text-secondary)", statusIcon = "";
                    if(t.date) {
                        const d = new Date(t.date);
                        if(d < now) { racesDone++; statusColor = "var(--accent-green)"; statusIcon = `<i class="fas fa-check"></i>`; } 
                        else if (!nextRace) { nextRace = t; statusColor = "var(--accent-cyan)"; statusIcon = `<i class="fas fa-flag"></i>`; }
                    }
                    calList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border-dim); color:var(--text-secondary);">
                        <span style="font-weight:600; color:${statusColor}">${String(i+1).padStart(2,'0')} ${t.name}</span>
                        <span style="font-size:0.85rem; font-family:var(--font-data);">${t.date || 'TBD'} ${statusIcon}</span>
                    </div>`;
                });
            } else {
                activeTracks.forEach((t) => { if(t.date && new Date(t.date) < now) racesDone++; else if(t.date && !nextRace) nextRace = t; });
            }
            
            const totalRaces = activeTracks.length || 1;
            const pct = Math.round((racesDone / totalRaces) * 100);
            safeSet('dashProgressPct', `${pct}%`);
            safeSet('dashRacesDone', `${racesDone} / ${totalRaces} RACES`);
            const bar = document.getElementById('dashProgressBar');
            if(bar) bar.style.width = `${pct}%`;

            if(nextRace) {
                const parts = nextRace.id.split('_');
                const name = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                safeSet('dashNextRace', name + ' GP');
            } else { safeSet('dashNextRace', "SEASON END"); }

            let lastWinnerName = "--", lastWinnerGP = "NO RACES";
            if (racesDone > 0) {
                const pastRaces = activeTracks.filter(t => t.date && new Date(t.date) < now);
                pastRaces.sort((a,b) => new Date(b.date) - new Date(a.date));
                const lastRace = pastRaces[0];
                if (lastRace) {
                    lastWinnerGP = lastRace.name.toUpperCase();
                    let maxPts = -1, winner = null;
                    allDrivers.forEach(d => {
                        const r = d.results ? d.results[lastRace.id] : null;
                        if (r) {
                            const p = (typeof r === 'object') ? r.points : r;
                            if (p > maxPts) { maxPts = p; winner = d.name; }
                        }
                    });
                    if (winner) lastWinnerName = winner;
                }
            }
            safeSet('dashLastWinner', lastWinnerName.toUpperCase());
            safeSet('dashLastGP', lastWinnerGP);

            // --- UPDATED STATS CALCULATIONS ---
            
            // 1. Driver Gap
            let driverGap = 0;
            if(allDrivers.length >= 2) {
                const sortedDrivers = [...allDrivers].sort((a,b) => b.totalPoints - a.totalPoints);
                driverGap = sortedDrivers[0].totalPoints - sortedDrivers[1].totalPoints;
            }
            safeSet('dashDriverGap', driverGap);

            // 2. Team Gap
            const teamRank = Object.keys(teamPoints).map(tid => ({id: tid, pts: teamPoints[tid]})).sort((a,b) => b.pts - a.pts);
            let teamGap = 0;
            if(teamRank.length >= 2) {
                teamGap = teamRank[0].pts - teamRank[1].pts;
            }
            safeSet('dashTeamGap', teamGap);
            
            // 3. Most Wins
            safeSet('dashMostWins', mostWins.name.toUpperCase());
            safeSet('dashMostWinsCount', `${mostWins.count} WINS`);
        }

        // --- DASHBOARD ACTIONS ---
        window.addTrackConfig = async () => {
            const id = document.getElementById("trackSelector").value;
            const date = document.getElementById("newTrackDate").value;
            if(!id || !date) { showToast("Select Track & Date"); return; }
            if(activeTracks.some(t => t.id === id)) { showToast("Track already exists"); return; }
            const obj = MASTER_TRACK_LIST.find(t => t.id === id);
            const newTrack = { id, name: obj.name, date };
            const ref = doc(db, "seasons", currentSeason);
            const snap = await getDoc(ref);
            if(!snap.exists()) await setDoc(ref, { trackConfig: [newTrack] });
            else await updateDoc(ref, { trackConfig: arrayUnion(newTrack) });
            loadTrackConfig(); showToast("Track Added");
        };

        window.updateTrackDate = async (trackId, newDate) => {
            const ref = doc(db, "seasons", currentSeason);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                let tracks = snap.data().trackConfig || [];
                const idx = tracks.findIndex(t => t.id === trackId);
                if(idx !== -1) { tracks[idx].date = newDate; await updateDoc(ref, { trackConfig: tracks }); showToast("Date Updated"); updateDashboard(); }
            }
        };

        window.removeTrackConfig = (id) => {
            customConfirm("Remove this track?", async () => {
                const ref = doc(db, "seasons", currentSeason);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const tracks = snap.data().trackConfig.filter(t => t.id !== id);
                    await updateDoc(ref, { trackConfig: tracks });
                    loadTrackConfig(); showToast("Track Removed");
                }
            });
        };

        window.toggleTrackSelectAll = () => {
            const cbs = document.querySelectorAll('.track-checkbox');
            const all = Array.from(cbs).every(c => c.checked);
            cbs.forEach(c => c.checked = !all);
        };

        window.deleteSelectedTracks = () => {
            const cbs = document.querySelectorAll('.track-checkbox:checked');
            if(cbs.length === 0) return;
            customConfirm(`Delete ${cbs.length} tracks?`, async () => {
                const idsToRemove = Array.from(cbs).map(c => c.value);
                const ref = doc(db, "seasons", currentSeason);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const currentTracks = snap.data().trackConfig || [];
                    const newTracks = currentTracks.filter(t => !idsToRemove.includes(t.id));
                    await updateDoc(ref, { trackConfig: newTracks });
                    loadTrackConfig(); showToast("Tracks Deleted");
                }
            });
        };

        window.registerDriver = async () => {
            const name = document.getElementById("newDriverName").value;
            const team = document.getElementById("newDriverTeam").value;
            if(!name) return;
            try { await addDoc(collection(db, "seasons", currentSeason, "drivers"), { name, team, totalPoints: 0, results: {} }); document.getElementById("newDriverName").value = ""; showToast("Driver Added"); } catch(e) { console.error(e); }
        };

        window.deleteDriver = (id) => {
            const d = driversCache[id];
            customConfirm(`Delete ${d ? d.name : 'driver'}?`, async () => { await deleteDoc(doc(db, "seasons", currentSeason, "drivers", id)); showToast("Deleted"); });
        };

        window.toggleSelectAll = () => { const cbs = document.querySelectorAll('.driver-checkbox'); const all = Array.from(cbs).every(c => c.checked); cbs.forEach(c => c.checked = !all); };
        window.deleteSelectedDrivers = () => {
            const cbs = document.querySelectorAll('.driver-checkbox:checked');
            if(cbs.length === 0) return;
            customConfirm(`Delete ${cbs.length} drivers?`, async () => {
                const batch = writeBatch(db);
                cbs.forEach(c => batch.delete(doc(db, "seasons", currentSeason, "drivers", c.value)));
                await batch.commit(); showToast("Batch Delete Complete");
            });
        };

        window.exportData = () => {
            const exportObj = { season: currentSeason, tracks: activeTracks, drivers: allDrivers };
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `TTRL_${currentSeason}_backup.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast("Export Started");
        };

        window.openMigrationModal = () => { document.getElementById('migrationModal').style.display = 'flex'; document.getElementById('migrationStatus').innerText = ''; };
        window.performMigration = async () => {
            const source = document.getElementById('migrateSource').value.trim();
            const target = document.getElementById('migrateTarget').value.trim();
            const deleteSource = document.getElementById('migrateDelete').checked;
            const status = document.getElementById('migrationStatus');
            if(!source || !target || source === target) { status.innerText = "Error: Invalid Season IDs"; return; }
            status.innerText = "Migrating...";
            try {
                const sourceRef = doc(db, 'seasons', source);
                const sourceSnap = await getDoc(sourceRef);
                const tracks = sourceSnap.exists() ? (sourceSnap.data().trackConfig || []) : [];
                const driversRef = collection(db, 'seasons', source, 'drivers');
                const driversSnap = await getDocs(driversRef);
                const targetRef = doc(db, 'seasons', target);
                await setDoc(targetRef, { trackConfig: tracks }, { merge: true });
                const batch = writeBatch(db);
                driversSnap.forEach(d => { const newDocRef = doc(db, 'seasons', target, 'drivers', d.id); batch.set(newDocRef, d.data()); });
                await batch.commit();
                if(deleteSource) { const delBatch = writeBatch(db); driversSnap.forEach(d => delBatch.delete(d.ref)); delBatch.delete(sourceRef); await delBatch.commit(); }
                status.innerText = "SUCCESS!";
                setTimeout(() => { document.getElementById('migrationModal').style.display = 'none'; if(document.getElementById('seasonInput').value === target) changeSeason(); }, 1500);
            } catch(e) { status.innerText = "Failed: " + e.message; }
        };

        window.loadDriverData = (id) => {
            if(!id) return;
            document.getElementById("editorSelectionContainer").style.display = "none"; document.getElementById("editor-area").style.display = "block";
            const data = driversCache[id];
            
            // Populate Name Input (Fixed: Removed missing Display element)
            const nameInput = document.getElementById("editorDriverNameInput");
            if(nameInput) nameInput.value = data.name;
            
            document.getElementById("editorMainTeam").value = data.team;
            document.getElementById("editorDriverIdHidden").value = id;
            const grid = document.getElementById("trackGrid"); 
            
            if(activeTracks.length === 0) { grid.innerHTML = "<div style='color:var(--text-muted); padding:10px;'>No Tracks Configured</div>"; return; }
            
            const res = data.results || {};
            // Generate options once
            const teamOpts = `<optgroup label="Teams">` + TEAMS.map(tm => `<option value="${tm.id}">${tm.name}</option>`).join('') + `</optgroup>`;
            
            let rowsHTML = "";
            activeTracks.forEach(t => {
                let pts = 0, pos = "", raceTeam = data.team; 
                if(res[t.id]) { 
                    if(typeof res[t.id] === 'object') { 
                        pts = res[t.id].points || 0; 
                        pos = res[t.id].position || "";
                        if(res[t.id].team) raceTeam = res[t.id].team;
                    } else { pts = res[t.id]; } 
                }

                // Use robust color getter
                const raceTeamColor = getTeamColor(raceTeam);

                rowsHTML += `<div class="race-row" id="row-${t.id}" style="background:var(--bg-panel); border:1px solid var(--border-dim); padding:16px 16px 16px 24px; border-radius:8px; box-shadow:var(--shadow-sm); position:relative; overflow:hidden;">
                    <div class="team-strip" id="strip-${t.id}" style="background:${raceTeamColor};"></div>
                    <label class="input-label" style="margin-bottom:8px;">${t.name}</label>
                    <div style="display:flex; gap:12px;">
                        <input type="text" class="pos-in form-control" style="width:70px; text-align:center; font-weight:700;" placeholder="POS" value="${pos}">
                        <input type="number" class="pts-in form-control" style="width:90px; text-align:center; font-weight:bold; color:var(--accent-cyan);" data-track="${t.id}" value="${pts}" oninput="calcTotal()">
                        <select class="tm-in form-control" id="tm-${t.id}" onchange="updateRowColor('${t.id}', this.value)">${teamOpts}</select>
                    </div>
                </div>`;
            });

            grid.innerHTML = rowsHTML;

            activeTracks.forEach(t => {
                let raceTeam = data.team;
                if(res[t.id] && typeof res[t.id] === 'object' && res[t.id].team) {
                    raceTeam = res[t.id].team;
                }
                const el = document.getElementById(`tm-${t.id}`);
                if(el) el.value = raceTeam;
            });
            
            calcTotal();
        };
        
        // --- ADDED: RENAME FUNCTION (With Ack) ---
        window.updateDriverName = async () => {
            const id = document.getElementById("editorDriverIdHidden").value;
            const newName = document.getElementById("editorDriverNameInput").value.trim();
            if(!id || !newName) return;
            
            try {
                await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { name: newName });
                // Update the input immediately for responsiveness
                document.getElementById("editorDriverNameInput").value = newName; 
                // Show High-Vis Toast
                showToast("DRIVER RENAMED SUCCESSFULLY");
            } catch(e) {
                console.error(e);
                showToast("ERROR: COULD NOT RENAME");
            }
        };

        window.updateRowColor = (trackId, teamId) => {
            const color = getTeamColor(teamId);
            const strip = document.getElementById(`strip-${trackId}`);
            if(strip) strip.style.background = color;
        };

        window.closeDriverEditor = () => { document.getElementById("editor-area").style.display = "none"; document.getElementById("editorSelectionContainer").style.display = "block"; document.getElementById("editorDriverIdHidden").value = ""; };
        window.updateMainTeam = async () => { const id = document.getElementById("editorDriverIdHidden").value; if(!id) return; const team = document.getElementById("editorMainTeam").value; await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { team }); showToast("Main Contract Updated"); };
        window.calcTotal = () => { let s = 0; document.querySelectorAll(".pts-in").forEach(i => s += Number(i.value)||0); document.getElementById("calculatedTotal").innerText = s; };
        
        window.saveAllChanges = async () => {
            const id = document.getElementById("editorDriverIdHidden").value; if(!id) return;
            const ptsIns = document.querySelectorAll(".pts-in"); 
            const tmIns = document.querySelectorAll(".tm-in");
            const posIns = document.querySelectorAll(".pos-in");
            let newResults = {}, total = 0;
            
            const mainTeam = document.getElementById("editorMainTeam").value;

            ptsIns.forEach((p, idx) => { 
                const val = Number(p.value); 
                const posVal = posIns[idx].value.trim();
                const selectedTeam = tmIns[idx].value;
                
                if(val > 0 || posVal !== "" || selectedTeam !== mainTeam) { 
                    newResults[p.dataset.track] = { points: val, position: posVal, team: selectedTeam }; 
                    total += val; 
                } 
            });
            await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { results: newResults, totalPoints: total }); 
            showToast("CHANGES SAVED"); // Ack for Driver Editor Save
        };

        window.triggerImport = () => document.getElementById('csvFile').click();
        window.handleFileSelect = (input) => { if(input.files[0]) { const r = new FileReader(); r.onload = (e) => parseCSV(e.target.result); r.readAsText(input.files[0]); } };
        function parseCSV(text) {
            const lines = text.split('\n'); pendingImportData = []; pendingImportTracks.clear();
            const headers = lines[0].split(',').map(s => s.trim().replace(/^"|"$/g,''));
            const colMap = {};
            headers.forEach((h, i) => { const mid = MASTER_TRACK_LIST.find(t => h.toLowerCase().includes(t.id.split('_')[0]))?.id; if(mid) { colMap[i] = mid; pendingImportTracks.add(mid); } });
            lines.slice(1).forEach(line => {
                if(!line.trim()) return; const p = line.split(',').map(s => s.trim().replace(/^"|"$/g,'')); if(p.length < 2) return;
                const name = p[0]; const teamRaw = p[1].toLowerCase().replace(/\s/g,'-');
                const tObj = TEAMS.find(t => t.id === teamRaw || t.name.toLowerCase() === p[1].toLowerCase());
                const teamId = tObj ? tObj.id : 'reserve';
                let res = {}, tot = 0;
                Object.keys(colMap).forEach(idx => { const pts = parseInt(p[idx]); if(!isNaN(pts) && pts > 0) { res[colMap[idx]] = { points: pts, team: teamId }; tot += pts; } });
                pendingImportData.push({ name, team: teamId, results: res, totalPoints: tot });
            });
            switchTab('import-preview'); document.getElementById('import-preview').classList.add('active'); document.getElementById('detectedTracksList').innerText = Array.from(pendingImportTracks).join(', ').toUpperCase() || "NONE";
            const tb = document.getElementById('importTableBody'); tb.innerHTML = "";
            pendingImportData.forEach((d, i) => { const tOpts = TEAMS.map(t => `<option value="${t.id}" ${t.id===d.team?'selected':''}>${t.name}</option>`).join(''); tb.innerHTML += `<tr><td><input value="${d.name}" class="form-control" onchange="pendingImportData[${i}].name=this.value"></td><td><select class="form-control" onchange="pendingImportData[${i}].team=this.value; updateImpTeam(${i}, this.value)">${tOpts}</select></td><td style="color:var(--accent-cyan); font-weight:bold;">${d.totalPoints}</td><td style="color:var(--accent-green)">READY</td></tr>`; });
        }
        window.updateImpTeam = (idx, nt) => { const r = pendingImportData[idx].results; Object.keys(r).forEach(k => r[k].team = nt); };
        window.cancelImport = () => { document.getElementById('csvFile').value = ""; switchTab('manage-drivers'); };
        window.commitImport = async () => {
            const sRef = doc(db, "seasons", currentSeason); const snap = await getDoc(sRef);
            let tracks = (snap.exists() && snap.data().trackConfig) ? snap.data().trackConfig : [];
            const newT = []; pendingImportTracks.forEach(tid => { if(!tracks.some(t => t.id === tid)) { const m = MASTER_TRACK_LIST.find(x => x.id === tid); newT.push({ id: tid, name: m ? m.name : tid.toUpperCase(), date: "" }); } });
            if(newT.length > 0) { if(snap.exists()) await updateDoc(sRef, { trackConfig: arrayUnion(...newT) }); else await setDoc(sRef, { trackConfig: newT }); }
            const batch = writeBatch(db); pendingImportData.forEach(d => { if(d.name) { batch.set(doc(collection(db, "seasons", currentSeason, "drivers")), { name: d.name, team: d.team, totalPoints: d.totalPoints, results: d.results }); } });
            await batch.commit(); loadTrackConfig(); cancelImport(); showToast(`Imported ${pendingImportData.length} Drivers`);
        };

        window.loadRaceGrid = () => {
            const tid = document.getElementById("raceDirectorTrackSelect").value; 
            const conFull = document.getElementById("raceGridFull"); 
            const conRes = document.getElementById("raceGridReserve"); 
            const wrap = document.getElementById("raceDirectorGrid"); 
            if(!tid) { wrap.style.display="none"; return; } 
            wrap.style.display="block"; 
            
            conFull.innerHTML = "";
            conRes.innerHTML = "";

            allDrivers.forEach(d => {
                const r = d.results || {}; 
                const pts = (r[tid] && typeof r[tid]==='object') ? r[tid].points : (r[tid] || 0); 
                const pos = (r[tid] && typeof r[tid]==='object') ? r[tid].position : "";
                let team = d.team; if (r[tid] && typeof r[tid] === 'object' && r[tid].team) { team = r[tid].team; }
                const teamColor = getTeamColor(team);
                
                // Retrieve team details for display
                const teamObj = TEAMS.find(t => t.id === team);
                const teamName = teamObj?.name || team;
                const teamLogo = teamObj?.logo || "";
                
                // FIXED: Removed the blue tint background for cards with points
                const hasPoints = '';
                
                const cardHTML = `
                    <div class="driver-card" style="--team-color:${teamColor}; ${hasPoints}">
                        <div style="display:flex; align-items:center;">
                            ${teamLogo ? `<img src="${teamLogo}" class="admin-team-logo" alt="${teamName}">` : ''}
                            <div class="driver-info">
                                <span style="display:block; font-weight:700; color:var(--text-primary); font-size:1.05rem;">${d.name}</span>
                                <span style="display:block; font-size:0.75rem; color:${teamColor}; font-weight:700; text-transform:uppercase; margin-top:2px;">${teamName}</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:5px; position:relative; z-index:2;">
                            <input type="text" class="rc-pos-input form-control" style="width:60px; text-align:center; padding:5px; font-size:0.9rem; font-weight:700; text-transform:uppercase;" placeholder="POS" value="${pos || ''}">
                            <input type="number" class="rc-points-input form-control" style="width:70px; text-align:center; padding:5px; font-weight:800; color:var(--accent-cyan);" placeholder="PTS" data-did="${d.id}" value="${pts}">
                        </div>
                    </div>`;

                if(d.team === 'reserve') {
                    conRes.innerHTML += cardHTML;
                } else {
                    conFull.innerHTML += cardHTML;
                }
            });
        };

        window.saveRaceResults = async () => {
            const tid = document.getElementById("raceDirectorTrackSelect").value; if(!tid) return; 
            const ptsInps = document.querySelectorAll(".rc-points-input"); const posInps = document.querySelectorAll(".rc-pos-input");
            const batch = writeBatch(db); let changes = 0;
            ptsInps.forEach((inp, idx) => { 
                const did = inp.dataset.did; const newP = Number(inp.value); const newPos = posInps[idx].value.trim();
                const d = driversCache[did]; const oldRes = d.results || {}; const oldP = (oldRes[tid] && typeof oldRes[tid]==='object') ? oldRes[tid].points : (oldRes[tid]||0); const oldPos = (oldRes[tid] && typeof oldRes[tid]==='object') ? oldRes[tid].position : "";
                if(oldP !== newP || oldPos !== newPos) { 
                    const newTot = d.totalPoints - oldP + newP; const resUpd = { ...oldRes }; let tRace = d.team; if(oldRes[tid] && oldRes[tid].team) tRace = oldRes[tid].team; 
                    if(newP > 0 || newPos !== "") { resUpd[tid] = { points: newP, position: newPos, team: tRace }; } else delete resUpd[tid]; 
                    batch.update(doc(db, "seasons", currentSeason, "drivers", did), { results: resUpd, totalPoints: newTot }); changes++; 
                }
            });
            if(changes > 0) { 
                await batch.commit(); 
                showToast("RACE RESULTS COMMITTED"); // Ack for Race Director
            } else { 
                showToast("NO CHANGES DETECTED"); 
            }
        };

        // --- UPDATED ANALYTICS FUNCTIONS ---
        window.toggleStatsMode = () => {
            const mode = document.getElementById('statsMode').value;
            // Hide all selectors
            document.querySelectorAll('.stats-selector').forEach(el => el.style.display = 'none');
            // Show active selector
            if(mode === 'individual') document.getElementById('sel-individual').style.display = 'block';
            else if(mode === '1v1') document.getElementById('sel-1v1').style.display = 'flex';
            else if(mode === 'team') document.getElementById('sel-team').style.display = 'flex';
            
            // Clear content
            document.getElementById('statsDisplay').style.display = 'none';
            document.getElementById('comparisonDisplay').style.display = 'none';
            document.getElementById('statsContent').innerHTML = document.getElementById('statsDisplay').outerHTML + 
                '<div id="comparisonDisplay" style="display:none;"></div>' + 
                '<div id="emptyStats" style="text-align:center; color:var(--text-muted); padding:40px;">SELECT DATA TO ANALYZE</div>';
        };

        window.renderStats = () => {
            const mode = document.getElementById('statsMode').value;
            // FIXED: Check if element exists before accessing style
            const es = document.getElementById('emptyStats');
            if(es) { es.style.display = 'none'; }
            
            if(mode === 'individual') {
                window.viewDriverStats();
            } else if(mode === '1v1') {
                render1v1();
            } else if(mode === 'team') {
                renderTeamBattle();
            }
        };

        // --- Existing Individual Logic ---
        window.viewDriverStats = () => {
            const id = document.getElementById("statsDriverSelect").value; 
            const disp = document.getElementById("statsDisplay"); 
            if(!id) return; 
            disp.style.display="block";
            document.getElementById("comparisonDisplay").style.display="none";

            const d = driversCache[id]; 
            document.getElementById("statsDriverName").innerText = d.name.toUpperCase(); 
            
            // UPDATED: Add Team Logo to Individual Stats Header
            const teamObj = TEAMS.find(t => t.id === d.team);
            const teamName = teamObj?.name.toUpperCase() || d.team;
            const teamLogo = teamObj?.logo ? `<img src="${teamObj.logo}" style="height:24px; width:auto; vertical-align:middle; margin-right:8px; display:inline-block;">` : '';
            
            document.getElementById("statsTeamName").innerHTML = `${teamLogo}${teamName}`; 
            
            document.getElementById("statPoints").innerHTML = `${d.totalPoints} <span style="font-size:1rem; color:var(--text-secondary);">PTS</span>`;
            
            let w=0, p=0, r=0, entries=0, best=0, hHTML=""; 
            const labels = [], dataPoints = [], barData = []; 
            let cumulative = 0;
            let totalPos = 0, finishedRaces = 0;
            let variance = 0;

            activeTracks.forEach(t => { 
                const res = d.results ? d.results[t.id] : null; 
                const pt = (res && typeof res === 'object') ? res.points : (res || 0); 
                const pos = (res && typeof res === 'object') ? res.position : "-";
                if(res) { 
                    entries++; 
                    if(pt > 0) { r++; cumulative += pt; if(pt > best) best = pt; if(pt>=25) w++; if(pt>=15) p++; }
                    const numPos = parseInt(pos); if(!isNaN(numPos)) { totalPos += numPos; finishedRaces++; }
                    const tm = (typeof res === 'object') ? res.team : d.team; const tName = TEAMS.find(x=>x.id===tm)?.name || tm; 
                    hHTML += `<tr><td>${t.name.toUpperCase()}</td><td style="color:var(--accent-yellow); font-weight:700;">${pos}</td><td style="color:var(--text-secondary); font-weight:500;">${tName}</td><td style="text-align:right; font-weight:700; color:var(--accent-cyan);">${pt}</td></tr>`; 
                    labels.push(t.id.substring(0,3).toUpperCase()); dataPoints.push(cumulative); barData.push(pt); 
                } 
            });
            
            let avg = finishedRaces > 0 ? totalPos / finishedRaces : 0; 
            if(r > 0) { 
                barData.forEach(pt => { if(pt>0) variance += Math.pow(pt - (d.totalPoints/r), 2); }); 
                variance = Math.sqrt(variance / r).toFixed(1); 
            }
            
            document.getElementById("statWins").innerText = w; 
            document.getElementById("statPodiums").innerText = p; 
            document.getElementById("statAvg").innerText = avg > 0 ? "P" + avg.toFixed(1) : "-"; 
            document.getElementById("statConsistency").innerText = variance; 
            document.getElementById("statsHistoryBody").innerHTML = hHTML || `<tr><td colspan="4" style="text-align:center;">NO DATA</td></tr>`;
            
            renderChart(labels, dataPoints, barData);
        };

        // --- NEW: 1v1 Comparison ---
        function render1v1() {
            const idA = document.getElementById('statsDriverA').value;
            const idB = document.getElementById('statsDriverB').value;
            const container = document.getElementById('comparisonDisplay');
            if(!idA || !idB) return;

            container.style.display = 'block';
            document.getElementById('statsDisplay').style.display = 'none';

            const dA = driversCache[idA];
            const dB = driversCache[idB];

            // Get Team Logos for comparison cards
            const teamA = TEAMS.find(t => t.id === dA.team);
            const teamB = TEAMS.find(t => t.id === dB.team);
            const logoA = teamA?.logo ? `<img src="${teamA.logo}" style="height:50px; width:auto; margin:0 auto 10px; display:block;">` : '';
            const logoB = teamB?.logo ? `<img src="${teamB.logo}" style="height:50px; width:auto; margin:0 auto 10px; display:block;">` : '';

            let ptsA = 0, ptsB = 0;
            let winsA = 0, winsB = 0;
            let bestA = 99, bestB = 99;
            const labels = [];
            const dataA = [];
            const dataB = [];
            let cumA = 0, cumB = 0;

            activeTracks.forEach(t => {
                const rA = dA.results?.[t.id];
                const rB = dB.results?.[t.id];
                
                const pA = (rA && typeof rA === 'object') ? rA.points : (rA || 0);
                const pB = (rB && typeof rB === 'object') ? rB.points : (rB || 0);
                
                // Track stats
                ptsA += pA; ptsB += pB;
                cumA += pA; cumB += pB;
                
                if(pA >= 25) winsA++;
                if(pB >= 25) winsB++;

                const posA = (rA && rA.position) ? parseInt(rA.position) : 99;
                const posB = (rB && rB.position) ? parseInt(rB.position) : 99;
                if(posA < bestA) bestA = posA;
                if(posB < bestB) bestB = posB;

                if(rA || rB) { // Only chart if at least one raced
                    labels.push(t.id.substring(0,3).toUpperCase());
                    dataA.push(cumA);
                    dataB.push(cumB);
                }
            });

            container.innerHTML = `
                <div class="comparison-grid">
                    <div class="comp-card">
                        ${logoA}
                        <h3>${dA.name}</h3>
                        <h1 style="color:var(--accent-cyan); font-size:2.5rem;">${ptsA}</h1>
                        <p>POINTS</p>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="comp-card">
                        ${logoB}
                        <h3>${dB.name}</h3>
                        <h1 style="color:var(--accent-red); font-size:2.5rem;">${ptsB}</h1>
                        <p>POINTS</p>
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border-dim);">
                    <div class="stat-row"><span>WINS</span> <span>${winsA} vs ${winsB}</span></div>
                    <div class="stat-row"><span>BEST FINISH</span> <span>P${bestA===99?'-':bestA} vs P${bestB===99?'-':bestB}</span></div>
                </div>

                <div class="panel">
                    <div class="panel-header"><div class="panel-title">SEASON BATTLE</div></div>
                    <div class="panel-body">
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="compChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            // Draw Chart
            const ctx = document.getElementById('compChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: dA.name, data: dataA, borderColor: '#0ea5e9', backgroundColor: 'rgba(14,165,233,0.1)', fill:true },
                        { label: dB.name, data: dataB, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill:true }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a0a0a0' } }, x: { grid: { display: false }, ticks: { color: '#a0a0a0' } } }, plugins: { legend: { display: false } } }
            });
        }

        // --- NEW: Team Battle ---
        function renderTeamBattle() {
            const tA = document.getElementById('statsTeamA').value;
            const tB = document.getElementById('statsTeamB').value;
            const container = document.getElementById('comparisonDisplay');
            if(!tA || !tB) return;

            container.style.display = 'block';
            document.getElementById('statsDisplay').style.display = 'none';

            // Get Team Info & Logos
            const teamObjA = TEAMS.find(x => x.id === tA);
            const teamObjB = TEAMS.find(x => x.id === tB);
            const teamNameA = teamObjA?.name || tA;
            const teamNameB = teamObjB?.name || tB;
            const logoA = teamObjA?.logo ? `<img src="${teamObjA.logo}" style="height:60px; width:auto; margin:0 auto 10px; display:block;">` : '';
            const logoB = teamObjB?.logo ? `<img src="${teamObjB.logo}" style="height:60px; width:auto; margin:0 auto 10px; display:block;">` : '';


            // Aggregate Data
            let ptsA = 0, ptsB = 0;
            let winsA = 0, winsB = 0;
            const labels = [];
            const dataA = [];
            const dataB = [];
            let cumA = 0, cumB = 0;

            activeTracks.forEach(t => {
                let trackPtsA = 0;
                let trackPtsB = 0;

                allDrivers.forEach(d => {
                    const r = d.results?.[t.id];
                    if(!r) return;
                    const p = (typeof r === 'object') ? r.points : r;
                    // Check team override in result, else fallback to driver team
                    const raceTeam = (typeof r === 'object' && r.team) ? r.team : d.team;
                    
                    if(raceTeam === tA) {
                        trackPtsA += p;
                        if(p >= 25) winsA++;
                    } else if(raceTeam === tB) {
                        trackPtsB += p;
                        if(p >= 25) winsB++;
                    }
                });

                cumA += trackPtsA;
                cumB += trackPtsB;
                
                if(trackPtsA > 0 || trackPtsB > 0) {
                    labels.push(t.id.substring(0,3).toUpperCase());
                    dataA.push(cumA);
                    dataB.push(cumB);
                }
            });

            container.innerHTML = `
                <div class="comparison-grid">
                    <div class="comp-card" style="border-top:4px solid ${getTeamColor(tA)}">
                        ${logoA}
                        <h3>${teamNameA}</h3>
                        <h1 style="color:var(--text-primary); font-size:2.5rem;">${cumA}</h1>
                        <p>POINTS</p>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="comp-card" style="border-top:4px solid ${getTeamColor(tB)}">
                        ${logoB}
                        <h3>${teamNameB}</h3>
                        <h1 style="color:var(--text-primary); font-size:2.5rem;">${cumB}</h1>
                        <p>POINTS</p>
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--border-dim);">
                    <div class="stat-row"><span>RACE WINS</span> <span>${winsA} vs ${winsB}</span></div>
                </div>

                <div class="panel">
                    <div class="panel-header"><div class="panel-title">CONSTRUCTORS BATTLE</div></div>
                    <div class="panel-body">
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="teamChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            const ctx = document.getElementById('teamChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: teamNameA, data: dataA, borderColor: getTeamColor(tA), backgroundColor: 'transparent', borderWidth:3 },
                        { label: teamNameB, data: dataB, borderColor: getTeamColor(tB), backgroundColor: 'transparent', borderWidth:3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a0a0a0' } }, x: { grid: { display: false }, ticks: { color: '#a0a0a0' } } }, plugins: { legend: { display: false } } }
            });
        }

        // --- VISUALIZATION HELPERS ---
        window.updateLiveTables = function() {
            const tD = document.getElementById("liveDriversBody"); 
            if(tD) {
                tD.innerHTML = "";
                // Safe sort with defaults to prevent crashes
                const sorted = [...allDrivers].sort((a,b) => { 
                    const tA = a.team || 'reserve';
                    const tB = b.team || 'reserve';
                    if(tA==='reserve' && tB!=='reserve') return 1; 
                    if(tA!=='reserve' && tB==='reserve') return -1; 
                    return (b.totalPoints || 0) - (a.totalPoints || 0); 
                });

                if (sorted.length === 0) {
                    tD.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:20px; color:var(--text-muted);">NO DRIVER DATA</td></tr>`;
                } else {
                    sorted.forEach((d,i) => { 
                        const dName = d.name || 'UNKNOWN';
                        const dTeam = d.team || 'reserve';
                        const dPts = d.totalPoints || 0;
                        const teamObj = TEAMS.find(t => t.id === dTeam);
                        const teamLogo = teamObj?.logo ? `<img src="${teamObj.logo}" style="width:20px; height:20px; object-fit:contain; margin-right:8px; vertical-align:middle;">` : '';

                        tD.innerHTML += `<tr>
                            <td style="color:var(--text-secondary); font-weight:600;">${String(i+1).padStart(2,'0')}</td>
                            <td>
                                <div style="font-weight:700; color:var(--text-primary); font-size:0.95rem;">${dName}</div>
                                <div style="font-size:0.75rem; color:var(--accent-cyan); font-weight:600; display:flex; align-items:center; margin-top:2px;">
                                    ${teamLogo} ${dTeam.toUpperCase()}
                                </div>
                            </td>
                            <td style="text-align:right; font-weight:800; font-size:1.1rem; color:var(--accent-cyan);">${dPts}</td>
                        </tr>`; 
                    });
                }
            }
            
            const tC = document.getElementById("liveConstructorsBody"); 
            if(tC) {
                tC.innerHTML = "";
                const teamPts = {}; 
                allDrivers.forEach(d => { 
                    const res = d.results || {}; 
                    Object.values(res).forEach(r => { 
                        const p = (typeof r === 'object') ? (r.points||0) : (r||0); 
                        // Robust fallback: if result object doesn't have team, use driver's current team
                        const t = (typeof r === 'object' && r.team) ? r.team : d.team; 
                        if(t && t !== 'reserve') { 
                            teamPts[t] = (teamPts[t]||0) + p; 
                        } 
                    }); 
                });

                const sortedTeams = Object.keys(teamPts).map(k => ({id:k, p:teamPts[k]})).sort((a,b) => b.p - a.p);
                
                if (sortedTeams.length === 0) {
                     tC.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:20px; color:var(--text-muted);">NO CONSTRUCTOR DATA</td></tr>`;
                } else {
                    sortedTeams.forEach((x,i) => { 
                        const teamObj = TEAMS.find(t => t.id === x.id);
                        const tn = teamObj?.name || x.id.toUpperCase(); 
                        const teamLogo = teamObj?.logo ? `<img src="${teamObj.logo}" style="width:24px; height:24px; object-fit:contain; margin-right:10px; vertical-align:middle;">` : '';

                        tC.innerHTML += `<tr>
                            <td style="color:var(--text-secondary); font-weight:600;">${String(i+1).padStart(2,'0')}</td>
                            <td style="font-weight:700; color:var(--text-primary); text-transform:uppercase; font-size:0.95rem; display:flex; align-items:center;">
                                ${teamLogo} ${tn}
                            </td>
                            <td style="text-align:right; font-weight:800; color:var(--accent-red); font-size:1.1rem;">${x.p}</td>
                        </tr>`; 
                    });
                }
            }
        };

        // --- DRIVER DATA ---
        function initListener() {
            if(unsubscribe) unsubscribe();
            const q = query(collection(db, "seasons", currentSeason, "drivers")); 
            unsubscribe = onSnapshot(q, (snap) => {
                const listFull = document.getElementById("driverListFull");
                const listRes = document.getElementById("driverListReserve");
                const statSel = document.getElementById("statsDriverSelect");
                const statSelA = document.getElementById("statsDriverA");
                const statSelB = document.getElementById("statsDriverB");
                
                // NEW: Get separate grid containers for the Editor
                const editGridFull = document.getElementById("editorGridFull");
                const editGridRes = document.getElementById("editorGridReserve");
                
                if(listFull) listFull.innerHTML = ""; 
                if(listRes) listRes.innerHTML = ""; 
                if(editGridFull) editGridFull.innerHTML = ""; // Clear new editor grids
                if(editGridRes) editGridRes.innerHTML = "";
                
                if(statSel) statSel.innerHTML = '<option value="">-- SELECT DRIVER --</option>'; 
                if(statSelA) statSelA.innerHTML = '<option value="">Select Driver A</option>'; 
                if(statSelB) statSelB.innerHTML = '<option value="">Select Driver B</option>'; 
                
                allDrivers = [];
                snap.forEach(d => { const data = d.data(); data.id = d.id; driversCache[d.id] = data; allDrivers.push(data); });
                allDrivers.sort((a, b) => {
                    const idxA = TEAMS.findIndex(t => t.id === a.team);
                    const idxB = TEAMS.findIndex(t => t.id === b.team);
                    if (idxA !== -1 && idxB !== -1 && idxA !== idxB) return idxA - idxB;
                    return a.name.localeCompare(b.name);
                });
                
                allDrivers.forEach(data => {
                    const teamColor = TEAM_COLORS[data.team] || '#94a3b8';
                    const teamObj = TEAMS.find(t => t.id === data.team);
                    const teamName = teamObj?.name || data.team;
                    const teamLogo = teamObj?.logo || "";
                    
                    const opt = `<option value="${data.id}">${data.name.toUpperCase()}</option>`;
                    
                    if(statSel) statSel.innerHTML += opt;
                    if(statSelA) statSelA.innerHTML += opt;
                    if(statSelB) statSelB.innerHTML += opt;

                    // HTML for Onboarding List
                    const onboardCard = `<div class="driver-card" style="--team-color:${teamColor}">
                        <div style="display:flex; align-items:center; gap:12px; position:relative; z-index:2;">
                            <input type="checkbox" class="driver-checkbox" value="${data.id}" style="transform:scale(1.2);">
                            ${teamLogo ? `<img src="${teamLogo}" class="admin-team-logo" alt="logo">` : ''}
                            <div class="driver-info"><h4>${data.name}</h4><p>${teamName}</p></div>
                        </div>
                        <button class="icon-btn delete" onclick="window.deleteDriver('${data.id}')"><i class="fas fa-trash"></i></button>
                    </div>`;

                    // HTML for Editor Selection
                    const editorCard = `<div class="driver-card" style="--team-color:${teamColor}; cursor:pointer;" onclick="loadDriverData('${data.id}')">
                        <div style="display:flex; align-items:center;">
                            ${teamLogo ? `<img src="${teamLogo}" class="admin-team-logo" alt="logo">` : ''}
                            <div class="driver-info"><h4>${data.name}</h4><p>${teamName}</p></div>
                        </div>
                        <div style="position:relative; z-index:2; font-family:var(--font-display); font-size:1.2rem; color:var(--accent-cyan); font-weight:800;">${data.totalPoints} PTS</div>
                    </div>`;

                    if(data.team === 'reserve') {
                        if(listRes) listRes.innerHTML += onboardCard;
                        if(editGridRes) editGridRes.innerHTML += editorCard;
                    } else {
                        if(listFull) listFull.innerHTML += onboardCard;
                        if(editGridFull) editGridFull.innerHTML += editorCard;
                    }
                });
                
                if(document.getElementById("raceDirectorGrid") && document.getElementById("raceDirectorGrid").style.display === "block") loadRaceGrid();
                const currentEditId = document.getElementById("editorDriverIdHidden") ? document.getElementById("editorDriverIdHidden").value : null;
                if(currentEditId && document.getElementById("editor-area") && document.getElementById("editor-area").style.display === "block" && driversCache[currentEditId]) loadDriverData(currentEditId);
                updateDashboard();
                window.updateLiveTables(); 
                
                const mode = document.getElementById('statsMode') ? document.getElementById('statsMode').value : 'individual';
                if(mode !== 'individual') renderStats(); 
            });
        }

        // ================== RESULT GENERATOR LOGIC (IIFE) ==================
        (function() {
            // --- CONFIGURATION ---
            // Fixed base URL for GitHub Raw content
            const BASE_URL = "https://raw.githubusercontent.com/HARISHWINNER/TTRL-RESOURCES/1de52755d3c67ebb0917c0fcc67ee3ed7bee1a4a/";

            const rg_teamLogos = {
                "Mercedes": BASE_URL + "LOGOS/Mini%20logos/mercedes.png",
                "Red Bull": BASE_URL + "LOGOS/Mini%20logos/redbull.png",
                "Ferrari": BASE_URL + "LOGOS/Mini%20logos/ferrari.png",
                "McLaren": BASE_URL + "LOGOS/Mini%20logos/mclaren.png",
                "Alpine": BASE_URL + "LOGOS/Mini%20logos/alpine.png",
                "Aston Martin": BASE_URL + "LOGOS/Mini%20logos/aston.png", 
                "Williams": BASE_URL + "LOGOS/Mini%20logos/williams.png",
                "Haas": BASE_URL + "LOGOS/Mini%20logos/haas.png",
                "Kick Sauber": BASE_URL + "LOGOS/Mini%20logos/kick_sauber.png",
                "Racing Bulls": BASE_URL + "LOGOS/Mini%20logos/racing_bulls.png",
                "Other": "https://placehold.co/200x80/21202e/ffffff?text=TEAM"
            };
            
            const rg_winnerTeamLogos = {
                "Mercedes": BASE_URL + "LOGOS/mercedes.png",
                "Red Bull": BASE_URL + "LOGOS/redbull.png",
                "Ferrari": BASE_URL + "LOGOS/ferrari.png",
                "McLaren": BASE_URL + "LOGOS/mclaren.png",
                "Alpine": BASE_URL + "LOGOS/alpine.png",
                "Aston Martin": BASE_URL + "LOGOS/martin.png", 
                "Williams": BASE_URL + "LOGOS/williams.png",
                "Haas": BASE_URL + "LOGOS/haas.png",
                "Kick Sauber": BASE_URL + "LOGOS/kick_sauber.png",
                "Racing Bulls": BASE_URL + "LOGOS/vcarb.png",
                "Other": "https://placehold.co/200x80/21202e/ffffff?text=TEAM"
            };

            const rg_teamFullNames = {
                "Mercedes": "MERCEDES", "Red Bull": "RED BULL RACING HONDA RBPT", "Ferrari": "FERRARI", "McLaren": "MCLAREN MERCEDES",
                "Alpine": "ALPINE RENAULT", "Aston Martin": "ASTON MARTIN MERCEDES", "Williams": "WILLIAMS MERCEDES",
                "Haas": "HAAS FERRARI", "Kick Sauber": "KICK SAUBER FERRARI", "Racing Bulls": "RACING BULLS HONDA RBPT", "Other": "TEAM NAME"
            };
            const rg_csvMap = {
                "mercedes-amg petronas": "Mercedes", "red bull": "Red Bull", "scuderia ferrari hp": "Ferrari", "mclaren": "McLaren",
                "alpine": "Alpine", "aston martin": "Aston Martin", "williams": "Williams", "haas": "Haas", "kick sauber": "Kick Sauber",
                "visa cash app racing bulls": "Racing Bulls"
            };
            const rg_initialDrivers = Array.from({ length: 20 }, (_, i) => ({
                 driver: 'PLAYER NAME', team: 'Other', grid: i + 1, stops: 2, bestLap: '1:11:546', time: '45:47.690', points: i < 10 ? `+${[25,18,15,12,10,8,6,4,2,1][i]}` : '0'
            }));

            // --- DOM ELEMENTS (Namespaced) ---
            const el = {
                inputs: document.getElementById('rg_race-inputs'), previewBody: document.getElementById('rg_preview-race-body'),
                downloadBtn: document.getElementById('rg_downloadBtn'), resetBtn: document.getElementById('rg_resetBtn'),
                card: document.getElementById('rg_result-card'), ppDriver: document.getElementById('rg_pp_driver'),
                ppTeam: document.getElementById('rg_pp_team'), importFile: document.getElementById('rg_importFile'),
                leagueName: document.getElementById('rg_leagueName'), trackName: document.getElementById('rg_trackName'),
                ppTime: document.getElementById('rg_pp_time'), winnerLogo: document.getElementById('rg_winner-logo-placeholder'),
                winnerName: document.getElementById('rg_winner-name'), winnerTeam: document.getElementById('rg_winner-team'),
                previewPP: document.getElementById('rg_preview-pp'), previewTitle: document.getElementById('rg_preview-title')
            };

            const ROW_HEIGHT = 24.5;
            const coords = { pos: { x: 125 }, driver: { x: 396 }, team: { x: 1028 }, grid: { x: 1648 }, stop: { x: 1780 }, best: { x: 1985 }, time: { x: 2270 }, points: { x: 2625 } };
            const COORD_SCALE = 3;

            function init() {
                if(!el.ppTeam) return; // Guard clause if elements don't exist yet
                el.ppTeam.innerHTML = Object.keys(rg_teamLogos).map(team => `<option value="${team}">${team}</option>`).join('');
                document.getElementById('result-generator').addEventListener('input', updatePreview);
                el.downloadBtn.addEventListener('click', downloadImage);
                el.resetBtn.addEventListener('click', resetData);
                el.importFile.addEventListener('change', handleFileUpload);
                el.ppDriver.addEventListener('change', handlePoleDriverChange);
                document.fonts.load('900 33px "Orbitron"').catch(()=>{});
                document.fonts.load('400 11px "Inter"').catch(()=>{});
                resetData();
            }

            function resetData() {
                el.inputs.innerHTML = ''; 
                for (let i = 0; i < 20; i++) {
                    const data = rg_initialDrivers[i] || { driver: 'PLAYER NAME', team: 'Other', grid: i + 1, stops: 2, bestLap: '', time: '', points: '0' };
                    createRow(data, i);
                }
                el.leagueName.value = "TTRL SEASON 1"; el.trackName.value = "(TRACK NAME) GP 2025";
                el.ppTime.value = '1:10.123'; el.ppTeam.value = "Other";
                updatePreview();
            }

            function createRow(data, i) {
                const div = document.createElement('div');
                div.className = 'tw-grid tw-grid-cols-12 tw-gap-1 tw-items-center tw-bg-gray-700/50 tw-p-1 tw-rounded hover:tw-bg-gray-700 tw-transition-colors';
                const teamOpts = Object.keys(rg_teamLogos).map(t => `<option value="${t}" ${data.team === t ? 'selected' : ''}>${t}</option>`).join('');
                div.innerHTML = `
                    <span class="tw-col-span-1 tw-text-xs tw-text-gray-400 tw-text-center tw-font-mono">${i + 1}</span>
                    <input data-idx="${i}" data-f="driver" type="text" value="${data.driver}" class="tw-col-span-3 tw-bg-gray-600 tw-rounded tw-px-1 tw-py-1 tw-text-xs tw-uppercase tw-text-white tw-outline-none focus:tw-ring-1 focus:tw-ring-blue-500">
                    <select data-idx="${i}" data-f="team" class="tw-col-span-2 tw-bg-gray-600 tw-rounded tw-px-1 tw-py-1 tw-text-[10px] tw-text-white tw-outline-none">${teamOpts}</select>
                    <input data-idx="${i}" data-f="grid" type="text" value="${data.grid}" class="tw-col-span-1 tw-bg-gray-600 tw-rounded tw-px-1 tw-py-1 tw-text-xs tw-text-center tw-text-white tw-outline-none">
                    <input data-idx="${i}" data-f="stops" type="text" value="${data.stops}" class="tw-col-span-1 tw-bg-gray-600 tw-rounded tw-px-1 tw-py-1 tw-text-xs tw-text-center tw-text-white tw-outline-none">
                    <input data-idx="${i}" data-f="time" type="text" value="${data.time}" class="tw-col-span-2 tw-bg-gray-600 tw-rounded tw-px-1 tw-py-1 tw-text-xs tw-text-center tw-text-white tw-outline-none tw-placeholder-gray-500" placeholder="Time">
                    <input data-idx="${i}" data-f="bestLap" type="text" value="${data.bestLap}" class="tw-col-span-1 tw-bg-gray-600 tw-rounded tw-px-1 tw-py-1 tw-text-xs tw-text-center tw-text-white tw-outline-none tw-placeholder-gray-500" placeholder="Fastest">
                    <input data-idx="${i}" data-f="points" type="text" value="${data.points}" class="tw-col-span-1 tw-bg-gray-600 tw-rounded tw-px-1 tw-py-1 tw-text-xs tw-text-center tw-font-bold tw-text-yellow-400 tw-outline-none">
                `;
                el.inputs.appendChild(div);
            }

            function updatePreview() {
                el.previewTitle.textContent = `${el.leagueName.value} ${el.trackName.value}`;
                const currPP = el.ppDriver.value;
                el.ppDriver.innerHTML = '<option value="PLAYER NAME">Select Driver...</option>';
                const rows = [];
                for(let i=0; i<20; i++) {
                    const dInput = document.querySelector(`[data-idx="${i}"][data-f="driver"]`);
                    if(!dInput) break; 
                    const driverVal = dInput.value.toUpperCase();
                    if(driverVal && driverVal !== 'PLAYER NAME') {
                        const opt = document.createElement('option');
                        opt.value = driverVal; opt.textContent = driverVal; el.ppDriver.appendChild(opt);
                    }
                    if(!driverVal || !driverVal.trim()) break;
                    rows.push({
                        driver: driverVal, team: document.querySelector(`[data-idx="${i}"][data-f="team"]`).value,
                        grid: document.querySelector(`[data-idx="${i}"][data-f="grid"]`).value, stops: document.querySelector(`[data-idx="${i}"][data-f="stops"]`).value,
                        bestLap: document.querySelector(`[data-idx="${i}"][data-f="bestLap"]`).value, points: document.querySelector(`[data-idx="${i}"][data-f="points"]`).value,
                        time: document.querySelector(`[data-idx="${i}"][data-f="time"]`).value
                    });
                }
                if ([...el.ppDriver.options].some(o => o.value === currPP)) el.ppDriver.value = currPP; else el.ppDriver.value = "PLAYER NAME";
                el.previewBody.innerHTML = '';
                let winner = null;
                rows.forEach((data, i) => {
                    if (i === 0) winner = data;
                    const tr = document.createElement('tr');
                    const txtColor = (i === 0) ? '#000000' : '#f0f0f0';
                    tr.innerHTML = `
                        <td class="rg_cell-center" style="left:${coords.pos.x/COORD_SCALE}px; width:50px; color:${txtColor};">${i+1}</td>
                        <td style="left:${coords.driver.x/COORD_SCALE}px; width:154px; color:${txtColor};">${data.driver}</td>
                        <td class="rg_td-team" style="left:${coords.team.x/COORD_SCALE}px; width:285px; color:${txtColor};">
                            <img src="${rg_teamLogos[data.team] || rg_teamLogos['Other']}" class="rg_team-logo"><span>${rg_teamFullNames[data.team] || data.team}</span>
                        </td>
                        <td class="rg_cell-center" style="left:${coords.grid.x/COORD_SCALE}px; width:48px; color:${txtColor};">${data.grid}</td>
                        <td class="rg_cell-center" style="left:${coords.stop.x/COORD_SCALE}px; width:60px; color:${txtColor};">${data.stops}</td>
                        <td class="rg_cell-center" style="left:${coords.best.x/COORD_SCALE}px; width:96px; color:${txtColor};">${data.bestLap}</td>
                        <td class="rg_cell-center" style="left:${coords.time.x/COORD_SCALE}px; width:109px; color:${txtColor};">${data.time}</td>
                        <td class="rg_cell-center" style="left:${coords.points.x/COORD_SCALE}px; width:40px; color:${txtColor};">${data.points}</td>
                    `;
                    el.previewBody.appendChild(tr);
                });
                if(winner) {
                    el.winnerLogo.src = rg_winnerTeamLogos[winner.team] || rg_winnerTeamLogos['Other'];
                    el.winnerLogo.onerror = () => { el.winnerLogo.src = rg_winnerTeamLogos['Other']; };
                    el.winnerName.textContent = winner.driver; el.winnerTeam.textContent = rg_teamFullNames[winner.team] || winner.team;
                } else {
                    el.winnerLogo.src = "https://placehold.co/200x80/21202e/ffffff?text=TEAM+LOGO"; el.winnerName.textContent = ""; el.winnerTeam.textContent = "";
                }
                const pp = { d: el.ppDriver.value, t: el.ppTeam.value, time: el.ppTime.value };
                let ppTxt = '';
                if (pp.d && pp.d !== 'PLAYER NAME') ppTxt += pp.d;
                if (pp.t && pp.t !== 'Other') ppTxt += (ppTxt ? ' | ' : '') + (rg_teamFullNames[pp.t] || pp.t);
                if (pp.time) ppTxt += (ppTxt ? ' | ' : '') + pp.time;
                el.previewPP.textContent = ppTxt;
            }

            function handlePoleDriverChange() {
                const sel = el.ppDriver.value;
                if(sel && sel !== 'PLAYER NAME') {
                    for(let i=0; i<20; i++) {
                         const dVal = document.querySelector(`[data-idx="${i}"][data-f="driver"]`);
                         if(dVal && dVal.value.toUpperCase() === sel) {
                             el.ppTeam.value = document.querySelector(`[data-idx="${i}"][data-f="team"]`).value;
                             el.ppTime.value = document.querySelector(`[data-idx="${i}"][data-f="bestLap"]`).value;
                             break;
                         }
                    }
                }
                updatePreview();
            }

            function handleFileUpload(e) {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (ev) => parseCSV(ev.target.result);
                r.readAsText(f);
                e.target.value = '';
            }

            function parseCSV(txt) {
                try {
                    const lines = txt.trim().split(/\r?\n/);
                    const hLine = lines.find(l => l.startsWith('"Pos."'));
                    if(!hLine) { alert("Invalid CSV: Header 'Pos.' not found."); return; }
                    const headers = hLine.split(',').map(h => h.trim().replace(/"/g, ''));
                    const map = { d: headers.indexOf('Driver'), t: headers.indexOf('Team'), g: headers.indexOf('Grid'), s: headers.indexOf('Stops'), b: headers.indexOf('Best'), ti: headers.indexOf('Time'), p: headers.indexOf('Pts.') };
                    if(Object.values(map).includes(-1)) { alert("CSV missing required columns."); return; }
                    const start = lines.indexOf(hLine) + 1;
                    let count = 0;
                    for(let i=start; i<lines.length && count<20; i++) {
                        const l = lines[i];
                        if(!l || !l.trim()) continue;
                        const v = l.split(',').map(val => val.trim().replace(/"/g, ''));
                        if(isNaN(parseInt(v[0]))) break;
                        const teamKey = rg_csvMap[(v[map.t]||'').toLowerCase()] || 'Other';
                        document.querySelector(`[data-idx="${count}"][data-f="driver"]`).value = v[map.d] || 'PLAYER NAME';
                        document.querySelector(`[data-idx="${count}"][data-f="team"]`).value = teamKey;
                        document.querySelector(`[data-idx="${count}"][data-f="grid"]`).value = v[map.g] || (count+1);
                        document.querySelector(`[data-idx="${count}"][data-f="stops"]`).value = v[map.s] || 0;
                        document.querySelector(`[data-idx="${count}"][data-f="bestLap"]`).value = v[map.b] || '';
                        document.querySelector(`[data-idx="${count}"][data-f="time"]`).value = v[map.ti] || '';
                        document.querySelector(`[data-idx="${count}"][data-f="points"]`).value = parseInt(v[map.p]) > 0 ? `+${v[map.p]}` : '0';
                        count++;
                    }
                    for(let i=count; i<20; i++) {
                        document.querySelector(`[data-idx="${i}"][data-f="driver"]`).value = 'PLAYER NAME';
                        document.querySelector(`[data-idx="${i}"][data-f="team"]`).value = 'Other';
                        document.querySelector(`[data-idx="${i}"][data-f="grid"]`).value = i+1;
                        document.querySelector(`[data-idx="${i}"][data-f="stops"]`).value = 0;
                        document.querySelector(`[data-idx="${i}"][data-f="bestLap"]`).value = '';
                        document.querySelector(`[data-idx="${i}"][data-f="time"]`).value = '';
                        document.querySelector(`[data-idx="${i}"][data-f="points"]`).value = '0';
                    }
                    updatePreview();
                } catch(err) { console.error(err); alert("CSV Parse Error"); }
            }

            async function downloadImage() {
                el.downloadBtn.textContent = 'Processing...'; el.downloadBtn.disabled = true;
                try {
                    await document.fonts.ready;
                    const imgs = Array.from(el.card.querySelectorAll('img'));
                    await Promise.all(imgs.map(img => { if(img.complete) return Promise.resolve(); return new Promise(r => { img.onload=r; img.onerror=r; }); }));
                    await new Promise(r => setTimeout(r, 200));
                    const canvas = await html2canvas(el.card, { scale: 2, backgroundColor: null, useCORS: true, logging: false });
                    const link = document.createElement('a');
                    link.download = `Results_${el.trackName.value.replace(/[^a-z0-9]/gi, '_')}.png`;
                    link.href = canvas.toDataURL("image/png");
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                } catch(err) { console.error(err); alert("Image Generation Failed"); }
                finally { el.downloadBtn.innerHTML = '<i class="fas fa-download tw-mr-2"></i>Download'; el.downloadBtn.disabled = false; }
            }

            // Init call
            setTimeout(init, 500); // Small delay to ensure DOM is ready
        })();
    </script>
</body>
</html>
