<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTRL | Mission Control</title>
    
    <!-- Fonts: Clean & Professional -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@500;700;800&family=JetBrains+Mono:wght@500;700&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            /* --- VIBRANT LIGHT PALETTE --- */
            --bg-body: #e2e8f0;      
            --bg-panel: #ffffff;
            --bg-header: #f8fafc;
            
            --sidebar-bg: #0f172a;   
            --sidebar-text: #94a3b8;
            --sidebar-text-active: #ffffff;
            
            --border-dim: #e2e8f0;
            --border-light: #cbd5e1;
            
            --accent-cyan: #0ea5e9;  
            --accent-red: #ef4444;   
            --accent-green: #10b981; 
            --accent-yellow: #f59e0b; 
            --accent-purple: #8b5cf6; 
            
            --text-primary: #1e293b;  
            --text-secondary: #475569; 
            --text-muted: #94a3b8;    

            --font-display: 'Manrope', sans-serif; 
            --font-ui: 'Inter', sans-serif;
            --font-data: 'JetBrains Mono', monospace;

            --sidebar-width: 260px;
            --sidebar-width-collapsed: 72px;
            --header-height: 70px;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- LAYOUT --- */
        .app-layout { display: flex; height: 100vh; width: 100vw; opacity: 0; transition: opacity 0.5s ease; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); background: var(--sidebar-bg); border-right: 1px solid #1e293b;
            display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50; box-shadow: var(--shadow-md);
        }
        .sidebar.collapsed { width: var(--sidebar-width-collapsed); }
        .logo-area { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; border-bottom: 1px solid rgba(255,255,255,0.1); gap: 12px; overflow: hidden; background: rgba(0,0,0,0.2); }
        .logo-img { height: 36px; width: auto; object-fit: contain; }
        .logo-text { font-family: var(--font-display); font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; white-space: nowrap; color: #fff; }
        .sidebar.collapsed .logo-text { opacity: 0; pointer-events: none; }
        .nav-links { flex: 1; padding: 20px 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .nav-group-label { font-size: 0.7rem; color: rgba(255,255,255,0.4); font-weight: 700; padding: 16px 16px 8px; letter-spacing: 1px; font-family: var(--font-ui); text-transform: uppercase; }
        .sidebar.collapsed .nav-group-label { display: none; }
        .nav-btn { display: flex; align-items: center; padding: 12px 16px; color: var(--sidebar-text); text-decoration: none; border-radius: 8px; transition: all 0.2s; cursor: pointer; font-weight: 500; font-size: 0.9rem; position: relative; overflow: hidden; font-family: var(--font-ui); }
        .nav-btn i { width: 24px; text-align: center; font-size: 1.1rem; margin-right: 12px; transition: color 0.2s; }
        .nav-btn span { white-space: nowrap; transition: opacity 0.2s; }
        .sidebar.collapsed .nav-btn span { opacity: 0; width: 0; }
        .sidebar.collapsed .nav-btn i { margin-right: 0; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-btn.active { background: var(--accent-cyan); color: #fff; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4); }
        .nav-btn.active i { color: #fff; }
        .user-panel { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); }
        .user-panel-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .user-name { font-family: var(--font-display); font-size: 0.95rem; font-weight: 700; color: #fff; white-space: nowrap; }
        .user-role { font-size: 0.7rem; color: var(--accent-cyan); font-family: var(--font-data); font-weight: 600; background: rgba(14, 165, 233, 0.2); padding: 2px 6px; border-radius: 4px; }
        .sidebar.collapsed .user-panel-row { display: none; }
        .sidebar.collapsed .user-panel .btn { justify-content: center; padding: 10px; }
        .sidebar.collapsed .user-panel .btn span { display: none; }
        .sidebar.collapsed .user-panel .btn i { margin: 0; }

        /* --- MAIN WRAPPER --- */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-bar { height: var(--header-height); border-bottom: 1px solid var(--border-dim); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; background: #fff; box-shadow: var(--shadow-sm); z-index: 40; }
        .toggle-sidebar { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .toggle-sidebar:hover { color: var(--accent-cyan); transform: scale(1.1); }
        .season-control { display: flex; align-items: center; gap: 12px; background: #f1f5f9; padding: 6px 16px; border: 1px solid var(--border-dim); border-radius: 8px; }
        .season-label { font-family: var(--font-ui); font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; }
        .season-input { background: none; border: none; color: var(--text-primary); font-family: var(--font-display); font-weight: 800; font-size: 1rem; text-transform: uppercase; width: 100px; text-align: center; }
        .season-input:focus { color: var(--accent-cyan); }
        .action-cluster { display: flex; gap: 12px; }

        /* --- COMPONENTS --- */
        .btn { background: #fff; border: 1px solid var(--border-dim); color: var(--text-secondary); padding: 8px 16px; font-family: var(--font-ui); font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-sm); border-radius: 6px; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { border-color: var(--border-light); color: var(--text-primary); background: #f8fafc; transform: translateY(-1px); }
        .btn-primary { background: var(--accent-cyan); color: #fff; border: 1px solid var(--accent-cyan); }
        .btn-primary:hover { background: #0284c7; color: #fff; border-color: #0284c7; box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.4); }
        .btn-danger { color: var(--accent-red); border-color: #fecaca; background: #fef2f2; }
        .btn-danger:hover { background: var(--accent-red); color: #fff; border-color: var(--accent-red); }
        .btn-success { color: var(--accent-green); border-color: #a7f3d0; background: #ecfdf5; }
        .btn-success:hover { background: var(--accent-green); color: #fff; border-color: var(--accent-green); }

        .workspace { flex: 1; padding: 32px; overflow-y: auto; position: relative; }
        .section { display: none; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .panel { background: #fff; border: 1px solid var(--border-dim); border-radius: 12px; margin-bottom: 24px; position: relative; overflow: hidden; box-shadow: var(--shadow-sm); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; background: var(--bg-header); padding: 16px 24px; border-bottom: 1px solid var(--border-dim); }
        .panel-body { padding: 24px; }
        .panel-title { font-family: var(--font-display); font-size: 1rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .panel-title i { color: var(--accent-cyan); font-size: 1.1rem; }

        .dashboard-grid-full { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .dashboard-split { display: grid; grid-template-columns: 3fr 2fr; gap: 24px; height: calc(100vh - 140px); min-height: 600px; }
        .dash-left { overflow-y: auto; display: flex; flex-direction: column; gap: 24px; padding-right: 5px; }
        .dash-right { position: relative; background: rgba(0,0,0,0.4); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-dim); }

        .stat-card { background: #fff; border: 1px solid var(--border-dim); padding: 24px; border-radius: 12px; position: relative; overflow: hidden; transition: transform 0.2s; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; justify-content: space-between; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .stat-icon { position: absolute; right: -10px; top: -10px; font-size: 6rem; opacity: 0.1; transform: rotate(15deg); color: var(--text-primary); }
        .stat-label { font-family: var(--font-ui); font-size: 0.75rem; color: var(--text-secondary); letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        .stat-value { font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; color: var(--text-primary); line-height: 1; }
        .stat-footer { margin-top: 12px; font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; font-family: var(--font-ui); font-weight: 600; }
        
        .card-accent-blue { background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%); border-top: 4px solid var(--accent-cyan); }
        .card-accent-red { background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%); border-top: 4px solid var(--accent-red); }
        .card-accent-green { background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border-top: 4px solid var(--accent-green); }
        .card-accent-purple { background: linear-gradient(135deg, #ffffff 0%, #f5f3ff 100%); border-top: 4px solid var(--accent-purple); }

        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-family: var(--font-ui); font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; font-weight: 700; }
        .form-control { width: 100%; background: #f8fafc; border: 1px solid var(--border-dim); color: var(--text-primary); padding: 10px 14px; font-family: var(--font-ui); font-size: 0.95rem; border-radius: 6px; transition: all 0.2s; font-weight: 500; }
        .form-control:focus { border-color: var(--accent-cyan); background: #fff; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }

        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        /* Updated Driver Card: Outer Border Color */
        .driver-card { background: #fff; border: 2px solid var(--team-color, #94a3b8); border-radius: 8px; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
        .driver-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .driver-info { position: relative; z-index: 2; }
        .driver-info h4 { font-family: var(--font-display); font-size: 1.1rem; margin: 0; font-weight: 700; color: var(--text-primary); }
        .driver-info p { font-family: var(--font-ui); font-size: 0.8rem; color: var(--team-color); filter: brightness(0.8); margin: 4px 0 0; text-transform: uppercase; font-weight: 800; }
        
        /* High Z-Index for Delete button so it floats above any potential overlaps */
        .icon-btn { position: relative; z-index: 10; background: #fff; border: 1px solid var(--border-dim); color: var(--text-muted); width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: 0.2s; }
        .icon-btn:hover { background: #f1f5f9; color: var(--text-primary); border-color: var(--accent-cyan); }
        .icon-btn.delete:hover { background: #fef2f2; border-color: #fecaca; color: var(--accent-red); }
        
        /* Team Strip for Editor Rows */
        .team-strip { width: 8px; height: 100%; position: absolute; left: 0; top: 0; background: var(--team-color, #ccc); }

        .tech-table { width: 100%; border-collapse: separate; border-spacing: 0; font-family: var(--font-ui); font-size: 0.9rem; }
        .tech-table th { text-align: left; padding: 16px 20px; color: var(--text-secondary); font-family: var(--font-ui); font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid var(--border-dim); font-weight: 800; letter-spacing: 0.5px; background: #f8fafc; }
        .tech-table td { padding: 14px 20px; border-bottom: 1px solid var(--border-dim); color: var(--text-primary); font-weight: 500; }
        .tech-table tr:hover td { background: #f8fafc; }
        .tech-table tr:last-child td { border-bottom: none; }

        /* --- MODALS & TOAST --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #fff; border: 1px solid var(--border-dim); width: 90%; max-width: 480px; padding: 32px; border-radius: 16px; box-shadow: var(--shadow-lg); text-align: center; }
        .modal-title { font-family: var(--font-display); font-size: 1.5rem; color: var(--text-primary); margin-bottom: 12px; font-weight: 800; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #0f172a; border: 1px solid #1e293b; border-left: 5px solid var(--accent-green); padding: 16px 24px; color: #ffffff; transform: translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000; font-family: var(--font-ui); font-weight: 600; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast i { color: var(--accent-green); font-size: 1.1rem; }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; inset: 0; z-index: 999; background: #f1f5f9; display: flex; align-items: center; justify-content: center; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        .login-card { width: 420px; padding: 48px; background: #fff; border: 1px solid var(--border-dim); border-top: 4px solid var(--accent-cyan); box-shadow: var(--shadow-lg); border-radius: 12px; text-align: center; }
        .login-logo { height: 64px; margin-bottom: 24px; }

        @media (max-width: 900px) {
            .app-layout { flex-direction: column; height: auto; min-height: 100vh; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border-dim); }
            .sidebar.collapsed .nav-links { display: none; }
            .main-wrapper { height: auto; overflow: visible; }
            .top-bar { padding: 0 20px; flex-direction: column; height: auto; padding-bottom: 15px; gap: 12px; }
            .action-cluster { flex-wrap: wrap; justify-content: center; }
            .nav-links { flex-direction: row; overflow-x: auto; padding: 12px; }
            .nav-btn span { display: none; } 
            .nav-btn i { margin: 0; font-size: 1.2rem; }
            .workspace { padding: 20px; }
        }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/image.png" class="login-logo" alt="TTRL">
            <h2 class="modal-title">PITWALL ACCESS</h2>
            <p style="color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 32px; font-weight: 500;">Secure Management Console</p>
            <button id="auth-btn-google" class="btn btn-primary" onclick="window.loginWithGoogle()" style="width: 100%; justify-content: center; margin-bottom: 20px; font-size: 1rem; padding: 12px;">
                <i class="fab fa-google"></i> AUTHENTICATE WITH GOOGLE
            </button>
            <div style="display: flex; align-items: center; gap: 12px; margin: 24px 0;">
                <div style="flex:1; height:1px; background:var(--border-dim)"></div>
                <span style="font-size:0.75rem; color:var(--text-muted); font-weight: 700; letter-spacing: 0.5px;">OR MANUAL LOGIN</span>
                <div style="flex:1; height:1px; background:var(--border-dim)"></div>
            </div>
            <input type="email" id="loginEmail" class="form-control" placeholder="Operator ID" style="margin-bottom: 12px; text-align:center;">
            <input type="password" id="loginPass" class="form-control" placeholder="Access Key" style="margin-bottom: 24px; text-align:center;">
            <button id="auth-btn-manual" class="btn" onclick="window.checkLogin()" style="width: 100%; justify-content: center; background: #fff; color: var(--text-primary); border: 1px solid var(--border-light); padding: 12px;">
                INITIALIZE CONNECTION
            </button>
            <div id="login-msg" style="margin-top: 16px; color: var(--accent-red); font-size: 0.85rem; font-family: var(--font-ui); font-weight: 600;"></div>
            <div id="script-status" style="margin-top: 10px; font-size: 0.7rem; color: var(--accent-green); display:none;">SYSTEM ONLINE</div>
        </div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div class="app-layout" id="main-interface" style="display:none;">
        <nav class="sidebar" id="appSidebar">
            <div class="logo-area"><img src="https://raw.githubusercontent.com/S-HARISH44/TTRL/452f1b2138a6e81e13d957a448e4de317d9f8201/RESOURCES/image.png" class="logo-img" alt="Logo"><div class="logo-text">PITWALL</div></div>
            <div class="nav-links">
                <div class="nav-group-label">OVERVIEW</div>
                <a class="nav-btn active" onclick="window.switchTab('dashboard')"><i class="fas fa-gauge-high"></i> <span>DASHBOARD</span></a>
                <a class="nav-btn" onclick="window.switchTab('live-view')"><i class="fas fa-tower-broadcast"></i> <span>LIVE TELEMETRY</span></a>
                <a class="nav-btn" onclick="window.switchTab('driver-stats')"><i class="fas fa-chart-pie"></i> <span>ANALYTICS</span></a>
                <div class="nav-group-label">OPERATIONS</div>
                <a class="nav-btn" onclick="window.switchTab('season-setup')"><i class="fas fa-calendar-days"></i> <span>CALENDAR EDITOR</span></a>
                <a class="nav-btn" onclick="window.switchTab('manage-drivers')"><i class="fas fa-user-plus"></i> <span>DRIVER ONBOARD</span></a>
                <a class="nav-btn" onclick="window.switchTab('driver-editor')"><i class="fas fa-user-pen"></i> <span>DRIVER EDITOR</span></a>
                <a class="nav-btn" onclick="window.switchTab('race-director')"><i class="fas fa-flag-checkered"></i> <span>RACE EDITOR</span></a>
            </div>
            <div class="user-panel"><div class="user-panel-row"><div class="user-name" id="userName">OPERATOR</div><div class="user-role">ADMIN</div></div><button class="btn btn-danger" onclick="window.logout()" style="width: 100%; justify-content: center; font-size: 0.75rem;"><i class="fas fa-power-off"></i> <span>DISCONNECT</span></button></div>
        </nav>

        <div class="main-wrapper">
            <header class="top-bar">
                <div style="display: flex; align-items: center; gap: 20px;"><button class="toggle-sidebar" onclick="window.toggleSidebar()"><i class="fas fa-bars"></i></button><div class="season-control"><span class="season-label">ACTIVE SEASON:</span><input type="text" id="seasonInput" class="season-input" value="season_1" onchange="window.changeSeason()"><button class="icon-btn" onclick="window.changeSeason()"><i class="fas fa-sync-alt"></i></button></div><div id="knownSeasonsList" style="font-family: var(--font-data); font-size: 0.75rem; color: var(--text-muted);"></div></div>
                <div class="action-cluster"><button class="btn" onclick="window.openMigrationModal()"><i class="fas fa-exchange-alt"></i> MIGRATE</button><button class="btn" onclick="window.triggerImport()"><i class="fas fa-file-import"></i> IMPORT CSV</button><button class="btn" onclick="window.exportData()"><i class="fas fa-download"></i> BACKUP</button><input type="file" id="csvFile" accept=".csv" style="display:none" onchange="window.handleFileSelect(this)"></div>
            </header>

            <div class="workspace">
                <div id="dashboard" class="section active">
                    <div class="panel-header" style="border:none; margin-bottom: 10px;"><div><h2 style="font-family:var(--font-display); font-weight:800; font-size:1.8rem; color:var(--text-primary); margin:0;">MISSION OVERVIEW</h2><div style="font-family:var(--font-ui); color:var(--text-secondary); font-size:0.9rem;" id="dashNextDate">SEASON ACTIVE</div></div></div>
                    <div class="dashboard-grid-full">
                        <div class="stat-card card-accent-blue"><i class="fas fa-users stat-icon"></i><div class="stat-label">GRID SIZE</div><div class="stat-value" id="dashDriverCount">0</div><div class="stat-footer positive"><i class="fas fa-check"></i> Active Drivers</div></div>
                        <div class="stat-card card-accent-green"><i class="fas fa-map-location-dot stat-icon"></i><div class="stat-label">CALENDAR</div><div class="stat-value" id="dashTrackCount">0</div><div class="stat-footer"><i class="fas fa-flag"></i> Scheduled Races</div></div>
                        <div class="stat-card card-accent-purple"><i class="fas fa-trophy stat-icon" style="color: var(--accent-purple); opacity: 0.1;"></i><div class="stat-label">LEADER</div><div class="stat-value" id="dashLeader" style="font-size:1.5rem;">--</div><div class="stat-footer highlight" id="dashLeaderPts" style="color:var(--accent-purple);">0 PTS</div></div>
                        <div class="stat-card card-accent-red"><i class="fas fa-cogs stat-icon" style="color: var(--accent-red); opacity: 0.1;"></i><div class="stat-label">TOP TEAM</div><div class="stat-value" id="dashTeamLeader" style="font-size:1.5rem;">--</div><div class="stat-footer highlight" style="color: var(--accent-red);" id="dashTeamPts">0 PTS</div></div>
                    </div>
                    <div class="dashboard-grid-full" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="stat-card" style="background:#fff; border-left: 4px solid var(--accent-yellow);"><div style="display:flex; align-items:center; gap:15px;"><div style="font-size:2.5rem; color:var(--accent-yellow);"><i class="fas fa-stopwatch"></i></div><div><div class="stat-label" style="margin:0;">FASTEST LAP</div><div style="font-size:1.2rem; font-weight:800; color:var(--text-primary);">N/A</div></div></div></div>
                        <div class="stat-card" style="background:#fff; border-left: 4px solid var(--accent-cyan);"><div style="display:flex; align-items:center; gap:15px;"><div style="font-size:2.5rem; color:var(--accent-cyan);"><i class="fas fa-cloud-sun"></i></div><div><div class="stat-label" style="margin:0;">CONDITIONS</div><div style="font-size:1.2rem; font-weight:800; color:var(--text-primary);">DRY</div></div></div></div>
                        <div class="stat-card" style="background:#fff; border-left: 4px solid var(--accent-green);"><div style="display:flex; align-items:center; gap:15px;"><div style="font-size:2.5rem; color:var(--accent-green);"><i class="fas fa-flag-checkered"></i></div><div><div class="stat-label" style="margin:0;">STATUS</div><div style="font-size:1.2rem; font-weight:800; color:var(--text-primary);">GREEN</div></div></div></div>
                    </div>
                    <div class="dashboard-grid-full" style="grid-template-columns: 2fr 1fr;">
                        <div class="panel">
                            <div class="panel-header"><div class="panel-title"><i class="fas fa-chart-line"></i> SEASON PROGRESS</div></div>
                            <div class="panel-body">
                                <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:12px;"><div class="stat-value" id="dashProgressPct" style="font-size:3rem;">0%</div><div class="stat-footer" id="dashRacesDone" style="font-size:1rem;">0 / 0 RACES</div></div>
                                <div style="width:100%; height:12px; background:#f1f5f9; border-radius:6px; overflow:hidden;"><div id="dashProgressBar" style="width:0%; height:100%; background:var(--accent-green); transition: width 1s ease;"></div></div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:30px;">
                                    <div class="stat-card" style="box-shadow:none; border:1px solid var(--border-dim); background:#f8fafc;"><div class="stat-label">NEXT EVENT</div><div class="stat-value" id="dashNextRace" style="font-size: 1.2rem;">--</div><div class="stat-footer"><i class="far fa-clock"></i> Scheduled</div></div>
                                    <div class="stat-card" style="box-shadow:none; border:1px solid var(--border-dim); background:#f8fafc;"><div class="stat-label">LATEST VICTOR</div><div class="stat-value" id="dashLastWinner" style="font-size: 1.2rem;">--</div><div class="stat-footer" id="dashLastGP">WAITING</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="panel" style="display:flex; flex-direction:column; min-height:400px;"><div class="panel-header"><div class="panel-title"><i class="far fa-calendar-alt"></i> SCHEDULE</div></div><div id="dashCalendarList" style="flex:1; overflow-y: auto; padding:0 24px 24px;"></div></div>
                    </div>
                </div>

                <div id="season-setup" class="section">
                    <div class="panel"><div class="panel-header"><div class="panel-title"><i class="fas fa-calendar-days"></i> CALENDAR EDITOR</div><div class="action-cluster"><button class="btn" onclick="window.toggleTrackSelectAll()">SELECT ALL</button><button class="btn btn-danger" onclick="window.deleteSelectedTracks()">DELETE</button></div></div><div class="panel-body"><div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 20px; margin-bottom: 25px; align-items: end;"><div><label class="input-label">SELECT CIRCUIT</label><select id="trackSelector" class="form-control"><option>LOADING...</option></select></div><div><label class="input-label">RACE DATE</label><input type="date" id="newTrackDate" class="form-control"></div><button class="btn btn-primary" onclick="window.addTrackConfig()" style="height: 46px;"><i class="fas fa-plus"></i></button></div><div id="trackConfigList" style="max-height: 500px; overflow-y: auto;"></div></div></div>
                </div>

                <div id="manage-drivers" class="section">
                    <div class="panel"><div class="panel-header"><div class="panel-title"><i class="fas fa-user-plus"></i> DRIVER ONBOARDING</div><div class="action-cluster"><button class="btn" onclick="window.toggleSelectAll()">SELECT ALL</button><button class="btn btn-danger" onclick="window.deleteSelectedDrivers()">DELETE SELECTED</button></div></div><div class="panel-body"><div style="margin-bottom:24px; display:flex; gap:12px;"><input type="text" id="newDriverName" class="form-control" placeholder="DRIVER NAME"><select id="newDriverTeam" class="form-control"></select><button class="btn btn-primary" onclick="window.registerDriver()">ADD</button></div><div id="driverList" class="data-grid"></div></div></div>
                </div>

                <div id="driver-editor" class="section">
                    <div class="panel"><div class="panel-header"><div class="panel-title"><i class="fas fa-user-pen"></i> INDIVIDUAL ADJUSTMENT</div></div><div class="panel-body"><div id="editorSelectionGrid" class="data-grid"></div><div id="editor-area" style="display:none;"><div style="display:flex; align-items:center; gap: 20px; margin-bottom: 30px;"><button class="btn" onclick="window.closeDriverEditor()"><i class="fas fa-arrow-left"></i> BACK</button><div class="input-group" style="margin:0; flex:1; display:flex; gap:10px;"><input type="text" id="editorDriverNameInput" class="form-control" style="font-size:1.5rem; font-weight:800; color:var(--text-primary); height:auto; padding:5px 10px;"><button class="btn btn-primary" onclick="window.updateDriverName()">RENAME</button></div></div><div style="max-width: 400px; margin-bottom: 30px;"><label class="input-label">MAIN TEAM CONTRACT</label><select id="editorMainTeam" class="form-control" onchange="window.updateMainTeam()"></select><input type="hidden" id="editorDriverIdHidden"></div><div id="trackGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;"></div><div style="margin-top: 32px; padding: 24px; background: #f8fafc; border: 1px solid var(--border-dim); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;"><div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">TOTAL: <span id="calculatedTotal" style="color: var(--accent-cyan);">0</span> PTS</div><button class="btn btn-primary" onclick="window.saveAllChanges()">SAVE CHANGES</button></div></div></div></div>
                </div>

                <div id="race-director" class="section">
                    <div class="panel"><div class="panel-header"><div class="panel-title"><i class="fas fa-flag-checkered"></i> RACE EDITOR</div></div><div class="panel-body"><div style="max-width: 400px; margin-bottom: 30px;"><label class="input-label">SELECT EVENT TO GRADE</label><select id="raceDirectorTrackSelect" class="form-control" onchange="window.loadRaceGrid()"><option>Loading...</option></select></div><div id="raceDirectorGrid" style="display:none;"><div class="data-grid" id="raceInputsContainer"></div><div style="margin-top: 30px; border-top: 1px solid var(--border-dim); padding-top: 24px; text-align: right;"><button class="btn btn-success" onclick="window.saveRaceResults()"><i class="fas fa-save"></i> COMMIT RESULTS</button></div></div></div></div>
                </div>

                <div id="live-view" class="section">
                    <div class="dashboard-grid-full" style="grid-template-columns: 1fr 1fr;"><div class="panel"><div class="panel-header"><div class="panel-title" style="color: var(--accent-cyan);"><i class="fas fa-trophy"></i> DRIVERS CHAMPIONSHIP</div></div><div class="panel-body"><table class="tech-table"><thead><tr><th>POS</th><th>DRIVER</th><th style="text-align:right;">PTS</th></tr></thead><tbody id="liveDriversBody"></tbody></table></div></div><div class="panel"><div class="panel-header"><div class="panel-title" style="color: var(--accent-red);"><i class="fas fa-wrench"></i> CONSTRUCTORS CHAMPIONSHIP</div></div><div class="panel-body"><table class="tech-table"><thead><tr><th>POS</th><th>TEAM</th><th style="text-align:right;">PTS</th></tr></thead><tbody id="liveConstructorsBody"></tbody></table></div></div></div>
                </div>

                <div id="driver-stats" class="section">
                    <div class="panel"><div class="panel-header"><div class="panel-title"><i class="fas fa-chart-line"></i> PERFORMANCE ANALYTICS</div></div><div class="panel-body"><div style="max-width: 400px; margin-bottom: 30px;"><select id="statsDriverSelect" class="form-control" onchange="window.viewDriverStats()"></select></div><div id="statsDisplay" style="display:none;"><div style="display:flex; justify-content:space-between; align-items: flex-end; margin-bottom: 32px;"><div><h1 id="statsDriverName" style="font-family: var(--font-display); font-size: 2.5rem; margin:0; font-weight:800; color:var(--text-primary);">NAME</h1><div id="statsTeamName" style="color: var(--accent-cyan); font-family: var(--font-data); font-weight:600;">TEAM</div></div><div class="stat-value" id="statPoints" style="color: var(--accent-yellow);">0 <span style="font-size: 1.2rem; color: var(--text-secondary);">PTS</span></div></div><div class="dashboard-grid-full" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 32px;"><div class="stat-card" style="padding: 16px;"><div class="stat-label">WINS</div><div class="stat-value" id="statWins">0</div></div><div class="stat-card" style="padding: 16px;"><div class="stat-label">PODIUMS</div><div class="stat-value" id="statPodiums">0</div></div><div class="stat-card" style="padding: 16px;"><div class="stat-label">AVG FINISH</div><div class="stat-value" id="statAvg">0</div></div><div class="stat-card" style="padding: 16px;"><div class="stat-label">CONSISTENCY</div><div class="stat-value" id="statConsistency">0</div></div></div><div class="dashboard-grid-full" style="grid-template-columns: 1fr 1fr; margin-bottom: 32px;"><div class="panel" style="margin:0; min-height: 350px;"><div class="panel-header"><div class="panel-title" style="font-size: 0.95rem;">CUMULATIVE POINTS</div></div><div class="panel-body"><div style="position: relative; height: 300px; width: 100%;"><canvas id="pointsChart"></canvas></div></div></div><div class="panel" style="margin:0; min-height: 350px;"><div class="panel-header"><div class="panel-title" style="font-size: 0.95rem;">RACE RESULTS</div></div><div class="panel-body"><div style="position: relative; height: 300px; width: 100%;"><canvas id="barChart"></canvas></div></div></div></div><div class="panel-title" style="margin-bottom:15px;">SEASON HISTORY</div><table class="tech-table"><thead><tr><th>TRACK</th><th>POS</th><th>TEAM</th><th style="text-align:right;">PTS</th></tr></thead><tbody id="statsHistoryBody"></tbody></table></div></div></div>
                </div>

                <div id="import-preview" class="section">
                    <div class="panel"><div class="panel-header"><div class="panel-title" style="color: var(--accent-green);">IMPORT PREVIEW</div></div><div class="panel-body"><div style="margin-bottom: 24px; font-family: var(--font-data);">DETECTED TRACKS: <span id="detectedTracksList" style="color: var(--accent-green); font-weight:700;"></span></div><div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-dim); margin-bottom: 24px;"><table class="tech-table"><thead><tr><th>DRIVER</th><th>TEAM</th><th>PTS</th><th>STATUS</th></tr></thead><tbody id="importTableBody"></tbody></table></div><div class="action-cluster" style="justify-content: flex-end;"><button class="btn" onclick="window.cancelImport()">CANCEL</button><button class="btn btn-success" onclick="window.commitImport()">CONFIRM IMPORT</button></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="confirmModal" class="modal-overlay"><div class="modal-box"><div class="modal-title" style="color: var(--accent-red);">CONFIRM ACTION</div><p id="modalMessage" style="color: var(--text-secondary); margin-bottom: 28px;">Are you sure?</p><div style="display: flex; gap: 16px; justify-content: center;"><button id="btnConfirmYes" class="btn btn-danger">PROCEED</button><button onclick="window.closeModal()" class="btn">CANCEL</button></div></div></div>
    <div id="migrationModal" class="modal-overlay"><div class="modal-box" style="border-top: 4px solid var(--accent-cyan);"><div class="modal-title" style="color: var(--accent-cyan);">DATA MIGRATION</div><p style="color: var(--text-secondary); margin-bottom: 24px;">Transfer data between seasons.</p><div style="text-align: left; margin-bottom: 16px;"><label class="input-label">SOURCE (COPY FROM)</label><input type="text" id="migrateSource" class="form-control" placeholder="e.g. season_1"></div><div style="text-align: left; margin-bottom: 24px;"><label class="input-label">TARGET (PASTE TO)</label><input type="text" id="migrateTarget" class="form-control" placeholder="e.g. season_2"></div><div style="text-align: left; margin-bottom: 28px; display: flex; align-items: center; gap: 12px;"><input type="checkbox" id="migrateDelete"><label for="migrateDelete" style="font-size: 0.85rem; color: var(--text-primary); font-weight:600;">DELETE SOURCE AFTER COPY</label></div><div style="display: flex; gap: 16px; justify-content: center;"><button onclick="window.performMigration()" class="btn btn-primary">TRANSFER</button><button onclick="document.getElementById('migrationModal').style.display='none'" class="btn">CANCEL</button></div><div id="migrationStatus" style="margin-top: 16px; color: var(--accent-cyan); font-family: var(--font-data); font-size: 0.85rem; font-weight:700;"></div></div></div>
    <div id="toast" class="toast">Notification</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDoc, setDoc, getDocs, query, orderBy, onSnapshot, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // GLOBAL BINDINGS
        window.checkLogin = () => {
            const email = document.getElementById("loginEmail").value;
            const pass = document.getElementById("loginPass").value;
            signInWithEmailAndPassword(auth, email, pass).catch(e => document.getElementById("login-msg").innerText = "ACCESS DENIED: " + e.message);
        };
        window.loginWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => console.error(e));
        window.logout = () => signOut(auth).then(() => window.location.reload());
        
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyApUD33ao9DfFa8IAfA2qby3IFKhLtcNFU",
            authDomain: "ttrl-9f3ef.firebaseapp.com",
            projectId: "ttrl-9f3ef",
            storageBucket: "ttrl-9f3ef.firebasestorage.app",
            messagingSenderId: "51144639440",
            appId: "1:51144639440:web:8a027b773bc2cddefe2fd5"
        };
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // VISUAL SIGNAL THAT SCRIPT LOADED
            const scriptStatus = document.getElementById('script-status');
            if(scriptStatus) scriptStatus.style.display = 'block';
        } catch (e) {
            console.error("Firebase Init Failed", e);
            document.getElementById('login-msg').innerText = "SYSTEM ERROR: SCRIPT INIT FAILED";
        }

        // --- CONSTANTS ---
        const TEAM_COLORS = {
            "red-bull-racing": "#3671C6", "ferrari": "#E80020", "mercedes": "#27F4D2", "mclaren": "#FF8000",
            "aston-martin": "#229971", "alpine": "#0093CC", "williams": "#64C4FF", "racing-bulls": "#1634CB",
            "kick-sauber": "#52E252", "haas": "#5B5B5B", "reserve": "#666666"
        };
        const TEAMS = [
            {id:'red-bull-racing', name:'Red Bull Racing'}, {id:'ferrari', name:'Ferrari'}, {id:'mercedes', name:'Mercedes-AMG'},
            {id:'mclaren', name:'McLaren'}, {id:'aston-martin', name:'Aston Martin'}, {id:'alpine', name:'Alpine'},
            {id:'williams', name:'Williams'}, {id:'racing-bulls', name:'Visa Cash App RB'}, {id:'kick-sauber', name:'Kick Sauber'},
            {id:'haas', name:'Haas F1 Team'}, {id:'reserve', name:'Reserve Driver'}
        ];

        const MASTER_TRACK_LIST = [
            { id: "bahrain", name: "Bahrain GP" }, { id: "saudi_arabia", name: "Saudi Arabian GP" }, { id: "australia", name: "Australian GP" },
            { id: "japan", name: "Japanese GP" }, { id: "china", name: "Chinese GP" }, { id: "miami", name: "Miami GP" },
            { id: "emilia_romagna", name: "Emilia Romagna GP" }, { id: "monaco", name: "Monaco GP" }, { id: "canada", name: "Canadian GP" },
            { id: "spain", name: "Spanish GP" }, { id: "austria", name: "Austrian GP" }, { id: "uk", name: "British GP" },
            { id: "hungary", name: "Hungarian GP" }, { id: "belgium", name: "Belgian GP" }, { id: "netherlands", name: "Dutch GP" },
            { id: "italy", name: "Italian GP" }, { id: "azerbaijan", name: "Azerbaijan GP" }, { id: "singapore", name: "Singapore GP" },
            { id: "usa", name: "United States GP" }, { id: "mexico", name: "Mexico City GP" }, { id: "brazil", name: "SÃ£o Paulo GP" },
            { id: "las_vegas", name: "Las Vegas GP" }, { id: "qatar", name: "Qatar GP" }, { id: "abu_dhabi", name: "Abu Dhabi GP" }
        ];

        // --- APP STATE ---
        let currentSeason = "season_1"; 
        let unsubscribe = null; 
        let knownSeasons = [];
        let activeTracks = []; 
        try { knownSeasons = JSON.parse(localStorage.getItem('ttrl_seasons')) || ['season_1']; } catch(e) { knownSeasons = ['season_1']; }
        let driversCache = {};
        let allDrivers = [];
        let pendingImportData = [];
        let pendingImportTracks = new Set();
        let statsChart = null;
        let barChart = null;

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const adminDocRef = doc(db, "Admin", user.email);
                    const docSnap = await getDoc(adminDocRef); 
                    if (docSnap.exists()) {
                        document.getElementById("login-screen").style.display = "none";
                        document.getElementById("main-interface").style.display = "flex";
                        setTimeout(() => document.getElementById("main-interface").style.opacity = "1", 50);
                        document.getElementById("userName").innerText = (user.displayName || user.email.split('@')[0]).toUpperCase(); 
                        initApp();
                    } else { throw new Error("Doc ID match failed"); }
                } catch (error) {
                    console.warn("Access verification failed:", error);
                    signOut(auth).then(() => { document.getElementById("login-msg").innerText = "UNAUTHORIZED OPERATOR"; document.getElementById("login-screen").style.display = "flex"; });
                }
            } else { 
                document.getElementById("login-screen").style.display = "flex"; 
                document.getElementById("main-interface").style.display = "none"; 
            }
        });

        // --- INITIALIZATION ---
        function initApp() {
            renderKnownSeasons();
            populateDropdowns();
            changeSeason();
        }

        // --- HELPER FUNCTIONS ---
        // Internal helper, not needed in global scope
        const getTeamColor = (teamId) => {
            if(!teamId) return '#94a3b8';
            if(TEAM_COLORS[teamId]) return TEAM_COLORS[teamId];
            const lower = teamId.toLowerCase();
            if(TEAM_COLORS[lower]) return TEAM_COLORS[lower];
            const teamObj = TEAMS.find(t => t.name.toLowerCase() === lower || t.id === lower);
            if(teamObj && TEAM_COLORS[teamObj.id]) return TEAM_COLORS[teamObj.id];
            return '#94a3b8';
        };

        // Internal helper for charts
        const renderChart = (labels, lineData, barData) => {
            const gridColor = 'rgba(0,0,0,0.05)';
            const textColor = '#64748b';
            const ctx1 = document.getElementById('pointsChart'); if(statsChart) statsChart.destroy(); statsChart = new Chart(ctx1, { type: 'line', data: { labels: labels, datasets: [{ label: 'Points', data: lineData, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', tension: 0.3, fill: true, pointBackgroundColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });
            const ctx2 = document.getElementById('barChart'); if(barChart) barChart.destroy(); barChart = new Chart(ctx2, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Points', data: barData, backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: '#ef4444', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });
        };
        
        // Global Utils
        const showToast = (msg) => {
            const t = document.getElementById('toast');
            // Add checkmark icon if not present in message
            const iconHTML = '<i class="fas fa-check-circle"></i> ';
            t.innerHTML = iconHTML + msg;
            t.classList.add('show');
            setTimeout(() => { t.classList.remove('show'); }, 3000);
        };
        window.showToast = showToast; // Explicitly attach to window

        const customConfirm = (msg, onYes) => {
            const m = document.getElementById('confirmModal');
            document.getElementById('modalMessage').innerText = msg;
            m.style.display = 'flex';
            document.getElementById('btnConfirmYes').onclick = () => { m.style.display = 'none'; onYes(); };
        };
        window.customConfirm = customConfirm; // Explicitly attach to window

        // --- CORE FUNCTIONS (Attached to Window for HTML Access) ---
        window.switchTab = (id) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            const items = document.querySelectorAll('.nav-btn');
            items.forEach(i => { if(i.getAttribute('onclick').includes(id)) i.classList.add('active'); });
        };

        window.toggleSidebar = () => {
             document.getElementById('appSidebar').classList.toggle('collapsed');
        };

        window.closeModal = () => document.getElementById('confirmModal').style.display = 'none';

        function populateDropdowns() {
            const ts = document.getElementById("trackSelector");
            ts.innerHTML = '<option value="">-- CHOOSE CIRCUIT --</option>';
            MASTER_TRACK_LIST.forEach(t => ts.innerHTML += `<option value="${t.id}">${t.name.toUpperCase()}</option>`);
            const teamOptions = TEAMS.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById("newDriverTeam").innerHTML = teamOptions;
            document.getElementById("editorMainTeam").innerHTML = teamOptions;
        }

        window.changeSeason = async () => {
            const inputVal = document.getElementById("seasonInput").value.trim().toLowerCase().replace(/\s+/g, '_');
            if(!inputVal) return;
            currentSeason = inputVal;
            if(!knownSeasons.includes(currentSeason)) {
                knownSeasons.push(currentSeason);
                localStorage.setItem('ttrl_seasons', JSON.stringify(knownSeasons));
                renderKnownSeasons();
            }
            await loadTrackConfig();
            initListener(); 
        };

        function renderKnownSeasons() {
            const c = document.getElementById("knownSeasonsList");
            c.innerHTML = knownSeasons.map(s => `<span style="cursor:pointer; margin-right:10px; opacity:0.6;" onclick="document.getElementById('seasonInput').value='${s}';changeSeason()">${s.toUpperCase()}</span>`).join('| ');
        }

        async function loadTrackConfig() {
            const list = document.getElementById("trackConfigList");
            const docRef = doc(db, "seasons", currentSeason);
            try {
                const snap = await getDoc(docRef);
                activeTracks = (snap.exists() && snap.data().trackConfig) ? snap.data().trackConfig : [];
                activeTracks.sort((a, b) => new Date(a.date || '9999-12-31') - new Date(b.date || '9999-12-31'));
            } catch (e) { activeTracks = []; }

            if(activeTracks.length === 0) list.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;">NO TRACKS CONFIGURED</div>`;
            else {
                list.innerHTML = activeTracks.map(t => `<div style="background:var(--bg-panel); border:1px solid var(--border-dim); padding:16px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; border-radius:8px; box-shadow:var(--shadow-sm);"><div style="display:flex; align-items:center; gap:15px;"><input type="checkbox" class="track-checkbox" value="${t.id}" style="transform:scale(1.2);"><span style="font-weight:700; color:var(--text-primary); font-size:0.95rem;">${t.name}</span></div><div style="display:flex; gap:10px; align-items:center;"><input type="date" value="${t.date || ''}" onchange="updateTrackDate('${t.id}', this.value)" style="background:#fff; border:1px solid var(--border-dim); color:var(--text-primary); padding:6px; border-radius:4px;"><button class="icon-btn delete" onclick="window.removeTrackConfig('${t.id}')"><i class="fas fa-times"></i></button></div></div>`).join('');
            }
            
            const rs = document.getElementById("raceDirectorTrackSelect");
            if (rs) {
                rs.innerHTML = '<option value="">-- SELECT EVENT --</option>';
                activeTracks.forEach(t => rs.innerHTML += `<option value="${t.id}">${t.name.toUpperCase()}</option>`);
            }
            updateDashboard();
        }

        function updateDashboard() {
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            safeSet('dashDriverCount', allDrivers.length);
            safeSet('dashTrackCount', activeTracks.length);
            
            let mostWins = { name: "--", count: 0 }, totalEntries = 0, totalPointsScored = 0;

            if(allDrivers.length > 0) {
                const leader = allDrivers.reduce((prev, current) => (prev.totalPoints > current.totalPoints) ? prev : current);
                safeSet('dashLeader', leader.name.toUpperCase());
                safeSet('dashLeaderPts', `${leader.totalPoints} PTS`);
                allDrivers.forEach(d => {
                     const results = d.results || {};
                     let dWins = 0;
                     Object.values(results).forEach(r => {
                         const p = (typeof r === 'object') ? r.points : r;
                         if(p > 0) { totalEntries++; totalPointsScored += p; }
                         if(p >= 25) dWins++; 
                     });
                     if(dWins > mostWins.count) mostWins = { name: d.name, count: dWins };
                });
            } else { safeSet('dashLeader', "--"); safeSet('dashLeaderPts', "0 PTS"); }

            const teamPoints = {};
            allDrivers.forEach(d => {
                const results = d.results || {};
                Object.values(results).forEach(r => {
                    const p = (typeof r === 'object') ? r.points : r;
                    const t = (typeof r === 'object') ? r.team : d.team;
                    if(t !== 'reserve') { teamPoints[t] = (teamPoints[t]||0) + p; }
                });
            });
            let topTeam = { id: '--', pts: 0 };
            Object.keys(teamPoints).forEach(tid => { if(teamPoints[tid] > topTeam.pts) topTeam = { id: tid, pts: teamPoints[tid] }; });
            const teamName = TEAMS.find(t => t.id === topTeam.id)?.name || topTeam.id;
            safeSet('dashTeamLeader', teamName.toUpperCase());
            safeSet('dashTeamPts', `${topTeam.pts} PTS`);

            // Calendar Logic
            const now = new Date();
            let nextRace = null;
            let racesDone = 0;
            const calList = document.getElementById('dashCalendarList');
            if (calList) {
                calList.innerHTML = "";
                activeTracks.forEach((t, i) => {
                    let statusColor = "var(--text-secondary)", statusIcon = "";
                    if(t.date) {
                        const d = new Date(t.date);
                        if(d < now) { racesDone++; statusColor = "var(--accent-green)"; statusIcon = `<i class="fas fa-check"></i>`; } 
                        else if (!nextRace) { nextRace = t; statusColor = "var(--accent-cyan)"; statusIcon = `<i class="fas fa-flag"></i>`; }
                    }
                    calList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border-dim); color:var(--text-secondary);">
                        <span style="font-weight:600; color:${statusColor}">${String(i+1).padStart(2,'0')} ${t.name}</span>
                        <span style="font-size:0.85rem; font-family:var(--font-data);">${t.date || 'TBD'} ${statusIcon}</span>
                    </div>`;
                });
            } else {
                activeTracks.forEach((t) => { if(t.date && new Date(t.date) < now) racesDone++; else if(t.date && !nextRace) nextRace = t; });
            }
            
            const totalRaces = activeTracks.length || 1;
            const pct = Math.round((racesDone / totalRaces) * 100);
            safeSet('dashProgressPct', `${pct}%`);
            safeSet('dashRacesDone', `${racesDone} / ${totalRaces} RACES`);
            const bar = document.getElementById('dashProgressBar');
            if(bar) bar.style.width = `${pct}%`;

            if(nextRace) {
                const parts = nextRace.id.split('_');
                const name = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                safeSet('dashNextRace', name + ' GP');
            } else { safeSet('dashNextRace', "SEASON END"); }

            let lastWinnerName = "--", lastWinnerGP = "NO RACES";
            if (racesDone > 0) {
                const pastRaces = activeTracks.filter(t => t.date && new Date(t.date) < now);
                pastRaces.sort((a,b) => new Date(b.date) - new Date(a.date));
                const lastRace = pastRaces[0];
                if (lastRace) {
                    lastWinnerGP = lastRace.name.toUpperCase();
                    let maxPts = -1, winner = null;
                    allDrivers.forEach(d => {
                        const r = d.results ? d.results[lastRace.id] : null;
                        if (r) {
                            const p = (typeof r === 'object') ? r.points : r;
                            if (p > maxPts) { maxPts = p; winner = d.name; }
                        }
                    });
                    if (winner) lastWinnerName = winner;
                }
            }
            safeSet('dashLastWinner', lastWinnerName.toUpperCase());
            safeSet('dashLastGP', lastWinnerGP);
        }

        // --- DASHBOARD ACTIONS ---
        window.addTrackConfig = async () => {
            const id = document.getElementById("trackSelector").value;
            const date = document.getElementById("newTrackDate").value;
            if(!id || !date) { showToast("Select Track & Date"); return; }
            if(activeTracks.some(t => t.id === id)) { showToast("Track already exists"); return; }
            const obj = MASTER_TRACK_LIST.find(t => t.id === id);
            const newTrack = { id, name: obj.name, date };
            const ref = doc(db, "seasons", currentSeason);
            const snap = await getDoc(ref);
            if(!snap.exists()) await setDoc(ref, { trackConfig: [newTrack] });
            else await updateDoc(ref, { trackConfig: arrayUnion(newTrack) });
            loadTrackConfig(); showToast("Track Added");
        };

        window.updateTrackDate = async (trackId, newDate) => {
            const ref = doc(db, "seasons", currentSeason);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                let tracks = snap.data().trackConfig || [];
                const idx = tracks.findIndex(t => t.id === trackId);
                if(idx !== -1) { tracks[idx].date = newDate; await updateDoc(ref, { trackConfig: tracks }); showToast("Date Updated"); updateDashboard(); }
            }
        };

        window.removeTrackConfig = (id) => {
            customConfirm("Remove this track?", async () => {
                const ref = doc(db, "seasons", currentSeason);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const tracks = snap.data().trackConfig.filter(t => t.id !== id);
                    await updateDoc(ref, { trackConfig: tracks });
                    loadTrackConfig(); showToast("Track Removed");
                }
            });
        };

        window.toggleTrackSelectAll = () => {
            const cbs = document.querySelectorAll('.track-checkbox');
            const all = Array.from(cbs).every(c => c.checked);
            cbs.forEach(c => c.checked = !all);
        };

        window.deleteSelectedTracks = () => {
            const cbs = document.querySelectorAll('.track-checkbox:checked');
            if(cbs.length === 0) return;
            customConfirm(`Delete ${cbs.length} tracks?`, async () => {
                const idsToRemove = Array.from(cbs).map(c => c.value);
                const ref = doc(db, "seasons", currentSeason);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    const currentTracks = snap.data().trackConfig || [];
                    const newTracks = currentTracks.filter(t => !idsToRemove.includes(t.id));
                    await updateDoc(ref, { trackConfig: newTracks });
                    loadTrackConfig(); showToast("Tracks Deleted");
                }
            });
        };

        window.registerDriver = async () => {
            const name = document.getElementById("newDriverName").value;
            const team = document.getElementById("newDriverTeam").value;
            if(!name) return;
            try { await addDoc(collection(db, "seasons", currentSeason, "drivers"), { name, team, totalPoints: 0, results: {} }); document.getElementById("newDriverName").value = ""; showToast("Driver Added"); } catch(e) { console.error(e); }
        };

        window.deleteDriver = (id) => {
            const d = driversCache[id];
            customConfirm(`Delete ${d ? d.name : 'driver'}?`, async () => { await deleteDoc(doc(db, "seasons", currentSeason, "drivers", id)); showToast("Deleted"); });
        };

        window.toggleSelectAll = () => { const cbs = document.querySelectorAll('.driver-checkbox'); const all = Array.from(cbs).every(c => c.checked); cbs.forEach(c => c.checked = !all); };
        window.deleteSelectedDrivers = () => {
            const cbs = document.querySelectorAll('.driver-checkbox:checked');
            if(cbs.length === 0) return;
            customConfirm(`Delete ${cbs.length} drivers?`, async () => {
                const batch = writeBatch(db);
                cbs.forEach(c => batch.delete(doc(db, "seasons", currentSeason, "drivers", c.value)));
                await batch.commit(); showToast("Batch Delete Complete");
            });
        };

        window.exportData = () => {
            const exportObj = { season: currentSeason, tracks: activeTracks, drivers: allDrivers };
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `TTRL_${currentSeason}_backup.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast("Export Started");
        };

        window.openMigrationModal = () => { document.getElementById('migrationModal').style.display = 'flex'; document.getElementById('migrationStatus').innerText = ''; };
        window.performMigration = async () => {
            const source = document.getElementById('migrateSource').value.trim();
            const target = document.getElementById('migrateTarget').value.trim();
            const deleteSource = document.getElementById('migrateDelete').checked;
            const status = document.getElementById('migrationStatus');
            if(!source || !target || source === target) { status.innerText = "Error: Invalid Season IDs"; return; }
            status.innerText = "Migrating...";
            try {
                const sourceRef = doc(db, 'seasons', source);
                const sourceSnap = await getDoc(sourceRef);
                const tracks = sourceSnap.exists() ? (sourceSnap.data().trackConfig || []) : [];
                const driversRef = collection(db, 'seasons', source, 'drivers');
                const driversSnap = await getDocs(driversRef);
                const targetRef = doc(db, 'seasons', target);
                await setDoc(targetRef, { trackConfig: tracks }, { merge: true });
                const batch = writeBatch(db);
                driversSnap.forEach(d => { const newDocRef = doc(db, 'seasons', target, 'drivers', d.id); batch.set(newDocRef, d.data()); });
                await batch.commit();
                if(deleteSource) { const delBatch = writeBatch(db); driversSnap.forEach(d => delBatch.delete(d.ref)); delBatch.delete(sourceRef); await delBatch.commit(); }
                status.innerText = "SUCCESS!";
                setTimeout(() => { document.getElementById('migrationModal').style.display = 'none'; if(document.getElementById('seasonInput').value === target) changeSeason(); }, 1500);
            } catch(e) { status.innerText = "Failed: " + e.message; }
        };

        window.loadDriverData = (id) => {
            if(!id) return;
            document.getElementById("editorSelectionGrid").style.display = "none"; document.getElementById("editor-area").style.display = "block";
            const data = driversCache[id];
            
            // Populate Name Input (Fixed: Removed missing Display element)
            const nameInput = document.getElementById("editorDriverNameInput");
            if(nameInput) nameInput.value = data.name;
            
            document.getElementById("editorMainTeam").value = data.team;
            document.getElementById("editorDriverIdHidden").value = id;
            const grid = document.getElementById("trackGrid"); 
            
            if(activeTracks.length === 0) { grid.innerHTML = "<div style='color:var(--text-muted); padding:10px;'>No Tracks Configured</div>"; return; }
            
            const res = data.results || {};
            // Generate options once
            const teamOpts = `<optgroup label="Teams">` + TEAMS.map(tm => `<option value="${tm.id}">${tm.name}</option>`).join('') + `</optgroup>`;
            
            let rowsHTML = "";
            activeTracks.forEach(t => {
                let pts = 0, pos = "", raceTeam = data.team; 
                if(res[t.id]) { 
                    if(typeof res[t.id] === 'object') { 
                        pts = res[t.id].points || 0; 
                        pos = res[t.id].position || "";
                        if(res[t.id].team) raceTeam = res[t.id].team;
                    } else { pts = res[t.id]; } 
                }

                // Use robust color getter
                const raceTeamColor = getTeamColor(raceTeam);

                rowsHTML += `<div class="race-row" id="row-${t.id}" style="background:var(--bg-panel); border:1px solid var(--border-dim); padding:16px 16px 16px 24px; border-radius:8px; box-shadow:var(--shadow-sm); position:relative; overflow:hidden;">
                    <div class="team-strip" id="strip-${t.id}" style="background:${raceTeamColor};"></div>
                    <label class="input-label" style="margin-bottom:8px;">${t.name}</label>
                    <div style="display:flex; gap:12px;">
                        <input type="text" class="pos-in form-control" style="width:70px; text-align:center; font-weight:700;" placeholder="POS" value="${pos}">
                        <input type="number" class="pts-in form-control" style="width:90px; text-align:center; font-weight:bold; color:var(--accent-cyan);" data-track="${t.id}" value="${pts}" oninput="calcTotal()">
                        <select class="tm-in form-control" id="tm-${t.id}" onchange="updateRowColor('${t.id}', this.value)">${teamOpts}</select>
                    </div>
                </div>`;
            });

            grid.innerHTML = rowsHTML;

            activeTracks.forEach(t => {
                let raceTeam = data.team;
                if(res[t.id] && typeof res[t.id] === 'object' && res[t.id].team) {
                    raceTeam = res[t.id].team;
                }
                const el = document.getElementById(`tm-${t.id}`);
                if(el) el.value = raceTeam;
            });
            
            calcTotal();
        };
        
        // --- ADDED: RENAME FUNCTION (With Ack) ---
        window.updateDriverName = async () => {
            const id = document.getElementById("editorDriverIdHidden").value;
            const newName = document.getElementById("editorDriverNameInput").value.trim();
            if(!id || !newName) return;
            
            try {
                await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { name: newName });
                // Update the input immediately for responsiveness
                document.getElementById("editorDriverNameInput").value = newName; 
                // Show High-Vis Toast
                showToast("DRIVER RENAMED SUCCESSFULLY");
            } catch(e) {
                console.error(e);
                showToast("ERROR: COULD NOT RENAME");
            }
        };

        window.updateRowColor = (trackId, teamId) => {
            const color = getTeamColor(teamId);
            const strip = document.getElementById(`strip-${trackId}`);
            if(strip) strip.style.background = color;
        };

        window.closeDriverEditor = () => { document.getElementById("editor-area").style.display = "none"; document.getElementById("editorSelectionGrid").style.display = "grid"; document.getElementById("editorDriverIdHidden").value = ""; };
        window.updateMainTeam = async () => { const id = document.getElementById("editorDriverIdHidden").value; if(!id) return; const team = document.getElementById("editorMainTeam").value; await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { team }); showToast("Main Contract Updated"); };
        window.calcTotal = () => { let s = 0; document.querySelectorAll(".pts-in").forEach(i => s += Number(i.value)||0); document.getElementById("calculatedTotal").innerText = s; };
        
        window.saveAllChanges = async () => {
            const id = document.getElementById("editorDriverIdHidden").value; if(!id) return;
            const ptsIns = document.querySelectorAll(".pts-in"); 
            const tmIns = document.querySelectorAll(".tm-in");
            const posIns = document.querySelectorAll(".pos-in");
            let newResults = {}, total = 0;
            
            const mainTeam = document.getElementById("editorMainTeam").value;

            ptsIns.forEach((p, idx) => { 
                const val = Number(p.value); 
                const posVal = posIns[idx].value.trim();
                const selectedTeam = tmIns[idx].value;
                
                if(val > 0 || posVal !== "" || selectedTeam !== mainTeam) { 
                    newResults[p.dataset.track] = { points: val, position: posVal, team: selectedTeam }; 
                    total += val; 
                } 
            });
            await updateDoc(doc(db, "seasons", currentSeason, "drivers", id), { results: newResults, totalPoints: total }); 
            showToast("CHANGES SAVED"); // Ack for Driver Editor Save
        };

        window.triggerImport = () => document.getElementById('csvFile').click();
        window.handleFileSelect = (input) => { if(input.files[0]) { const r = new FileReader(); r.onload = (e) => parseCSV(e.target.result); r.readAsText(input.files[0]); } };
        function parseCSV(text) {
            const lines = text.split('\n'); pendingImportData = []; pendingImportTracks.clear();
            const headers = lines[0].split(',').map(s => s.trim().replace(/^"|"$/g,''));
            const colMap = {};
            headers.forEach((h, i) => { const mid = MASTER_TRACK_LIST.find(t => h.toLowerCase().includes(t.id.split('_')[0]))?.id; if(mid) { colMap[i] = mid; pendingImportTracks.add(mid); } });
            lines.slice(1).forEach(line => {
                if(!line.trim()) return; const p = line.split(',').map(s => s.trim().replace(/^"|"$/g,'')); if(p.length < 2) return;
                const name = p[0]; const teamRaw = p[1].toLowerCase().replace(/\s/g,'-');
                const tObj = TEAMS.find(t => t.id === teamRaw || t.name.toLowerCase() === p[1].toLowerCase());
                const teamId = tObj ? tObj.id : 'reserve';
                let res = {}, tot = 0;
                Object.keys(colMap).forEach(idx => { const pts = parseInt(p[idx]); if(!isNaN(pts) && pts > 0) { res[colMap[idx]] = { points: pts, team: teamId }; tot += pts; } });
                pendingImportData.push({ name, team: teamId, results: res, totalPoints: tot });
            });
            switchTab('import-preview'); document.getElementById('import-preview').classList.add('active'); document.getElementById('detectedTracksList').innerText = Array.from(pendingImportTracks).join(', ').toUpperCase() || "NONE";
            const tb = document.getElementById('importTableBody'); tb.innerHTML = "";
            pendingImportData.forEach((d, i) => { const tOpts = TEAMS.map(t => `<option value="${t.id}" ${t.id===d.team?'selected':''}>${t.name}</option>`).join(''); tb.innerHTML += `<tr><td><input value="${d.name}" class="form-control" onchange="pendingImportData[${i}].name=this.value"></td><td><select class="form-control" onchange="pendingImportData[${i}].team=this.value; updateImpTeam(${i}, this.value)">${tOpts}</select></td><td style="color:var(--accent-cyan); font-weight:bold;">${d.totalPoints}</td><td style="color:var(--accent-green)">READY</td></tr>`; });
        }
        window.updateImpTeam = (idx, nt) => { const r = pendingImportData[idx].results; Object.keys(r).forEach(k => r[k].team = nt); };
        window.cancelImport = () => { document.getElementById('csvFile').value = ""; switchTab('manage-drivers'); };
        window.commitImport = async () => {
            const sRef = doc(db, "seasons", currentSeason); const snap = await getDoc(sRef);
            let tracks = (snap.exists() && snap.data().trackConfig) ? snap.data().trackConfig : [];
            const newT = []; pendingImportTracks.forEach(tid => { if(!tracks.some(t => t.id === tid)) { const m = MASTER_TRACK_LIST.find(x => x.id === tid); newT.push({ id: tid, name: m ? m.name : tid.toUpperCase(), date: "" }); } });
            if(newT.length > 0) { if(snap.exists()) await updateDoc(sRef, { trackConfig: arrayUnion(...newT) }); else await setDoc(sRef, { trackConfig: newT }); }
            const batch = writeBatch(db); pendingImportData.forEach(d => { if(d.name) { batch.set(doc(collection(db, "seasons", currentSeason, "drivers")), { name: d.name, team: d.team, totalPoints: d.totalPoints, results: d.results }); } });
            await batch.commit(); loadTrackConfig(); cancelImport(); showToast(`Imported ${pendingImportData.length} Drivers`);
        };

        window.loadRaceGrid = () => {
            const tid = document.getElementById("raceDirectorTrackSelect").value; 
            const con = document.getElementById("raceInputsContainer"); 
            const wrap = document.getElementById("raceDirectorGrid"); 
            if(!tid) { wrap.style.display="none"; return; } 
            wrap.style.display="block"; 
            con.innerHTML = "";
            let gridHTML = "";
            allDrivers.forEach(d => {
                const r = d.results || {}; 
                const pts = (r[tid] && typeof r[tid]==='object') ? r[tid].points : (r[tid] || 0); 
                const pos = (r[tid] && typeof r[tid]==='object') ? r[tid].position : "";
                let team = d.team; if (r[tid] && typeof r[tid] === 'object' && r[tid].team) { team = r[tid].team; }
                const teamColor = getTeamColor(team);
                const teamName = TEAMS.find(t => t.id === team)?.name || team;
                
                // FIXED: Removed the blue tint background for cards with points
                const hasPoints = '';
                
                gridHTML += `
                    <div class="driver-card" style="--team-color:${teamColor}; ${hasPoints}">
                        <div class="driver-info">
                            <span style="display:block; font-weight:700; color:var(--text-primary); font-size:1.05rem;">${d.name}</span>
                            <span style="display:block; font-size:0.75rem; color:${teamColor}; font-weight:700; text-transform:uppercase; margin-top:2px;">${teamName}</span>
                        </div>
                        <div style="display:flex; gap:5px; position:relative; z-index:2;">
                            <input type="text" class="rc-pos-input form-control" style="width:60px; text-align:center; padding:5px; font-size:0.9rem; font-weight:700; text-transform:uppercase;" placeholder="POS" value="${pos || ''}">
                            <input type="number" class="rc-points-input form-control" style="width:70px; text-align:center; padding:5px; font-weight:800; color:var(--accent-cyan);" placeholder="PTS" data-did="${d.id}" value="${pts}">
                        </div>
                    </div>`;
            });
            con.innerHTML = gridHTML;
        };

        window.saveRaceResults = async () => {
            const tid = document.getElementById("raceDirectorTrackSelect").value; if(!tid) return; 
            const ptsInps = document.querySelectorAll(".rc-points-input"); const posInps = document.querySelectorAll(".rc-pos-input");
            const batch = writeBatch(db); let changes = 0;
            ptsInps.forEach((inp, idx) => { 
                const did = inp.dataset.did; const newP = Number(inp.value); const newPos = posInps[idx].value.trim();
                const d = driversCache[did]; const oldRes = d.results || {}; const oldP = (oldRes[tid] && typeof oldRes[tid]==='object') ? oldRes[tid].points : (oldRes[tid]||0); const oldPos = (oldRes[tid] && typeof oldRes[tid]==='object') ? oldRes[tid].position : "";
                if(oldP !== newP || oldPos !== newPos) { 
                    const newTot = d.totalPoints - oldP + newP; const resUpd = { ...oldRes }; let tRace = d.team; if(oldRes[tid] && oldRes[tid].team) tRace = oldRes[tid].team; 
                    if(newP > 0 || newPos !== "") { resUpd[tid] = { points: newP, position: newPos, team: tRace }; } else delete resUpd[tid]; 
                    batch.update(doc(db, "seasons", currentSeason, "drivers", did), { results: resUpd, totalPoints: newTot }); changes++; 
                }
            });
            if(changes > 0) { 
                await batch.commit(); 
                showToast("RACE RESULTS COMMITTED"); // Ack for Race Director
            } else { 
                showToast("NO CHANGES DETECTED"); 
            }
        };

        window.viewDriverStats = () => {
            const id = document.getElementById("statsDriverSelect").value; const disp = document.getElementById("statsDisplay"); if(!id) { disp.style.display="none"; return; } disp.style.display="block";
            const d = driversCache[id]; document.getElementById("statsDriverName").innerText = d.name.toUpperCase(); document.getElementById("statsTeamName").innerText = TEAMS.find(t=>t.id===d.team)?.name.toUpperCase() || d.team; document.getElementById("statPoints").innerHTML = `${d.totalPoints} <span style="font-size:1rem; color:var(--text-secondary);">PTS</span>`;
            let w=0, p=0, r=0, entries=0, best=0, dnf=0, hHTML=""; const labels = [], dataPoints = [], barData = []; let cumulative = 0;
            let totalPos = 0, finishedRaces = 0;
            activeTracks.forEach(t => { 
                const res = d.results ? d.results[t.id] : null; 
                const pt = (res && typeof res === 'object') ? res.points : (res || 0); 
                const pos = (res && typeof res === 'object') ? res.position : "-";
                if(res) { 
                    entries++; 
                    if(pt > 0) { r++; cumulative += pt; if(pt > best) best = pt; if(pt>=25) w++; if(pt>=15) p++; }
                    const numPos = parseInt(pos); if(!isNaN(numPos)) { totalPos += numPos; finishedRaces++; }
                    const tm = (typeof res === 'object') ? res.team : d.team; const tName = TEAMS.find(x=>x.id===tm)?.name || tm; 
                    hHTML += `<tr><td>${t.name.toUpperCase()}</td><td style="color:var(--accent-yellow); font-weight:700;">${pos}</td><td style="color:var(--text-secondary); font-weight:500;">${tName}</td><td style="text-align:right; font-weight:700; color:var(--accent-cyan);">${pt}</td></tr>`; 
                    labels.push(t.id.substring(0,3).toUpperCase()); dataPoints.push(cumulative); barData.push(pt); 
                } 
            });
            let avg = finishedRaces > 0 ? totalPos / finishedRaces : 0; let variance = 0; if(r > 0) { barData.forEach(pt => { if(pt>0) variance += Math.pow(pt - (d.totalPoints/r), 2); }); variance = Math.sqrt(variance / r).toFixed(1); }
            document.getElementById("statWins").innerText = w; document.getElementById("statPodiums").innerText = p; document.getElementById("statAvg").innerText = avg > 0 ? "P" + avg.toFixed(1) : "-"; document.getElementById("statConsistency").innerText = variance; document.getElementById("statsHistoryBody").innerHTML = hHTML || `<tr><td colspan="4" style="text-align:center;">NO DATA</td></tr>`;
            renderChart(labels, dataPoints, barData);
        };

        // --- VISUALIZATION HELPERS ---
        function updateLiveTables() {
            const tD = document.getElementById("liveDriversBody"); 
            if(tD) {
                tD.innerHTML = "";
                const sorted = [...allDrivers].sort((a,b) => { if(a.team==='reserve' && b.team!=='reserve') return 1; if(a.team!=='reserve' && b.team==='reserve') return -1; return b.totalPoints - a.totalPoints; });
                sorted.forEach((d,i) => { tD.innerHTML += `<tr><td style="color:var(--text-secondary); font-weight:600;">${String(i+1).padStart(2,'0')}</td><td><div style="font-weight:700; color:var(--text-primary); font-size:0.95rem;">${d.name}</div><div style="font-size:0.75rem; color:var(--accent-cyan); font-weight:600;">${d.team.toUpperCase()}</div></td><td style="text-align:right; font-weight:800; font-size:1.1rem; color:var(--accent-cyan);">${d.totalPoints}</td></tr>`; });
            }
            
            const tC = document.getElementById("liveConstructorsBody"); 
            if(tC) {
                tC.innerHTML = "";
                const teamPts = {}; allDrivers.forEach(d => { const res = d.results || {}; Object.values(res).forEach(r => { const p = (typeof r === 'object') ? r.points : r; const t = (typeof r === 'object') ? r.team : d.team; if(t !== 'reserve') { teamPts[t] = (teamPts[t]||0) + p; } }); });
                Object.keys(teamPts).map(k => ({id:k, p:teamPts[k]})).sort((a,b) => b.p - a.p).forEach((x,i) => { const tn = TEAMS.find(t=>t.id===x.id)?.name || x.id; tC.innerHTML += `<tr><td style="color:var(--text-secondary); font-weight:600;">${String(i+1).padStart(2,'0')}</td><td style="font-weight:700; color:var(--text-primary); text-transform:uppercase; font-size:0.95rem;">${tn}</td><td style="text-align:right; font-weight:800; color:var(--accent-red); font-size:1.1rem;">${x.p}</td></tr>`; });
            }
        }

        // --- DRIVER DATA ---
        function initListener() {
            if(unsubscribe) unsubscribe();
            const q = query(collection(db, "seasons", currentSeason, "drivers")); 
            unsubscribe = onSnapshot(q, (snap) => {
                const list = document.getElementById("driverList");
                const statSel = document.getElementById("statsDriverSelect");
                const grid = document.getElementById("editorSelectionGrid");
                if(list) list.innerHTML = ""; 
                if(statSel) statSel.innerHTML = '<option value="">-- SELECT DRIVER --</option>'; 
                if(grid) grid.innerHTML = ""; 
                allDrivers = [];
                snap.forEach(d => { const data = d.data(); data.id = d.id; driversCache[d.id] = data; allDrivers.push(data); });
                allDrivers.sort((a, b) => {
                    const idxA = TEAMS.findIndex(t => t.id === a.team);
                    const idxB = TEAMS.findIndex(t => t.id === b.team);
                    if (idxA !== -1 && idxB !== -1 && idxA !== idxB) return idxA - idxB;
                    return a.name.localeCompare(b.name);
                });
                allDrivers.forEach(data => {
                    const teamColor = TEAM_COLORS[data.team] || '#94a3b8';
                    const teamName = TEAMS.find(t => t.id === data.team)?.name || data.team;
                    if(statSel) statSel.innerHTML += `<option value="${data.id}">${data.name.toUpperCase()}</option>`;
                    if(list) list.innerHTML += `<div class="driver-card" style="--team-color:${teamColor}"><div style="display:flex; align-items:center; gap:12px; position:relative; z-index:2;"><input type="checkbox" class="driver-checkbox" value="${data.id}" style="transform:scale(1.2);"><div class="driver-info"><h4>${data.name}</h4><p>${teamName}</p></div></div><button class="icon-btn delete" onclick="window.deleteDriver('${data.id}')"><i class="fas fa-trash"></i></button></div>`;
                    if(grid) grid.innerHTML += `<div class="driver-card" style="--team-color:${teamColor}; cursor:pointer;" onclick="loadDriverData('${data.id}')"><div class="driver-info"><h4>${data.name}</h4><p>${teamName}</p></div><div style="position:relative; z-index:2; font-family:var(--font-display); font-size:1.2rem; color:var(--accent-cyan); font-weight:800;">${data.totalPoints} PTS</div></div>`;
                });
                if(document.getElementById("raceDirectorGrid") && document.getElementById("raceDirectorGrid").style.display === "block") loadRaceGrid();
                const currentEditId = document.getElementById("editorDriverIdHidden") ? document.getElementById("editorDriverIdHidden").value : null;
                if(currentEditId && document.getElementById("editor-area") && document.getElementById("editor-area").style.display === "block" && driversCache[currentEditId]) loadDriverData(currentEditId);
                updateDashboard();
                updateLiveTables();
            });
        }

    </script>
</body>
</html>
